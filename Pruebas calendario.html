<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario 24/7 (5 trabajadores) — Vista tipo cuadrante</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

    :root{
      --ink:#0c0f14;
      --muted:#586173;
      --grid:#d7dbe2;
      --border:#cfd5df;
      --bg:#f3f1ec;
      --surface:rgba(255,255,255,0.88);
      --surface-strong:#ffffff;
      --accent:#0f6bff;

      /* Colores tipo cuadrante */
      --c-m:#ff6a5b;
      --c-t:#3da6ff;
      --c-n:#18b46b;
      --c-o:#e9ecf1;
      --c-v:#ffe8a3;
      --c-h:#f4f6fa;
      --c-weekend:#f5ede2;

      --radius:16px;
      --radius-lg:22px;
      --shadow-1:0 10px 30px rgba(15,23,42,0.08);
      --shadow-2:0 12px 40px rgba(15,23,42,0.12);
      --shadow-inset:inset 0 1px 0 rgba(255,255,255,0.8);
    }

    *{ box-sizing:border-box; }

    body{
      font-family:"Space Grotesk","Helvetica Neue",Arial,sans-serif;
      margin:0;
      background:linear-gradient(180deg, #f6f3ee 0%, #eef2f7 40%, #ffffff 100%);
      color:var(--ink);
      line-height:1.45;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20% -10% auto -10%;
      height:60%;
      background:
        radial-gradient(600px 300px at 10% 20%, rgba(255,106,91,0.18), transparent 60%),
        radial-gradient(540px 260px at 85% 10%, rgba(61,166,255,0.18), transparent 60%),
        radial-gradient(520px 240px at 60% 40%, rgba(24,180,107,0.14), transparent 65%);
      pointer-events:none;
      z-index:-1;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      background-image:linear-gradient(120deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0) 45%);
      opacity:0.35;
      pointer-events:none;
      z-index:-2;
    }

    .page{
      max-width:1400px;
      margin:0 auto;
      padding:28px 24px 40px;
    }

    h1{
      font-family:"Fraunces","Times New Roman",serif;
      font-size:32px;
      margin:6px 0 6px;
      letter-spacing:0.2px;
    }

    .header-config{
      position:fixed;
      top:18px;
      right:22px;
      z-index:500;
    }
    .header-config .open-config-btn{
      border:1px solid rgba(15,23,42,0.12);
      background:rgba(255,255,255,0.7);
      color:#475467;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      box-shadow:var(--shadow-inset);
      backdrop-filter:blur(6px);
      transition:opacity .2s ease, transform .2s ease, background .2s ease;
    }
    .header-config .open-config-btn:hover{
      opacity:1;
      background:#fff;
      transform:translateY(-1px);
    }

    .modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,0.45);
      backdrop-filter:blur(4px);
      z-index:999;
      padding:16px;
    }
    .modal.hidden{ display:none; }
    .modal-card{
      width:min(980px, 92vw);
      max-height:90vh;
      overflow:auto;
      background:#fff;
      border-radius:20px;
      border:1px solid #e3e8f1;
      box-shadow:var(--shadow-2);
      padding:16px;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .modal-title{
      font-size:14px;
      font-weight:700;
      color:#1f2937;
    }
    .modal-close{
      border:1px solid #d7dde7;
      background:#fff;
      color:#1f2937;
      font-size:12px;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      box-shadow:var(--shadow-inset);
    }
    .modal-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .modal-grid{ grid-template-columns:1fr; }
    }
    .panel{
      border:1px solid #e6ebf2;
      border-radius:16px;
      padding:12px;
      background:#fbfcfe;
    }
    .panel-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1.2px;
      color:var(--muted);
      font-weight:700;
      margin-bottom:8px;
    }
    .modal-open{ overflow:hidden; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 0.6fr 0.8fr 1.4fr;
      gap:12px;
      align-items:end;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:16px;
      box-shadow:var(--shadow-1);
      backdrop-filter:blur(6px);
      margin-bottom:16px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:0.2px;
      font-weight:600;
    }
    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr; }
    }
    @media (max-width: 640px){
      h1{ font-size:26px; }
      .page{ padding:20px 16px 28px; }
    }
    select, input, button{
      width:100%;
      padding:10px 12px;
      border:1px solid #cfd5df;
      border-radius:12px;
      font-size:14px;
      background:#fff;
      font-family:inherit;
      transition:border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    select, input{
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);
    }
    select:focus-visible, input:focus-visible, button:focus-visible{
      outline:2px solid rgba(15,107,255,0.25);
      outline-offset:2px;
      border-color:rgba(15,107,255,0.6);
    }
    button{
      background:linear-gradient(140deg, #111827 0%, #0f172a 100%);
      color:#fff;
      border-color:#0f172a;
      cursor:pointer;
      font-weight:600;
      letter-spacing:0.2px;
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,0.2);
    }
    button.secondary{
      background:#fff;
      color:#101828;
      border-color:#cfd5df;
    }
    button.secondary:hover{
      box-shadow:0 6px 14px rgba(15,23,42,0.12);
    }

    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .row > *{ flex:1 1 140px; }
    .row.actions{ margin-top:8px; }
    .hidden-file{ display:none; }

    .vac-controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow-1);
      backdrop-filter:blur(6px);
      margin-bottom:12px;
    }
    .vac-controls .vac-worker{
      min-width:200px;
      flex:0 0 auto;
    }
    .vac-controls .vac-worker label{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
    }
    .vac-controls .vac-hint{
      font-size:11px;
      color:var(--muted);
      flex:1 1 220px;
    }
    .vac-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .vac-actions button{
      padding:8px 12px;
      font-size:12px;
    }
    .vac-status{
      font-size:11px;
      color:#b45309;
      font-weight:600;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0 16px;
      font-size:12px;
      color:var(--muted);
      align-items:center;
    }
    .swatch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border:1px solid #e2e6ee;
      border-radius:999px;
      background:var(--surface-strong);
      box-shadow:var(--shadow-inset);
    }
    .box{
      width:12px;
      height:12px;
      border:1px solid #0f172a;
      border-radius:3px;
    }
    .box.m{ background:var(--c-m); }
    .box.t{ background:var(--c-t); }
    .box.n{ background:var(--c-n); }
    .box.o{ background:var(--c-o); }
    .box.v{ background:var(--c-v); }
    .box.h{ background:linear-gradient(180deg, rgba(255,106,91,0.85), rgba(24,180,107,0.75)); }

    .month-wrap{
      border:1px solid #e1e5ee;
      border-radius:18px;
      overflow:hidden;
      margin-bottom:16px;
      background:var(--surface-strong);
      box-shadow:var(--shadow-1);
      animation:rise .6s ease both;
      animation-delay:calc(var(--i, 0) * 35ms);
    }
    .month-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      padding:12px 14px;
      background:linear-gradient(90deg, #f8f9fb 0%, #eef2f6 100%);
      border-bottom:1px solid #e1e5ee;
    }
    .month-title{ font-weight:700; font-size:16px; }
    .month-meta{ font-size:11px; color:var(--muted); }

    .layout{
      display:grid;
      grid-template-columns:minmax(0, 1fr) 280px;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .layout{ grid-template-columns:1fr; }
      .layout.sidebar-collapsed{ grid-template-columns:1fr; }
      .annual-summary{ position:static; }
    }

    .annual-summary{
      position:sticky;
      top:18px;
      align-self:start;
    }
    .annual-summary .kpi-panel + .kpi-panel{
      margin-top:12px;
    }

    .kpi-panel{
      background:#fbfcfe;
      padding:10px 12px 12px;
    }
    .kpi-panel.kpi-annual{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow-1);
      backdrop-filter:blur(6px);
      border-top:none;
      padding:12px 14px;
    }
    .kpi-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1.2px;
      color:var(--muted);
      font-weight:700;
      margin-bottom:8px;
    }
    .kpi-list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi-row{
      display:grid;
      grid-template-columns:1fr repeat(5, minmax(46px, auto));
      gap:6px;
      align-items:center;
    }
    .kpi-name{
      font-size:12px;
      font-weight:600;
      color:#303644;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .kpi-chip{
      min-width:46px;
      padding:6px 6px;
      border-radius:10px;
      background:#fff;
      border:1px solid #e5eaf3;
      box-shadow:var(--shadow-inset);
      text-align:center;
    }
    .kpi-label{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:1px;
      color:var(--muted);
      display:block;
      line-height:1;
    }
    .kpi-value{
      font-size:13px;
      font-weight:700;
      display:block;
      margin-top:2px;
    }
    .kpi-legend{
      margin-top:8px;
      font-size:10px;
      color:var(--muted);
      letter-spacing:0.2px;
    }

    .name-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      width:100%;
      min-width:0;
    }
    .name-kpis{
      display:flex;
      align-items:center;
      gap:6px;
      padding:2px 6px;
      background:#eef2f7;
      border:1px solid #dbe2ee;
      border-radius:10px;
      white-space:nowrap;
      line-height:1;
      font-variant-numeric:tabular-nums;
    }
    .name-kpis .mini{
      display:flex;
      align-items:baseline;
      gap:2px;
    }
    .name-kpis .mini-label{
      font-size:8px;
      font-weight:700;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .name-kpis .mini-label::after{
      content:":";
    }
    .name-kpis .mini-val{
      font-size:10px;
      font-weight:800;
      color:#1f2937;
    }
    .name-person{
      font-size:12px;
      font-weight:700;
      color:#0f172a;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1 1 auto;
    }


    .config-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .config-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .config-field label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.8px;
      color:var(--muted);
      font-weight:700;
    }
    .config-field input,
    .config-field textarea{
      font-size:12px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid #d7dde7;
      background:#fff;
      font-family:inherit;
    }
    .config-field textarea{
      min-height:70px;
      resize:vertical;
    }
    .config-span-2{
      grid-column:1 / -1;
    }
    .config-foot{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#3a4250;
      font-weight:600;
    }
    .config-foot strong{
      font-size:13px;
      font-weight:800;
      color:#0f172a;
    }
    .config-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#3a4250;
    }

    /* Vista tipo cuadrante: tabla ancha con scroll horizontal */
    .scroller{
      overflow:visible;
      background:#fff;
      position:relative;
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      table-layout:fixed;
      border-left:1px solid var(--grid);
      border-top:1px solid var(--grid);
      font-variant-numeric:tabular-nums;
    }

    th, td{
      border-right:1px solid var(--grid);
      border-bottom:1px solid var(--grid);
      text-align:center;
      vertical-align:middle;
      padding:0 2px;
      height:32px;
      min-width:0;
      font-size:clamp(9px, 1.1vw, 11px);
      line-height:1.1;
      user-select:none;
    }

    /* Columna izquierda (nombres) fija */
    th.sticky, td.sticky{
      position:sticky;
      left:0;
      z-index:3;
      background:#fbfcfe;
      min-width:140px;
      width:140px;
      font-weight:700;
      box-shadow:2px 0 0 rgba(15,23,42,0.06);
      padding:0 8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    th.sticky{ background:var(--c-h); z-index:4; }

    /* Cabeceras superiores fijas */
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--c-h);
      font-weight:700;
    }
    thead th.sticky{ z-index:5; }

    .dow{
      font-size:10px;
      color:#4b5563;
      font-weight:600;
      padding-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dom{
      font-size:11px;
      font-weight:800;
      padding-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Celdas turno */
    .cell{
      font-weight:700;
      color:#0b0d12;
      letter-spacing:0.2px;
      text-transform:uppercase;
    }
    .M{
      background:linear-gradient(180deg, rgba(255,106,91,0.9), rgba(255,106,91,0.75));
      color:#141414;
    }
    .T{
      background:linear-gradient(180deg, rgba(61,166,255,0.9), rgba(61,166,255,0.75));
      color:#091b2a;
    }
    .N{
      background:linear-gradient(180deg, rgba(24,180,107,0.9), rgba(24,180,107,0.72));
      color:#07160f;
    }
    .D12{
      background:linear-gradient(180deg, rgba(255,106,91,0.88), rgba(247,200,90,0.82));
      color:#0b0d12;
    }
    .N12{
      background:linear-gradient(180deg, rgba(24,180,107,0.88), rgba(15,23,42,0.85));
      color:#f8fafc;
    }
    .O{
      background:var(--c-o);
      color:#2b313b;
      font-weight:600;
    }
    .V{
      background:repeating-linear-gradient(135deg, #fff7d4, #fff7d4 6px, #ffe9ad 6px, #ffe9ad 12px);
      color:#5a4200;
      font-weight:700;
    }
    .cell.cover{
      position:relative;
    }
    .cell.cover::after{
      content:"";
      position:absolute;
      top:4px;
      right:4px;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#111827;
      box-shadow:0 0 0 2px rgba(255,255,255,0.8);
    }

    /* Fines de semana con una leve marca (sin tapar color de turno) */
    .wknd{
      box-shadow:inset 0 0 0 9999px rgba(245,237,226,0.3);
    }

    tbody tr:hover td{
      background-image:linear-gradient(0deg, rgba(15,23,42,0.05), rgba(15,23,42,0.05));
    }

    #calendar.vac-active td.cell{
      cursor:pointer;
    }
    #calendar.vac-active td.cell:hover{
      outline:2px solid rgba(15,107,255,0.35);
      outline-offset:-2px;
    }

    .cell span{
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .warning-box{
      margin:10px 0 14px;
      color:#7a1f1f;
      font-size:12px;
      background:rgba(255, 231, 231, 0.65);
      border:1px solid rgba(185,28,28,0.25);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.4;
    }

    @keyframes rise{
      from{ opacity:0; transform:translateY(10px); }
      to{ opacity:1; transform:translateY(0); }
    }

    @media (prefers-reduced-motion: reduce){
      .month-wrap{ animation:none; }
      button{ transition:none; }
    }

    @media print{
      body{ background:#fff; }
      body::before, body::after{ display:none; }
      .controls, .vac-controls, .legend{ display:none; }
      .page{ padding:0; }
      .month-wrap{ break-inside:avoid; box-shadow:none; border-color:#ccc; }
      .scroller{ overflow:visible; }
      table{ min-width:unset; width:100%; }
      th, td{ min-width:unset; height:28px; font-size:10px; }
      .annual-summary{ position:static; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Cuadrante visual de turnos</h1>

    <div class="header-config">
      <button id="open-config" class="open-config-btn" type="button">Configurar</button>
    </div>

    <div id="config-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="config-title">
        <div class="modal-head">
          <div id="config-title" class="modal-title">Configuración de trabajadores y sueldos</div>
          <button id="close-config" class="modal-close" type="button">Cerrar</button>
        </div>
        <div class="modal-grid">
          <div class="panel">
            <div class="panel-title">Trabajadores</div>
            <div class="row">
              <input id="w1" value="Raul" />
              <input id="w2" value="Jose" />
              <input id="w3" value="David" />
              <input id="w4" value="Ivan" />
              <input id="w5" value="Andres" />
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">Sueldos y extras</div>
            <div class="config-grid">
              <div class="config-field">
                <label for="base-monthly">Base mensual</label>
                <input id="base-monthly" type="number" step="0.01" value="926.96" />
              </div>
              <div class="config-field">
                <label for="extra-prorrateo">Prorrateo extra</label>
                <input id="extra-prorrateo" type="number" step="0.01" value="154.49" />
              </div>
              <div class="config-field">
                <label for="comp-1">Complemento 1</label>
                <input id="comp-1" type="number" step="0.01" value="91.96" />
              </div>
              <div class="config-field">
                <label for="comp-2">Complemento 2</label>
                <input id="comp-2" type="number" step="0.01" value="207.79" />
              </div>
              <div class="config-field">
                <label for="turnicidad">Turnicidad</label>
                <input id="turnicidad" type="number" step="0.01" value="110" />
              </div>
              <div class="config-field">
                <label for="hours-per-shift">Horas por turno</label>
                <input id="hours-per-shift" type="number" step="0.25" value="8" />
              </div>
              <div class="config-field">
                <label for="hourly-rate">Precio hora</label>
                <input id="hourly-rate" type="number" step="0.01" value="9.25" />
              </div>
              <div class="config-field">
                <label for="night-mult">Plus noche (x)</label>
                <input id="night-mult" type="number" step="0.01" value="0.6" />
              </div>
              <div class="config-field">
                <label for="weekend-mult">Plus finde (x)</label>
                <input id="weekend-mult" type="number" step="0.01" value="1" />
              </div>
              <div class="config-field">
                <label for="holiday-mult">Plus festivo (x)</label>
                <input id="holiday-mult" type="number" step="0.01" value="2" />
              </div>
              <div class="config-field config-span-2">
                <label for="holiday-list">Festivos (YYYY-MM-DD, uno por línea)</label>
                <textarea id="holiday-list" placeholder="2026-01-01&#10;2026-01-06"></textarea>
              </div>
              <div class="config-field config-span-2">
                <label class="config-toggle">
                  <input id="stack-holiday-weekend" type="checkbox" />
                  Acumular festivo con fin de semana
                </label>
              </div>
              <div class="config-field config-span-2">
                <label class="config-toggle">
                  <input id="show-monthly-pay" type="checkbox" />
                  Mostrar sueldo mensual en el cuadrante
                </label>
              </div>
            </div>
            <div class="config-foot">
              <span>Fijo mensual</span>
              <strong id="fixed-total">€0,00</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="field">
        <label for="pattern">Opción de ciclo</label>
        <select id="pattern">
          <option value="">Cargando opciones…</option>
        </select>
      </div>

      <div class="field">
        <label for="year">Año</label>
        <input id="year" type="number" min="2000" max="2100" value="2026" />
      </div>

      <div class="field">
        <label for="anchor">Ancla (Día 1 del ciclo)</label>
        <input id="anchor" type="date" value="2026-01-01" />
      </div>

      <div class="field">
        <label>Acciones</label>
        <div class="row actions">
          <button id="render">Generar</button>
          <button class="secondary" id="reset">Resetear</button>
          <button class="secondary" id="print">Imprimir</button>
          <button class="secondary" id="export-config">Exportar</button>
          <button class="secondary" id="import-config">Importar</button>
          <button class="secondary" id="copy-link">Copiar enlace</button>
          <input id="import-file" class="hidden-file" type="file" accept="application/json" />
        </div>
      </div>
    </div>

    <div class="vac-controls">
      <label class="config-toggle">
        <input id="vac-mode" type="checkbox" />
        Modo vacaciones
      </label>
      <div class="vac-worker">
        <label for="vac-worker">Trabajador</label>
        <select id="vac-worker"></select>
      </div>
      <div class="vac-actions">
        <button id="vac-apply" type="button">Aplicar</button>
        <button id="vac-cancel" type="button" class="secondary">Cancelar</button>
      </div>
      <div id="vac-status" class="vac-status"></div>
      <div class="vac-hint">Click en los días del trabajador seleccionado para marcar V (incluye libres). Pulsa Aplicar para recalcular.</div>
    </div>

    <div class="legend">
      <span class="swatch"><span class="box m"></span> M · Mañana (06-14)</span>
      <span class="swatch"><span class="box t"></span> T · Tarde (14-22)</span>
      <span class="swatch"><span class="box n"></span> N · Noche (22-06)</span>
      <span class="swatch"><span class="box o"></span> O · Libre</span>
      <span class="swatch"><span class="box v"></span> V · Vacaciones</span>
      <span class="swatch"><span class="box h"></span> 12h · D12/N12 (06-18 / 18-06)</span>
      <span class="swatch">Los nombres (columna izquierda) y cabeceras quedan fijos al hacer scroll</span>
    </div>

    <div class="layout">
      <div id="calendar"></div>
      <aside class="annual-summary">
        <div id="annual-summary-panel"></div>
      </aside>
    </div>

  </div>

<script>
  // ====== Opciones de patrón (para 1 persona) + offsets para 5 ======
  // Construidas para que cada día haya exactamente: 1M, 1T, 1N, 2O.
  // Además, por diseño:
  // - T->M solo ocurre tras al menos 2 "O" (descanso).
  // - N->M solo ocurre tras al menos 3 "O" (descanso).
  // (Al usar descansos largos post-bloque y rotación progresiva).
  const OPTIONS = {
    "J": {
      type: "offset",
      name: "5-3-5-3-5-4 (MMMM-000-TTTNN-000-TTNNN-0000)",
      cycleLen: 25,
      pattern: [
        ...Array(5).fill("M"),
        ...Array(3).fill("O"),
        ...Array(3).fill("T"),
        ...Array(2).fill("N"),
        ...Array(3).fill("O"),
        ...Array(2).fill("T"),
        ...Array(3).fill("N"),
        ...Array(4).fill("O"),
      ],
      offsets: [0, 5, 10, 15, 20],
    },
    "I": {
      type: "offset",
      name: "6-2-3-4 (MMMTTT-00-NNN-0000)",
      cycleLen: 15,
      pattern: [
        ...Array(3).fill("M"),
        ...Array(3).fill("T"),
        ...Array(2).fill("O"),
        ...Array(3).fill("N"),
        ...Array(4).fill("O"),
      ],
      offsets: [0, 3, 6, 9, 12],
    },
    "D": {
      type: "offset",
      name: "6-4 (MM-TT-NN-0000)",
      cycleLen: 10,
      pattern: [
        ...Array(4).fill("O"),
        ...Array(2).fill("M"),
        ...Array(2).fill("T"),
        ...Array(2).fill("N"),
      ],
      offsets: [8, 6, 4, 2, 0],
    },
    "B": {
      type: "offset",
      name: "4-2-4-2-4-4 MMMM-00-TTTT-00-NNNN-0000",
      cycleLen: 20,
      pattern: [
        ...Array(4).fill("M"),
        ...Array(2).fill("O"),
        ...Array(4).fill("T"),
        ...Array(2).fill("O"),
        ...Array(4).fill("N"),
        ...Array(4).fill("O"),
      ],
      offsets: [0, 4, 8, 12, 16],
    },
  };

  const MONTHS_ES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  const DOW_ES = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
  const WORKER_COUNT = 5;
  const ALLOWED_ADJ = new Set(["M->M","M->T","T->T","T->N","N->N"]);
  const MAX_SAME_RUN = 2;
  const MAX_WORK_RUN = 6;
  const MIN_REST_RUN = 3;
  const MAX_REST_RUN = 4;
  let VACATIONS_APPLIED = {};
  let VACATIONS_DRAFT = {};
  let VACATIONS_ENABLED = true;
  let CURRENT_SCHEDULE = {};
  let CURRENT_COVER = {};

  function parseDateLocal(yyyy_mm_dd){
    const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  }
  function fmt2(n){ return String(n).padStart(2,"0"); }
  function toISO(date){
    return `${date.getFullYear()}-${fmt2(date.getMonth()+1)}-${fmt2(date.getDate())}`;
  }
  function getYearDates(year){
    const dates = [];
    const start = new Date(year, 0, 1);
    const end = new Date(year, 11, 31);
    for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
      dates.push(new Date(d));
    }
    return dates;
  }
  function numValue(id, fallback = 0){
    const raw = document.getElementById(id).value.trim().replace(",", ".");
    const val = parseFloat(raw);
    return Number.isFinite(val) ? val : fallback;
  }
  const STORAGE_KEY = "tvacCalendarConfigV1";
  function formatMoneyShort(value){
    return `€${Math.round(value).toLocaleString("es-ES")}`;
  }
  function formatMoneyFull(value){
    return new Intl.NumberFormat("es-ES", {
      style: "currency",
      currency: "EUR",
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }).format(value);
  }
  function formatCount(value){
    const num = Number(value);
    if(!Number.isFinite(num)) return value;
    if(Number.isInteger(num)) return String(num);
    return num.toLocaleString("es-ES", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  }
  function formatWorkWithVacations(work, vacations){
    const workStr = formatCount(work);
    if(!vacations) return workStr;
    return `${workStr}+${vacations}V`;
  }

  function buildMiniKpis(items){
    return items.map((item) => {
      const titleAttr = item.title ? ` title="${item.title}"` : "";
      return `<span class="mini"${titleAttr}><span class="mini-label">${item.label}</span><span class="mini-val">${item.value}</span></span>`;
    }).join("");
  }

  function normalizeVacations(raw, workerCount){
    const out = {};
    if(!raw || typeof raw !== "object") return out;
    Object.entries(raw).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      const norm = Array.from({length: workerCount}, (_, i) => Boolean(arr[i]));
      if(norm.some(Boolean)) out[date] = norm;
    });
    return out;
  }
  function cloneVacations(map){
    const out = {};
    if(!map || typeof map !== "object") return out;
    Object.entries(map).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      out[date] = arr.map(Boolean);
    });
    return out;
  }
  function vacationsEqual(a, b){
    const aKeys = Object.keys(a || {});
    const bKeys = Object.keys(b || {});
    if(aKeys.length !== bKeys.length) return false;
    for(const key of aKeys){
      const aRow = a[key] || [];
      const bRow = b[key] || [];
      for(let i=0; i<WORKER_COUNT; i++){
        if(Boolean(aRow[i]) !== Boolean(bRow[i])) return false;
      }
    }
    return true;
  }
  function hasPendingVacations(){
    if(!VACATIONS_ENABLED) return false;
    return !vacationsEqual(VACATIONS_APPLIED, VACATIONS_DRAFT);
  }
  function hasAppliedVacationsForYear(year){
    return Object.keys(VACATIONS_APPLIED || {}).some((iso) => {
      if(!iso.startsWith(`${year}-`)) return false;
      return Array.isArray(VACATIONS_APPLIED[iso]) && VACATIONS_APPLIED[iso].some(Boolean);
    });
  }
  function getVacation(map, dateStr, wIdx){
    return !!(map[dateStr] && map[dateStr][wIdx]);
  }
  function setVacation(map, dateStr, wIdx, value){
    const row = Array.isArray(map[dateStr])
      ? map[dateStr].slice()
      : Array.from({length: WORKER_COUNT}, () => false);
    row[wIdx] = Boolean(value);
    if(row.some(Boolean)){
      map[dateStr] = row;
    }else{
      delete map[dateStr];
    }
  }
  function toggleVacation(dateStr, wIdx){
    if(getVacation(VACATIONS_DRAFT, dateStr, wIdx)){
      setVacation(VACATIONS_DRAFT, dateStr, wIdx, false);
      return true;
    }
    setVacation(VACATIONS_DRAFT, dateStr, wIdx, true);
    return true;
  }
  function getVacationDisplay(dateStr, wIdx){
    if(!VACATIONS_ENABLED) return false;
    return getVacation(VACATIONS_DRAFT, dateStr, wIdx);
  }
  function applyVacationsDraft(){
    VACATIONS_APPLIED = cloneVacations(VACATIONS_DRAFT);
  }
  function resetVacationsDraft(){
    VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
  }
  function updateVacationStatus(){
    const status = document.getElementById("vac-status");
    const applyBtn = document.getElementById("vac-apply");
    const cancelBtn = document.getElementById("vac-cancel");
    const pending = hasPendingVacations();
    if(status){
      if(!VACATIONS_ENABLED){
        status.textContent = "Vacaciones solo disponibles en ciclo 6-4.";
      }else{
        status.textContent = pending ? "Pendiente de aplicar" : "";
      }
    }
    if(applyBtn) applyBtn.disabled = !pending;
    if(cancelBtn) cancelBtn.disabled = !pending;
  }
  function updateVacationAvailability(enabled){
    const vacMode = document.getElementById("vac-mode");
    const vacWorker = document.getElementById("vac-worker");
    const vacApply = document.getElementById("vac-apply");
    const vacCancel = document.getElementById("vac-cancel");
    const status = document.getElementById("vac-status");
    if(vacMode) vacMode.disabled = !enabled;
    if(vacWorker) vacWorker.disabled = !enabled;
    if(vacApply) vacApply.disabled = !enabled;
    if(vacCancel) vacCancel.disabled = !enabled;
    if(status && !enabled){
      status.textContent = "Vacaciones solo disponibles en ciclo 6-4.";
    }
  }

  function resetCalendarAndVacations(){
    VACATIONS_APPLIED = {};
    VACATIONS_DRAFT = {};
    const vacMode = document.getElementById("vac-mode");
    if(vacMode) vacMode.checked = false;
    saveConfig();
    render();
  }

  function coverageWarnings(year, schedule, opt, anchor, workerCount){
    const misses = [];
    const dates = getYearDates(year);
    dates.forEach((date) => {
      const iso = toISO(date);
      const counts = { M:0, T:0, N:0, D12:0, N12:0 };
      for(let wIdx=0; wIdx<workerCount; wIdx++){
        const raw = schedule[iso]?.[wIdx] ?? stateFor(wIdx, date, opt, anchor);
        const s = (raw === "V" || raw === undefined || raw === null) ? "O" : raw;
        coverageForShift(s).forEach((c) => { counts[c] += 1; });
      }
      const hasNormal = counts.M >= 1 && counts.T >= 1 && counts.N >= 1;
      const has12 = counts.D12 >= 1 && counts.N12 >= 1;
      if(counts.D12 > 0 || counts.N12 > 0){
        if(!has12){
          misses.push(`${iso} sin pareja 12h (D12/N12)`);
        }
      }else if(!hasNormal){
        const missing = ["M","T","N"].filter((k) => counts[k] < 1);
        misses.push(`${iso} sin cobertura (${missing.join("/")})`);
      }
    });
    return misses;
  }
  function syncVacationWorkers(workers){
    const select = document.getElementById("vac-worker");
    if(!select) return;
    const pref = select.dataset.pref;
    const current = select.value;
    select.innerHTML = "";
    workers.forEach((name, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = name;
      select.appendChild(opt);
    });
    const desired = (pref !== undefined && pref !== null && pref !== "") ? pref : current;
    if(desired !== undefined && desired !== null && desired !== ""){
      if(select.querySelector(`option[value="${desired}"]`)){
        select.value = desired;
      }
    }
    select.dataset.pref = "";
  }
  function updateVacationModeClass(){
    const cal = document.getElementById("calendar");
    const enabled = document.getElementById("vac-mode")?.checked;
    if(cal) cal.classList.toggle("vac-active", !!enabled);
  }
  function shiftInfo(shift){
    if(shift === "D12") return { type:"M", isWork:true, isNight:false, is12:true, short:"D12", full:"12h día (06-18)" };
    if(shift === "N12") return { type:"N", isWork:true, isNight:true, is12:true, short:"N12", full:"12h noche (18-06)" };
    if(shift === "M") return { type:"M", isWork:true, isNight:false, is12:false, short:"M", full:"Mañana" };
    if(shift === "T") return { type:"T", isWork:true, isNight:false, is12:false, short:"T", full:"Tarde" };
    if(shift === "N") return { type:"N", isWork:true, isNight:true, is12:false, short:"N", full:"Noche" };
    if(shift === "V") return { type:"O", isWork:false, isNight:false, is12:false, short:"V", full:"Vacaciones" };
    return { type:"O", isWork:false, isNight:false, is12:false, short:"O", full:"Libre" };
  }
  function isWorkShift(s){
    return shiftInfo(s).isWork;
  }
  function coverageForShift(shift){
    if(shift === "D12") return ["D12"];
    if(shift === "N12") return ["N12"];
    if(shift === "M" || shift === "T" || shift === "N") return [shift];
    return [];
  }
  function expectedShiftFromPos(pos){
    if(pos <= 1) return "M";
    if(pos <= 3) return "T";
    return "N";
  }
  function primeValidationState(state, startDate, daysBack, opt, anchor, workers){
    for(let i = daysBack; i >= 1; i--){
      const d = new Date(startDate);
      d.setDate(d.getDate() - i);
      for(let wIdx = 0; wIdx < workers.length; wIdx++){
        const s = stateFor(wIdx, d, opt, anchor);
        const info = shiftInfo(s);
        if(info.isWork){
          state[wIdx].seqPos = state[wIdx].seqPos === -1 ? 1 : state[wIdx].seqPos + 1;
        }else{
          state[wIdx].seqPos = -1;
        }
        applyShiftToState(state[wIdx], s);
      }
    }
  }
  function dayIndexFromAnchor(date, anchor){
    const ms = 24*60*60*1000;
    const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
    const utcAnchor = Date.UTC(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());
    return Math.floor((utcDate - utcAnchor) / ms);
  }

  function stateFor(workerIdx, date, opt, anchor){
    const idx = ((dayIndexFromAnchor(date, anchor) % opt.cycleLen) + opt.cycleLen) % opt.cycleLen;
    if(opt.type === "matrix"){
      return opt.cycle[idx][workerIdx];
    }
    return opt.pattern[(idx + opt.offsets[workerIdx]) % opt.cycleLen];
  }

  function isWeekend(date){
    // JS: 0=Dom,6=Sáb
    const d = date.getDay();
    return d === 0 || d === 6;
  }

  function parseHolidayList(raw){
    const set = new Set();
    raw.split(/[\s,;]+/).forEach((token) => {
      if(/^\d{4}-\d{2}-\d{2}$/.test(token)) set.add(token);
    });
    return set;
  }

  function canAssignShift(st, shift){
    const info = shiftInfo(shift);
    if(!info.isWork) return true;
    if(info.is12 && st.last12) return false;
    const type = info.type;
    if(st.lastShift !== "O"){
      if(st.workRun >= MAX_WORK_RUN) return false;
      const key = `${st.lastShift}->${type}`;
      if(!ALLOWED_ADJ.has(key)) return false;
      const workRun = st.workRun + 1;
      const sameRun = (st.lastShift === type) ? st.sameRun + 1 : 1;
      if(workRun > MAX_WORK_RUN) return false;
      if(sameRun > MAX_SAME_RUN) return false;
      if(info.isNight){
        const nightRun = (st.lastShift === "N") ? st.nightRun + 1 : 1;
        if(nightRun > MAX_SAME_RUN) return false;
      }
    }else{
      if(st.lastWork !== null){
        if(st.restRun < MIN_REST_RUN) return false;
        if(st.lastWork === "N" && type === "M" && st.restRun < MIN_REST_RUN) return false;
        if(st.lastWork === "T" && type === "M" && st.restRun < MIN_REST_RUN) return false;
      }
    }
    return true;
  }

  function applyShiftToState(st, shift){
    const info = shiftInfo(shift);
    if(info.isWork){
      if(st.lastShift !== "O"){
        st.workRun += 1;
        st.sameRun = (st.lastShift === info.type) ? st.sameRun + 1 : 1;
      }else{
        st.workRun = 1;
        st.sameRun = 1;
      }
      if(info.isNight){
        st.nightRun = (st.lastShift === "N") ? st.nightRun + 1 : 1;
      }else{
        st.nightRun = 0;
      }
      st.lastShift = info.type;
      st.lastWork = info.type;
      st.restRun = 0;
      st.last12 = info.is12;
    }else{
      st.restRun = st.lastShift === "O" ? st.restRun + 1 : 1;
      st.lastShift = "O";
      st.workRun = 0;
      st.sameRun = 0;
      st.nightRun = 0;
      st.last12 = false;
    }
  }

  function getPayConfig(){
    const base = numValue("base-monthly");
    const extra = numValue("extra-prorrateo");
    const comp1 = numValue("comp-1");
    const comp2 = numValue("comp-2");
    const turnicidad = numValue("turnicidad");
    const hours = numValue("hours-per-shift", 8);
    const hourly = numValue("hourly-rate", 9.25);
    const nightMult = numValue("night-mult", 0.6);
    const weekendMult = numValue("weekend-mult", 1);
    const holidayMult = numValue("holiday-mult", 2);
    const stackHolidayWeekend = document.getElementById("stack-holiday-weekend").checked;
    const showMonthlyPay = document.getElementById("show-monthly-pay").checked;
    const fixed = base + extra + comp1 + comp2 + turnicidad;

    return {
      fixed,
      base,
      extra,
      comp1,
      comp2,
      turnicidad,
      hours,
      hourly,
      nightMult,
      weekendMult,
      holidayMult,
      stackHolidayWeekend,
      showMonthlyPay,
    };
  }
  function prime6x2State(state, startDate, daysBack, opt, anchor, workers){
    for(let i = daysBack; i >= 1; i--){
      const d = new Date(startDate);
      d.setDate(d.getDate() - i);
      for(let wIdx = 0; wIdx < workers.length; wIdx++){
        const shift = stateFor(wIdx, d, opt, anchor);
        const st = state[wIdx];
        if(shift === "O"){
          const wasRest = st.phase === -1;
          st.phase = -1;
          st.restRun = wasRest ? st.restRun + 1 : 1;
        }else{
          const phaseNow = st.phase === -1 ? 0 : st.phase;
          const nextPhase = phaseNow + 1;
          if(nextPhase >= 6){
            st.phase = -1;
            st.restRun = 0;
          }else{
            st.phase = nextPhase;
            st.restRun = 0;
          }
        }
      }
    }
  }

  function buildScheduleWithVacations(year, opt, anchor, workers, options = {}){
    if(!opt){
      return { schedule: {}, cover: {}, warnings: ["No hay opción de ciclo válida."] };
    }
    const workerCount = workers.length;
    const dates = getYearDates(year);
    const base = {};
    dates.forEach((date) => {
      const iso = toISO(date);
      base[iso] = workers.map((_, wIdx) => stateFor(wIdx, date, opt, anchor));
    });

    const activeVac = VACATIONS_ENABLED ? VACATIONS_APPLIED : {};
    const vacDates = Object.keys(activeVac).filter((iso) => iso.startsWith(`${year}-`) && activeVac[iso]?.some(Boolean));
    if(!vacDates.length){
      return { schedule: base, cover: {}, warnings: [] };
    }

    const allowAdjust = options.adjust6x2 && opt.cycleLen === 10;
    if(!allowAdjust){
      const schedule = {};
      dates.forEach((date) => {
        const iso = toISO(date);
        const row = base[iso].slice();
        if(activeVac[iso]){
          activeVac[iso].forEach((isVac, wIdx) => {
            if(isVac) row[wIdx] = "V";
          });
        }
        schedule[iso] = row;
      });
      return { schedule, cover: {}, warnings: [] };
    }

    const seqShift = (phase) => (phase <= 1 ? "M" : phase <= 3 ? "T" : "N");
    const hasVacInNext6 = (wIdx, dayIdx) => {
      for(let i=0; i<6; i++){
        const idx = dayIdx + i;
        if(idx >= dates.length) break;
        const iso = toISO(dates[idx]);
        if(activeVac[iso]?.[wIdx]) return true;
      }
      return false;
    };

    const initState = Array.from({length: workerCount}, () => ({ phase: -1, restRun: 0 }));
    prime6x2State(initState, dates[0], 20, opt, anchor, workers);

    let beam = [{
      cost: 0,
      state: initState,
      schedule: {},
      cover: {},
    }];

    const beamWidth = options.beamWidth ?? 12;
    const dayPenalty = (assigned, baseShift) => {
      if(assigned === baseShift) return 0;
      if(assigned === "O" && baseShift !== "O") return 1.2;
      if(assigned !== "O" && baseShift === "O") return 0.9;
      return 1.5;
    };

    for(let dayIdx = 0; dayIdx < dates.length; dayIdx++){
      const iso = toISO(dates[dayIdx]);
      const baseRow = base[iso];
      const vacRow = activeVac[iso] || [];
      const next = [];
      const bestBySig = new Map();

      beam.forEach((cand) => {
        const assignments = Array(workerCount).fill("O");
        const counts = { M:0, T:0, N:0 };
        let invalid = false;

        for(let wIdx = 0; wIdx < workerCount; wIdx++){
          const st = cand.state[wIdx];
          const isVac = Boolean(vacRow[wIdx]);
          if(isVac){
            assignments[wIdx] = "V";
            continue;
          }
          if(st.phase >= 0){
            const s = seqShift(st.phase);
            assignments[wIdx] = s;
            counts[s] += 1;
          }
        }
        if(invalid) return;
        if(counts.M > 1 || counts.T > 1 || counts.N > 1) return;
        if(counts.T !== 1 || counts.N !== 1) return;

        const needM = counts.M === 0;
        const starters = [];
        if(needM){
          for(let wIdx = 0; wIdx < workerCount; wIdx++){
            const st = cand.state[wIdx];
            if(assignments[wIdx] !== "O") continue;
            if(st.restRun < 2) continue;
            if(hasVacInNext6(wIdx, dayIdx)) continue;
            starters.push(wIdx);
          }
          if(!starters.length) return;
        }

        const tryAdd = (starterIdx) => {
          const plan = assignments.slice();
          const startSet = new Set();
          if(starterIdx !== null){
            plan[starterIdx] = "M";
            startSet.add(starterIdx);
          }
          const newState = cand.state.map((st) => ({ ...st }));
          const coverRow = [];
          let cost = cand.cost;
          let invalidPlan = false;

          for(let wIdx = 0; wIdx < workerCount; wIdx++){
            const assigned = plan[wIdx];
            const baseShift = baseRow[wIdx];
            const isVac = Boolean(vacRow[wIdx]);
            if(!isVac) cost += dayPenalty(assigned, baseShift);
            if(!isVac && baseShift === "O" && (assigned === "M" || assigned === "T" || assigned === "N")){
              coverRow.push(wIdx);
            }

            const st = newState[wIdx];
            const wasRest = st.phase === -1;
            const prevRest = st.restRun;

            if(assigned === "M" || assigned === "T" || assigned === "N"){
              const started = startSet.has(wIdx);
              const phaseNow = started ? 0 : st.phase;
              const nextPhase = phaseNow + 1;
              if(nextPhase >= 6){
                st.phase = -1;
                st.restRun = 0;
              }else{
                st.phase = nextPhase;
                st.restRun = 0;
              }
              if(started){
                const restPenalty = Math.max(0, 2 - prevRest);
                if(restPenalty > 0) cost += restPenalty * 0.8;
              }
            }else{
              if(!isVac && wasRest && prevRest >= MAX_REST_RUN){
                invalidPlan = true;
                break;
              }
              st.phase = -1;
              st.restRun = wasRest ? prevRest + 1 : 1;
            }
          }
          if(invalidPlan) return;

          const newSchedule = { ...cand.schedule, [iso]: plan };
          const newCover = coverRow.length ? { ...cand.cover, [iso]: coverRow } : cand.cover;
          const sig = newState.map((s) => `${s.phase}:${s.restRun}`).join("|");
          const existing = bestBySig.get(sig);
          if(existing && existing.cost <= cost) return;
          const nextCand = { cost, state: newState, schedule: newSchedule, cover: newCover };
          bestBySig.set(sig, nextCand);
          next.push(nextCand);
        };

        if(!needM){
          tryAdd(null);
        }else{
          starters.forEach((starterIdx) => tryAdd(starterIdx));
        }
      });

      if(!next.length){
        const fallback = {};
        dates.forEach((date) => {
          const fallbackIso = toISO(date);
          const row = base[fallbackIso].slice();
          if(activeVac[fallbackIso]){
            activeVac[fallbackIso].forEach((isVac, wIdx) => {
              if(isVac) row[wIdx] = "V";
            });
          }
          fallback[fallbackIso] = row;
        });
        return { schedule: fallback, cover: {}, warnings: [`No hay solución válida desde ${iso}.`] };
      }

      next.sort((a, b) => a.cost - b.cost);
      beam = next.slice(0, beamWidth);
    }

    const best = beam[0];
    return { schedule: best.schedule, cover: best.cover || {}, warnings: [] };
  }

  function collectConfig(){
    return {
      pattern: document.getElementById("pattern")?.value || "",
      year: document.getElementById("year")?.value || "",
      anchor: document.getElementById("anchor")?.value || "",
      w1: document.getElementById("w1")?.value || "",
      w2: document.getElementById("w2")?.value || "",
      w3: document.getElementById("w3")?.value || "",
      w4: document.getElementById("w4")?.value || "",
      w5: document.getElementById("w5")?.value || "",
      baseMonthly: document.getElementById("base-monthly")?.value || "",
      extraProrrateo: document.getElementById("extra-prorrateo")?.value || "",
      comp1: document.getElementById("comp-1")?.value || "",
      comp2: document.getElementById("comp-2")?.value || "",
      turnicidad: document.getElementById("turnicidad")?.value || "",
      hoursPerShift: document.getElementById("hours-per-shift")?.value || "",
      hourlyRate: document.getElementById("hourly-rate")?.value || "",
      nightMult: document.getElementById("night-mult")?.value || "",
      weekendMult: document.getElementById("weekend-mult")?.value || "",
      holidayMult: document.getElementById("holiday-mult")?.value || "",
      holidayList: document.getElementById("holiday-list")?.value || "",
      stackHolidayWeekend: document.getElementById("stack-holiday-weekend")?.checked || false,
      showMonthlyPay: document.getElementById("show-monthly-pay")?.checked || false,
      vacMode: document.getElementById("vac-mode")?.checked || false,
      vacWorker: document.getElementById("vac-worker")?.value || "0",
      vacationsApplied: VACATIONS_APPLIED,
      vacationsDraft: VACATIONS_DRAFT,
    };
  }

  function applyConfig(cfg){
    if(!cfg || typeof cfg !== "object") return;
    if(cfg.year && document.getElementById("year")) document.getElementById("year").value = cfg.year;
    if(cfg.anchor && document.getElementById("anchor")) document.getElementById("anchor").value = cfg.anchor;
    if(cfg.pattern){
      const select = document.getElementById("pattern");
      if(select) select.dataset.pref = cfg.pattern;
    }

    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(el && val !== undefined && val !== null && val !== "") el.value = val;
    };
    setVal("w1", cfg.w1);
    setVal("w2", cfg.w2);
    setVal("w3", cfg.w3);
    setVal("w4", cfg.w4);
    setVal("w5", cfg.w5);
    setVal("base-monthly", cfg.baseMonthly);
    setVal("extra-prorrateo", cfg.extraProrrateo);
    setVal("comp-1", cfg.comp1);
    setVal("comp-2", cfg.comp2);
    setVal("turnicidad", cfg.turnicidad);
    setVal("hours-per-shift", cfg.hoursPerShift);
    setVal("hourly-rate", cfg.hourlyRate);
    setVal("night-mult", cfg.nightMult);
    setVal("weekend-mult", cfg.weekendMult);
    setVal("holiday-mult", cfg.holidayMult);
    setVal("holiday-list", cfg.holidayList);

    const setChecked = (id, val) => {
      const el = document.getElementById(id);
      if(el && typeof val === "boolean") el.checked = val;
    };
    setChecked("stack-holiday-weekend", cfg.stackHolidayWeekend);
    setChecked("show-monthly-pay", cfg.showMonthlyPay);
    setChecked("vac-mode", cfg.vacMode);
    if(cfg.vacWorker !== undefined && cfg.vacWorker !== null){
      const select = document.getElementById("vac-worker");
      if(select) select.dataset.pref = String(cfg.vacWorker);
    }
    if(cfg.vacationsApplied && typeof cfg.vacationsApplied === "object"){
      VACATIONS_APPLIED = normalizeVacations(cfg.vacationsApplied, WORKER_COUNT);
    }
    if(cfg.vacationsDraft && typeof cfg.vacationsDraft === "object"){
      VACATIONS_DRAFT = normalizeVacations(cfg.vacationsDraft, WORKER_COUNT);
    }else{
      VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
    }
  }

  function saveConfig(){
    const cfg = collectConfig();
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }catch(_e){}
  }

  function loadConfig(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const cfg = JSON.parse(raw);
      applyConfig(cfg);
    }catch(_e){}
  }

  function encodeConfig(cfg){
    const json = JSON.stringify(cfg);
    return btoa(encodeURIComponent(json));
  }
  function decodeConfig(encoded){
    const json = decodeURIComponent(atob(encoded));
    return JSON.parse(json);
  }
  function applyConfigFromHash(){
    const hash = window.location.hash || "";
    const match = hash.match(/#cfg=([^&]+)/);
    if(!match) return false;
    try{
      const cfg = decodeConfig(match[1]);
      applyConfig(cfg);
      saveConfig();
      try{
        const baseUrl = window.location.href.split("#")[0];
        window.history.replaceState(null, "", baseUrl);
      }catch(_e){}
      return true;
    }catch(_e){
      return false;
    }
  }

  function updateFixedTotal(config){
    const el = document.getElementById("fixed-total");
    if(el) el.textContent = formatMoneyFull(config.fixed);
  }

  function calcMonthlyPay(totals, config){
    const nightExtra = totals.nights * config.hourly * config.nightMult * config.hours;
    const weekendExtra = (totals.weekendsPay ?? totals.weekends) * config.hourly * config.weekendMult * config.hours;
    const holidayExtra = totals.holidays * config.hourly * config.holidayMult * config.hours;
    return config.fixed + nightExtra + weekendExtra + holidayExtra;
  }

  function validateOption(opt){
    const W = 5;
    for(let d=0; d<opt.cycleLen; d++){
      const codes = [];
      for(let i=0;i<W;i++){
        if(opt.type === "matrix"){
          codes.push(opt.cycle[d][i]);
        }else{
          codes.push(opt.pattern[(d + opt.offsets[i]) % opt.cycleLen]);
        }
      }
      const ok = (codes.filter(x=>x==="M").length===1) &&
                 (codes.filter(x=>x==="T").length===1) &&
                 (codes.filter(x=>x==="N").length===1) &&
                 (codes.filter(x=>x==="O").length===2);
      if(!ok) return false;
    }
    return true;
  }

  function validateRulesYear(year, opt, anchor, workers, stateFn){
    const violations = [];
    const seen = new Set();
    const totals = initTotals(workers.length);
    const minRest = (VACATIONS_ENABLED && opt && opt.cycleLen === 10 && hasAppliedVacationsForYear(year)) ? 2 : MIN_REST_RUN;
    const state = workers.map(() => ({
      lastShift: "O",
      lastWork: null,
      restRun: 0,
      workRun: 0,
      sameRun: 0,
      nightRun: 0,
      last12: false,
      seqPos: -1,
    }));

    const pushOnce = (wIdx, key, msg) => {
      const id = `${wIdx}-${key}`;
      if(!seen.has(id)){
        seen.add(id);
        violations.push(`Trabajador ${wIdx+1}: ${msg}`);
      }
    };

    const date = new Date(year, 0, 1);
    const primeDays = opt ? Math.max(opt.cycleLen || 0, MAX_WORK_RUN + MIN_REST_RUN + 4) : 0;
    if(opt && primeDays > 0){
      primeValidationState(state, date, primeDays, opt, anchor, workers);
    }
    const end = new Date(year, 11, 31);
    for(let d = new Date(date); d <= end; d.setDate(d.getDate()+1)){
      const iso = toISO(d);
      let dayHasWorkVac = false;
      for(let wIdx=0; wIdx<workers.length; wIdx++){
        if(!dayHasWorkVac && opt && VACATIONS_APPLIED[iso]?.[wIdx]){
          const base = stateFor(wIdx, d, opt, anchor);
          if(base !== "O") dayHasWorkVac = true;
        }
        const raw = stateFn ? stateFn(wIdx, d) : stateFor(wIdx, d, opt, anchor);
        const normalized = (raw === "V" || raw === undefined || raw === null) ? "O" : raw;
        const info = shiftInfo(normalized);
        const s = info.type;
        const st = state[wIdx];
        const isWork = info.isWork;

        if(isWork){
          if(st.seqPos >= MAX_WORK_RUN){
            pushOnce(wIdx, "seq-end", "bloque completo: debe descansar.");
          }
          const expected = st.seqPos === -1 ? "M" : expectedShiftFromPos(st.seqPos);
          if(s !== expected){
            pushOnce(wIdx, "seq", `secuencia inválida: esperado ${expected}.`);
          }
          totals[wIdx].work += 1;
          if(info.isNight) totals[wIdx].nights += 1;
          if(isWeekend(d)) totals[wIdx].weekends += 1;

          if(info.is12 && st.last12){
            pushOnce(wIdx, "12h", "no se permiten 12h consecutivos.");
          }
          if(info.is12 && !dayHasWorkVac){
            pushOnce(wIdx, "12h-nv", "12h solo permitido en días con vacaciones.");
          }

          if(st.lastShift !== "O"){
            const key = `${st.lastShift}->${s}`;
            if(!ALLOWED_ADJ.has(key)){
              pushOnce(wIdx, "adj", `transición no permitida ${key}.`);
            }
          }else{
            if(st.lastWork !== null){
              if(st.restRun < minRest){
                pushOnce(wIdx, "rest", `descanso entre bloques < ${minRest} días.`);
              }
              if(st.lastWork === "N" && st.restRun < minRest){
                pushOnce(wIdx, "rest-n", `salida de noches con descanso < ${minRest} días.`);
              }
              if(st.lastWork === "N" && s === "M" && st.restRun < minRest){
                pushOnce(wIdx, "n-to-m", `N→M requiere ≥${minRest} días de descanso.`);
              }
              if(st.lastWork === "T" && s === "M" && st.restRun < minRest){
                pushOnce(wIdx, "t-to-m", `T→M requiere ≥${minRest} días de descanso.`);
              }
            }
          }

          st.workRun = st.lastShift === "O" ? 1 : st.workRun + 1;
          if(st.workRun > MAX_WORK_RUN){
            pushOnce(wIdx, "max-work", `supera ${MAX_WORK_RUN} días seguidos de trabajo.`);
          }

          st.sameRun = st.lastShift === s ? st.sameRun + 1 : 1;
          if(st.sameRun > MAX_SAME_RUN){
            pushOnce(wIdx, `max-${s}`, `supera ${MAX_SAME_RUN} días seguidos en ${s}.`);
          }

          if(info.isNight){
            st.nightRun = st.lastShift === "N" ? st.nightRun + 1 : 1;
            if(st.nightRun > MAX_SAME_RUN){
              pushOnce(wIdx, "max-n", `supera ${MAX_SAME_RUN} noches seguidas.`);
            }
          }else{
            st.nightRun = 0;
          }

          st.lastShift = s;
          st.lastWork = s;
          st.restRun = 0;
          st.last12 = info.is12;
          st.seqPos = st.seqPos === -1 ? 1 : st.seqPos + 1;
          if(st.seqPos > MAX_WORK_RUN) st.seqPos = MAX_WORK_RUN;
        }else{
          if(st.lastShift !== "O" && st.workRun !== MAX_WORK_RUN){
            pushOnce(wIdx, "block-6", `bloque de trabajo debe ser de ${MAX_WORK_RUN} días.`);
          }
          st.restRun = st.lastShift === "O" ? st.restRun + 1 : 1;
          st.lastShift = "O";
          st.workRun = 0;
          st.sameRun = 0;
          st.nightRun = 0;
          st.last12 = false;
          st.seqPos = -1;
        }
      }
    }

    return { violations, totals };
  }

  function equityWarnings(totals){
    const warnings = [];
    const diff = (key) => {
      const vals = totals.map(t => t[key]);
      return Math.max(...vals) - Math.min(...vals);
    };
    const dWork = diff("work");
    const dNight = diff("nights");
    const dWeekend = diff("weekends");
    if(dWork > 5) warnings.push(`Equidad anual: diferencia de jornadas ${dWork} (>5).`);
    if(dNight > 5) warnings.push(`Equidad anual: diferencia de noches ${dNight} (>5).`);
    if(dWeekend > 5) warnings.push(`Equidad anual: diferencia de fines de semana ${dWeekend} (>5).`);
    return warnings;
  }

  function rebuildPatternOptions(year, anchor, keepKey){
    const select = document.getElementById("pattern");
    if(!select) return null;
    const valid = [];

    Object.entries(OPTIONS).forEach(([key, opt]) => {
      valid.push({ key, name: opt.name });
    });

    select.innerHTML = "";
    if(!valid.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sin opciones válidas";
      select.appendChild(opt);
      select.disabled = true;
      return null;
    }
    select.disabled = false;
    valid.forEach(({key, name}) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = name;
      select.appendChild(opt);
    });

    const stillValid = keepKey && valid.some(v => v.key === keepKey);
    select.value = stillValid ? keepKey : valid[0].key;
    return select.value;
  }

  function initTotals(count){
    return Array.from({length: count}, () => ({
      work: 0,
      nights: 0,
      weekends: 0,
      holidays: 0,
      weekendsPay: 0,
      vacations: 0,
      pay: 0,
    }));
  }

  function createSummaryKpis(workers, totals, titleText, extraClass, options){
    const summary = document.createElement("div");
    summary.className = `kpi-panel ${extraClass || ""}`.trim();

    const title = document.createElement("div");
    title.className = "kpi-title";
    title.textContent = titleText;
    summary.appendChild(title);

    const list = document.createElement("div");
    list.className = "kpi-list";

    const opts = options || {};
    workers.forEach((name, idx) => {
      const row = document.createElement("div");
      row.className = "kpi-row";

      const nameEl = document.createElement("div");
      nameEl.className = "kpi-name";
      nameEl.textContent = name;
      row.appendChild(nameEl);

      const workWithVac = formatWorkWithVacations(totals[idx].work, totals[idx].vacations);
      const workTitle = totals[idx].vacations
        ? `Jornadas: ${formatCount(totals[idx].work)} + Vacaciones: ${totals[idx].vacations}`
        : "Jornadas";
      const chips = [
        { label: "J", value: workWithVac, title: workTitle },
        { label: "N", value: totals[idx].nights, title: "Noches" },
        { label: "F", value: totals[idx].weekends, title: "Fines de semana" },
      ];
      if(opts.showHolidays){
        chips.push({ label: "H", value: totals[idx].holidays, title: "Festivos" });
      }
      if(opts.showPay){
        chips.push({ label: "€", value: formatMoneyShort(totals[idx].pay), title: "Bruto anual" });
      }

      chips.forEach((chip) => {
        const chipEl = document.createElement("div");
        chipEl.className = "kpi-chip";
        if(chip.label === "€"){
          chipEl.title = `${chip.title}: ${formatMoneyFull(totals[idx].pay)}`;
        }else{
          chipEl.title = chip.title;
        }
        chipEl.innerHTML = `<span class="kpi-label">${chip.label}</span><span class="kpi-value">${chip.value}</span>`;
        row.appendChild(chipEl);
      });

      list.appendChild(row);
    });

    summary.appendChild(list);
    if(opts.showLegend){
      const legend = document.createElement("div");
      legend.className = "kpi-legend";
      legend.textContent = "J Jornadas (+V vacaciones) · N Noches · F Finde · H Festivos";
      summary.appendChild(legend);
    }
    return summary;
  }

  function buildMonthQuadrant(year, monthIdx, opt, workers, anchor, annualTotals, config, holidaySet, schedule, cover){
    const first = new Date(year, monthIdx, 1);
    const last = new Date(year, monthIdx+1, 0);
    const daysInMonth = last.getDate();

    const wrap = document.createElement("div");
    wrap.className = "month-wrap";
    wrap.style.setProperty("--i", monthIdx);

    const head = document.createElement("div");
    head.className = "month-head";
    head.innerHTML = `
      <div class="month-title">${MONTHS_ES[monthIdx]} ${year}</div>
      <div class="month-meta">${opt.name} — ciclo ${opt.cycleLen} días (ancla ${anchor.getFullYear()}-${fmt2(anchor.getMonth()+1)}-${fmt2(anchor.getDate())})</div>
    `;
    wrap.appendChild(head);

    const scroller = document.createElement("div");
    scroller.className = "scroller";

    const table = document.createElement("table");

    // THEAD: fila con días del mes (y día de la semana)
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.className = "sticky";
    th0.textContent = "Trabajador";
    trh.appendChild(th0);

    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, monthIdx, d);
      const jsDow = date.getDay();            // 0=Dom..6=Sáb
      const dowMon0 = (jsDow + 6) % 7;        // 0=Lun..6=Dom
      const th = document.createElement("th");
      th.innerHTML = `<div class="dom">${fmt2(d)}</div><div class="dow">${DOW_ES[dowMon0]}</div>`;
      if(isWeekend(date)) th.style.background = "var(--c-weekend)";
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    // TBODY: una fila por trabajador, con M/T/N/O por día
    const tbody = document.createElement("tbody");
    workers.forEach((wName, wIdx) => {
      const tr = document.createElement("tr");

      const nameCell = document.createElement("td");
      nameCell.className = "sticky";
      tr.appendChild(nameCell);

      const rowTotals = { work: 0, nights: 0, weekends: 0, holidays: 0, weekendsPay: 0, vacations: 0 };

      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, monthIdx, d);
        const iso = `${year}-${fmt2(monthIdx+1)}-${fmt2(d)}`;
        const baseShift = stateFor(wIdx, date, opt, anchor);
        const rawShift = (schedule && schedule[iso] && schedule[iso][wIdx]) ? schedule[iso][wIdx] : baseShift;
        const displayVacation = getVacationDisplay(iso, wIdx);
        const s = displayVacation ? "V" : (rawShift || "O");
        const info = shiftInfo(s);
        const appliedVac = VACATIONS_ENABLED && Boolean(VACATIONS_APPLIED[iso]?.[wIdx]);
        if(appliedVac){
          rowTotals.vacations += 1;
        }

        const td = document.createElement("td");
        td.className = `cell ${s}`;
        if(cover && cover[iso] && cover[iso].includes(wIdx)) td.classList.add("cover");
        td.dataset.date = iso;
        td.dataset.worker = String(wIdx);
        td.dataset.shift = s;
        const full = info.full;
        const short = info.short;
        td.innerHTML = `<span>${short}</span>`;
        td.title = full;
        td.setAttribute("aria-label", full);
        if(isWeekend(date)) td.classList.add("wknd");
        tr.appendChild(td);

      if(info.isWork){
          rowTotals.work += info.is12 ? 1.5 : 1;
          if(info.isNight) rowTotals.nights += 1;
          const holiday = holidaySet.has(iso);
          if(isWeekend(date)) rowTotals.weekends += 1;
          if(holiday) rowTotals.holidays += 1;
          if(isWeekend(date) && (!holiday || config.stackHolidayWeekend)) rowTotals.weekendsPay += 1;
        }
      }

      const monthlyPay = calcMonthlyPay(rowTotals, config);
      const workWithVac = formatWorkWithVacations(rowTotals.work, rowTotals.vacations);
      const workTitle = rowTotals.vacations
        ? `Jornadas: ${formatCount(rowTotals.work)} + Vacaciones: ${rowTotals.vacations}`
        : "Jornadas";
      const kpiItems = [
        { label: "J", value: workWithVac, title: workTitle },
        { label: "N", value: rowTotals.nights },
        { label: "F", value: rowTotals.weekends },
      ];
      if(config.showMonthlyPay){
        kpiItems.push({ label: "€", value: formatMoneyShort(monthlyPay) });
      }
      const kpiTitleParts = [
        `J:${workWithVac}`,
        `N:${rowTotals.nights}`,
        `F:${rowTotals.weekends}`,
      ];
      if(config.showMonthlyPay){
        kpiTitleParts.push(formatMoneyFull(monthlyPay));
      }
      const kpiTitle = kpiTitleParts.join(" ");
      nameCell.innerHTML = `<span class="name-wrap"><span class="name-kpis">${buildMiniKpis(kpiItems)}</span><span class="name-person">${wName}</span></span>`;
      nameCell.title = `${kpiTitle} ${wName}`;
      nameCell.setAttribute("aria-label", `${kpiTitle} ${wName}`);

      if(annualTotals){
        annualTotals[wIdx].work += rowTotals.work;
        annualTotals[wIdx].nights += rowTotals.nights;
        annualTotals[wIdx].weekends += rowTotals.weekends;
        annualTotals[wIdx].holidays += rowTotals.holidays;
        annualTotals[wIdx].weekendsPay += rowTotals.weekendsPay;
        annualTotals[wIdx].pay += monthlyPay;
        annualTotals[wIdx].vacations += rowTotals.vacations;
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    scroller.appendChild(table);
    wrap.appendChild(scroller);
    return wrap;
  }

  function render(){
    const year = Number(document.getElementById("year").value);
    const anchor = parseDateLocal(document.getElementById("anchor").value);
    const patternSelect = document.getElementById("pattern");
    let keepKey = patternSelect ? patternSelect.value : null;
    if(patternSelect && patternSelect.dataset.pref){
      keepKey = patternSelect.dataset.pref;
      patternSelect.dataset.pref = "";
    }
    const patternKey = rebuildPatternOptions(year, anchor, keepKey);
    const opt = patternKey ? OPTIONS[patternKey] : null;

    const workers = [
      document.getElementById("w1").value.trim() || "A",
      document.getElementById("w2").value.trim() || "B",
      document.getElementById("w3").value.trim() || "C",
      document.getElementById("w4").value.trim() || "D",
      document.getElementById("w5").value.trim() || "E",
    ];
    syncVacationWorkers(workers);

    const container = document.getElementById("calendar");
    container.innerHTML = "";
    const annualTotals = initTotals(workers.length);
    const annualContainer = document.getElementById("annual-summary-panel");
    annualContainer.innerHTML = "";
    const config = getPayConfig();
    updateFixedTotal(config);
    const holidaySet = parseHolidayList(document.getElementById("holiday-list").value);
    if(!VACATIONS_DRAFT || typeof VACATIONS_DRAFT !== "object"){
      VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
    }
    const vacAllowed = patternKey === "D";
    VACATIONS_ENABLED = vacAllowed;
    if(!vacAllowed){
      const vacMode = document.getElementById("vac-mode");
      if(vacMode) vacMode.checked = false;
    }
    const pendingVacations = vacAllowed ? hasPendingVacations() : false;
    updateVacationAvailability(vacAllowed);

    const warnings = [];
    if(!opt){
      warnings.push("No hay opciones válidas para las reglas actuales.");
    }else{
      if(!validateOption(opt)){
        warnings.push("La opción seleccionada no garantiza 1M/1T/1N/2O cada día.");
      }
    }

    if(opt){
      if(pendingVacations){
        warnings.push("Vacaciones pendientes de aplicar.");
      }
      const schedulePack = buildScheduleWithVacations(year, opt, anchor, workers, { adjust6x2: vacAllowed });
      CURRENT_SCHEDULE = schedulePack.schedule || {};
      CURRENT_COVER = schedulePack.cover || {};
      if(!pendingVacations && schedulePack.warnings && schedulePack.warnings.length){
        warnings.push(...schedulePack.warnings);
      }

      if(!pendingVacations){
        const stateFn = (wIdx, date) => {
          const iso = toISO(date);
          if(CURRENT_SCHEDULE[iso] && CURRENT_SCHEDULE[iso][wIdx]) return CURRENT_SCHEDULE[iso][wIdx];
          return stateFor(wIdx, date, opt, anchor);
        };
        const ruleReport = validateRulesYear(year, opt, anchor, workers, stateFn);
        warnings.push(...ruleReport.violations.slice(0, 8));
        if(ruleReport.violations.length > 8){
          warnings.push(`…y ${ruleReport.violations.length - 8} más.`);
        }

        const coverageIssues = coverageWarnings(year, CURRENT_SCHEDULE, opt, anchor, workers.length);
        if(coverageIssues.length){
          warnings.push(...coverageIssues.slice(0, 6));
          if(coverageIssues.length > 6){
            warnings.push(`…y ${coverageIssues.length - 6} días con cobertura incompleta.`);
          }
        }
      }

      for(let m=0; m<12; m++){
        container.appendChild(buildMonthQuadrant(year, m, opt, workers, anchor, annualTotals, config, holidaySet, CURRENT_SCHEDULE, CURRENT_COVER));
      }
      warnings.push(...equityWarnings(annualTotals));

      if(!pendingVacations){
        let count12 = 0;
        Object.values(CURRENT_SCHEDULE).forEach((row) => {
          row.forEach((s) => {
            if(s === "D12" || s === "N12") count12 += 1;
          });
        });
        if(count12){
          warnings.push(`Turnos de 12h usados: ${count12}.`);
        }
      }
    }else{
      CURRENT_SCHEDULE = {};
      CURRENT_COVER = {};
    }

    if(warnings.length){
      const warn = document.createElement("div");
      warn.className = "warning-box";
      warn.innerHTML = warnings.map(x => `• ${x}`).join("<br>");
      container.prepend(warn);
    }

    annualContainer.appendChild(createSummaryKpis(workers, annualTotals, `Resumen anual ${year}`, "kpi-annual", { showPay: config.showMonthlyPay, showHolidays: true, showLegend: true }));
    updateVacationModeClass();
    updateVacationStatus();
    saveConfig();
  }

  document.getElementById("render").addEventListener("click", render);
  document.getElementById("reset").addEventListener("click", resetCalendarAndVacations);
  document.getElementById("pattern").addEventListener("change", render);
  document.getElementById("year").addEventListener("input", render);
  document.getElementById("anchor").addEventListener("input", render);
  document.getElementById("print").addEventListener("click", () => window.print());
  const exportBtn = document.getElementById("export-config");
  const importBtn = document.getElementById("import-config");
  const importFile = document.getElementById("import-file");
  const copyLinkBtn = document.getElementById("copy-link");
  if(exportBtn){
    exportBtn.addEventListener("click", () => {
      const cfg = collectConfig();
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `calendario-config-${cfg.year || "config"}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }
  if(importBtn && importFile){
    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const cfg = JSON.parse(String(reader.result || "{}"));
          applyConfig(cfg);
          saveConfig();
          render();
        }catch(_e){
          alert("Archivo de configuración inválido.");
        }
        importFile.value = "";
      };
      reader.readAsText(file);
    });
  }
  if(copyLinkBtn){
    copyLinkBtn.addEventListener("click", () => {
      const cfg = collectConfig();
      let url = `${window.location.href.split("#")[0]}#cfg=${encodeConfig(cfg)}`;
      const copyOk = (navigator.clipboard && window.isSecureContext)
        ? navigator.clipboard.writeText(url).then(() => true, () => false)
        : Promise.resolve(false);
      copyOk.then((ok) => {
        if(!ok){
          window.prompt("Copia este enlace:", url);
        }else{
          copyLinkBtn.textContent = "Enlace copiado";
          setTimeout(() => { copyLinkBtn.textContent = "Copiar enlace"; }, 1200);
        }
      });
    });
  }
  document.querySelectorAll(".config-grid input, .config-grid textarea").forEach((el) => {
    el.addEventListener("input", render);
  });
  document.querySelectorAll("#config-modal .row input").forEach((el) => {
    el.addEventListener("input", render);
  });
  const vacMode = document.getElementById("vac-mode");
  const vacWorker = document.getElementById("vac-worker");
  const vacApply = document.getElementById("vac-apply");
  const vacCancel = document.getElementById("vac-cancel");
  if(vacMode){
    vacMode.addEventListener("change", () => {
      updateVacationModeClass();
      saveConfig();
    });
  }
  if(vacWorker){
    vacWorker.addEventListener("change", () => {
      saveConfig();
    });
  }
  if(vacApply){
    vacApply.addEventListener("click", () => {
      applyVacationsDraft();
      render();
    });
  }
  if(vacCancel){
    vacCancel.addEventListener("click", () => {
      resetVacationsDraft();
      render();
    });
  }
  const calendarEl = document.getElementById("calendar");
  if(calendarEl){
    calendarEl.addEventListener("click", (e) => {
      const cell = e.target.closest("td.cell");
      if(!cell) return;
      if(!document.getElementById("vac-mode")?.checked) return;
      if(!VACATIONS_ENABLED) return;
      const selected = Number(document.getElementById("vac-worker")?.value || "0");
      const workerIdx = Number(cell.dataset.worker || "0");
      if(workerIdx !== selected) return;
      const dateStr = cell.dataset.date;
      if(!dateStr) return;
      const changed = toggleVacation(dateStr, workerIdx);
      if(changed) render();
    });
  }
  const modal = document.getElementById("config-modal");
  const openConfig = document.getElementById("open-config");
  const closeConfig = document.getElementById("close-config");
  const closeModal = () => {
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };
  const openModal = () => {
    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  };
  if(openConfig && modal){
    openConfig.addEventListener("click", openModal);
  }
  if(closeConfig && modal){
    closeConfig.addEventListener("click", closeModal);
  }
  if(modal){
    modal.addEventListener("click", (e) => {
      if(e.target === modal) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && !modal.classList.contains("hidden")) closeModal();
    });
  }

  loadConfig();
  applyConfigFromHash();
  render();
</script>
</body>
</html>
