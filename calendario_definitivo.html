<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario 24/7 (5 trabajadores) — Vista tipo cuadrante</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap");

    :root{
      --ink:#0c0f14;
      --muted:#586173;
      --grid:#d7dbe2;
      --border:#cfd5df;
      --bg:#f3f1ec;
      --surface:rgba(255,255,255,0.88);
      --surface-strong:#ffffff;
      --accent:#0f6bff;

      /* Colores tipo cuadrante */
      --c-m:#ff6a5b;
      --c-t:#3da6ff;
      --c-n:#18b46b;
      --c-o:#e9ecf1;
      --c-v:#ffe8a3;
      --c-h:#f4f6fa;
      --c-weekend:#f5ede2;

      --radius:16px;
      --radius-lg:22px;
      --shadow-1:0 10px 30px rgba(15,23,42,0.08);
      --shadow-2:0 12px 40px rgba(15,23,42,0.12);
      --shadow-inset:inset 0 1px 0 rgba(255,255,255,0.8);
      --sidebar-w:min(560px, 94vw);
      --sidebar-h:min(72vh, 520px);
    }

    *{ box-sizing:border-box; }

    body{
      font-family:"Space Grotesk","Helvetica Neue",Arial,sans-serif;
      margin:0;
      background:linear-gradient(180deg, #f6f3ee 0%, #eef2f7 40%, #ffffff 100%);
      color:var(--ink);
      line-height:1.45;
    }

    body::before{
      content:"";
      position:fixed;
      inset:-20% -10% auto -10%;
      height:60%;
      background:
        radial-gradient(600px 300px at 10% 20%, rgba(255,106,91,0.18), transparent 60%),
        radial-gradient(540px 260px at 85% 10%, rgba(61,166,255,0.18), transparent 60%),
        radial-gradient(520px 240px at 60% 40%, rgba(24,180,107,0.14), transparent 65%);
      pointer-events:none;
      z-index:-1;
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      background-image:linear-gradient(120deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0) 45%);
      opacity:0.35;
      pointer-events:none;
      z-index:-2;
    }

    .page{
      max-width:1400px;
      margin:0 auto;
      padding:28px 24px 40px;
    }

    h1{
      font-family:"Fraunces","Times New Roman",serif;
      font-size:32px;
      margin:6px 0 6px;
      letter-spacing:0.2px;
    }

    .header-config{
      position:fixed;
      top:18px;
      right:22px;
      z-index:500;
    }
    .header-config .open-config-btn{
      border:1px solid rgba(15,23,42,0.12);
      background:rgba(255,255,255,0.7);
      color:#475467;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      cursor:pointer;
      box-shadow:var(--shadow-inset);
      backdrop-filter:blur(6px);
      transition:opacity .2s ease, transform .2s ease, background .2s ease;
    }
    .header-config .open-config-btn:hover{
      opacity:1;
      background:#fff;
      transform:translateY(-1px);
    }

    .topbar{
      position:sticky;
      top:12px;
      z-index:200;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:8px 0 12px;
      padding:8px 10px;
      border-radius:16px;
      background:rgba(255,255,255,0.9);
      border:1px solid rgba(15,23,42,0.08);
      box-shadow:var(--shadow-1);
      backdrop-filter:blur(6px);
    }
    .topbar-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .topbar .secondary{
      width:auto;
      padding:8px 12px;
      font-size:12px;
    }
    .topbar input,
    .topbar select{
      width:auto;
      min-width:160px;
      padding:8px 10px;
      font-size:12px;
    }
    .topbar-field{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .topbar-toggle{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:#344054;
      font-weight:600;
    }
    .save-status{
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      letter-spacing:0.2px;
      background:#eef2f7;
      color:#475467;
      border:1px solid rgba(15,23,42,0.08);
      white-space:nowrap;
    }
    .save-status.dirty{
      background:rgba(245,158,11,0.15);
      color:#92400e;
      border-color:rgba(245,158,11,0.3);
    }
    .save-status.clean{
      background:rgba(16,185,129,0.12);
      color:#065f46;
      border-color:rgba(16,185,129,0.28);
    }
    .toast{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%) translateY(-10px);
      background:#0f172a;
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      box-shadow:0 14px 36px rgba(15,23,42,0.22);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      z-index:1200;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }

    .sidebar{
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      width:var(--sidebar-w);
      background:linear-gradient(180deg, #f8fafc 0%, #ffffff 40%, #f6f7fb 100%);
      border-left:1px solid rgba(15,23,42,0.12);
      box-shadow:-14px 0 34px rgba(15,23,42,0.12);
      transform:translateX(100%);
      transition:transform .25s ease;
      z-index:999;
      overflow:hidden;
    }
    .sidebar.open{ transform:translateX(0); }
    .sidebar::before{
      content:"";
      position:absolute;
      inset:-20% -10% auto -10%;
      height:55%;
      background:
        radial-gradient(420px 240px at 10% 20%, rgba(15,107,255,0.12), transparent 60%),
        radial-gradient(360px 220px at 85% 10%, rgba(255,106,91,0.12), transparent 60%);
      pointer-events:none;
    }
    .modal-card{
      height:100%;
      overflow:auto;
      background:transparent;
      padding:16px 16px 26px;
      position:relative;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:0 0 14px;
      padding:4px 2px 10px;
      position:sticky;
      top:0;
      z-index:2;
      background:linear-gradient(180deg, rgba(248,250,252,0.98) 0%, rgba(248,250,252,0.7) 70%, rgba(248,250,252,0) 100%);
      backdrop-filter:blur(4px);
    }
    .modal-title{
      font-family:"Fraunces","Times New Roman",serif;
      font-size:17px;
      font-weight:700;
      color:#1f2937;
    }
    .modal-close{
      border:1px solid rgba(15,23,42,0.12);
      background:#fff;
      color:#1f2937;
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      cursor:pointer;
      box-shadow:var(--shadow-inset);
    }
    .modal-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .modal-grid{ grid-template-columns:1fr; }
    }
    .export-modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(15,23,42,0.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:1001;
    }
    .export-modal.open{
      opacity:1;
      pointer-events:auto;
    }
    .export-card{
      width:min(460px, 92vw);
      background:#fff;
      border-radius:16px;
      padding:16px;
      box-shadow:0 24px 60px rgba(15,23,42,0.28);
      border:1px solid rgba(15,23,42,0.12);
    }
    .export-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .export-actions{
      display:grid;
      gap:10px;
    }
    .export-actions button{
      width:100%;
    }
    .panel{
      border:none;
      border-radius:14px;
      padding:0;
      background:transparent;
      box-shadow:none;
    }
    .panel-title{
      font-size:12px;
      text-transform:none;
      letter-spacing:0;
      color:#0f172a;
      font-weight:700;
      margin:0;
    }
    .panel.is-collapsible > summary{
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,0.08);
      box-shadow:var(--shadow-inset);
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .panel.is-collapsible > summary:hover{
      border-color:rgba(15,23,42,0.18);
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
    }
    .panel.is-collapsible > summary::-webkit-details-marker{
      display:none;
    }
    .panel.is-collapsible .panel-title{
      cursor:pointer;
    }
    .panel.is-collapsible .panel-title::after{
      content:"";
    }
    .panel.is-collapsible > summary::after{
      content:"▾";
      font-size:12px;
      color:#64748b;
      transition:transform .2s ease;
    }
    .panel.is-collapsible[open] > summary::after{
      transform:rotate(180deg);
    }
    .panel-body{
      margin-top:8px;
      padding:12px;
      border-radius:12px;
      background:rgba(255,255,255,0.92);
      border:1px solid rgba(15,23,42,0.06);
      box-shadow:0 10px 22px rgba(15,23,42,0.06);
    }
    .panel-workers{
      grid-column:1 / -1;
    }
    .panel-workers .workers-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(110px, 1fr));
      gap:8px;
    }
    .panel-workers input{
      padding:6px 8px;
      font-size:12px;
    }
    .worker-pay{
      margin-top:12px;
      padding-top:12px;
      border-top:1px dashed rgba(15,23,42,0.12);
      display:grid;
      gap:10px;
    }
    .worker-pay-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .worker-pay-actions button{
      flex:1 1 160px;
    }
    details.deductions{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:12px;
      padding:8px 10px;
      background:rgba(248,250,252,0.9);
      box-shadow:var(--shadow-inset);
    }
    details.deductions summary{
      list-style:none;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      text-transform:none;
      letter-spacing:0;
      color:#475569;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    details.deductions summary::-webkit-details-marker{
      display:none;
    }
    details.deductions summary::after{
      content:"▾";
      font-size:12px;
      color:#94a3b8;
      transition:transform .2s ease;
    }
    details.deductions[open] summary::after{
      transform:rotate(180deg);
    }
    details.deductions .config-grid{
      margin-top:8px;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .worker-pay-panel{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:12px;
      padding:10px;
      background:rgba(255,255,255,0.95);
      display:grid;
      gap:10px;
      box-shadow:var(--shadow-inset);
    }
    details.pay-block{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:12px;
      padding:8px 10px;
      background:rgba(248,250,252,0.9);
      box-shadow:var(--shadow-inset);
    }
    details.pay-block summary{
      list-style:none;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      text-transform:none;
      letter-spacing:0;
      color:#475569;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    details.pay-block summary::-webkit-details-marker{
      display:none;
    }
    details.pay-block summary::after{
      content:"▾";
      font-size:12px;
      color:#94a3b8;
      transition:transform .2s ease;
    }
    details.pay-block[open] summary::after{
      transform:rotate(180deg);
    }
    details.pay-block .config-grid{
      margin-top:8px;
      gap:10px;
    }
    .panel-subtitle{
      font-size:12px;
      text-transform:none;
      letter-spacing:0;
      color:#475569;
      font-weight:700;
    }
    .modal-open{ overflow:hidden; }
    body.config-open .page{
      padding-right:calc(24px + var(--sidebar-w));
    }
    body.config-open .header-config{
      right:calc(22px + var(--sidebar-w));
    }

    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:0.2px;
      font-weight:600;
    }
    @media (max-width: 640px){
      h1{ font-size:26px; }
      .page{ padding:20px 16px 28px; }
    }
    @media (max-width: 640px){
      .topbar{
        position:static;
        padding:10px;
      }
      .topbar input,
      .topbar select{
        min-width:140px;
      }
      button, select, input{
        min-height:40px;
      }
    }
    @media (max-width: 1100px){
      body.config-open .page{
        padding-right:16px;
        padding-bottom:calc(24px + var(--sidebar-h));
      }
      body.config-open .header-config{
        right:16px;
      }
      .sidebar{
        top:auto;
        bottom:0;
        left:0;
        right:0;
        height:var(--sidebar-h);
        width:100%;
        border-left:none;
        border-top:1px solid rgba(15,23,42,0.12);
        border-radius:18px 18px 0 0;
        box-shadow:0 -14px 34px rgba(15,23,42,0.12);
        transform:translateY(100%);
      }
      .sidebar.open{
        transform:translateY(0);
      }
      .sidebar::before{
        inset:auto -10% -20% -10%;
        height:45%;
      }
      .modal-card{
        padding:14px 14px 22px;
      }
    }
    select, input, button{
      width:100%;
      padding:10px 12px;
      border:1px solid #cfd5df;
      border-radius:12px;
      font-size:14px;
      background:#fff;
      font-family:inherit;
      transition:border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    select, input{
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.8);
    }
    select:focus-visible, input:focus-visible, button:focus-visible{
      outline:2px solid rgba(15,107,255,0.25);
      outline-offset:2px;
      border-color:rgba(15,107,255,0.6);
    }
    button{
      background:linear-gradient(140deg, #111827 0%, #0f172a 100%);
      color:#fff;
      border-color:#0f172a;
      cursor:pointer;
      font-weight:600;
      letter-spacing:0.2px;
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 16px rgba(15,23,42,0.2);
    }
    button.secondary{
      background:#fff;
      color:#101828;
      border-color:#cfd5df;
    }
    button.secondary:hover{
      box-shadow:0 6px 14px rgba(15,23,42,0.12);
    }
    .sidebar select,
    .sidebar input,
    .sidebar textarea{
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
    }
    .sidebar button{
      font-size:12px;
      padding:8px 10px;
    }
    .sidebar .row.actions{
      gap:6px;
    }
    .sidebar .row.actions button{
      flex:1 1 120px;
    }
    .sidebar .config-grid{
      gap:8px 10px;
    }

    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .row > *{ flex:1 1 140px; }
    .row.actions{ margin-top:8px; }
    .hidden-file{ display:none; }
    .cloud-actions{
      align-items:center;
      margin-top:6px;
    }
    .cloud-actions button{
      flex:0 0 auto;
    }
    .cloud-status{
      font-size:11px;
      color:var(--muted);
      min-height:16px;
      display:flex;
      align-items:center;
      flex:1 1 auto;
    }
    .hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    .vac-controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      background:#f8fafc;
      border:1px solid rgba(15,23,42,0.08);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:none;
      margin-bottom:12px;
    }
    .vac-controls .vac-worker{
      min-width:200px;
      flex:0 0 auto;
    }
    .vac-controls .vac-worker label{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
    }
    .vac-controls .vac-hint{
      font-size:11px;
      color:var(--muted);
      flex:1 1 220px;
    }
    .vac-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .vac-actions button{
      padding:8px 12px;
      font-size:12px;
    }
    .vac-status{
      font-size:11px;
      color:#b45309;
      font-weight:600;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0 16px;
      font-size:12px;
      color:var(--muted);
      align-items:center;
    }
    .worker-filter{
      display:none;
      flex-wrap:nowrap;
      gap:8px;
      margin:8px 0 6px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .worker-filter button{
      padding:6px 12px;
      font-size:11px;
      border-radius:999px;
      background:#fff;
      border:1px solid #cfd5df;
      color:#111827;
      box-shadow:var(--shadow-inset);
      cursor:pointer;
    }
    .worker-filter button.active{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .swatch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border:1px solid #e2e6ee;
      border-radius:999px;
      background:var(--surface-strong);
      box-shadow:var(--shadow-inset);
    }
    .box{
      width:12px;
      height:12px;
      border:1px solid #0f172a;
      border-radius:3px;
    }
    .box.m{ background:var(--c-m); }
    .box.t{ background:var(--c-t); }
    .box.n{ background:var(--c-n); }
    .box.o{ background:var(--c-o); }
    .box.v{ background:var(--c-v); }
    .box.h{ background:linear-gradient(180deg, #fff4d6, #ffe0a8); border-color:#f59e0b; }
    .box.diff{ background:transparent; border:2px dashed rgba(99,102,241,0.65); }

    .month-wrap{
      border:1px solid #e1e5ee;
      border-radius:18px;
      overflow:hidden;
      margin-bottom:16px;
      background:var(--surface-strong);
      box-shadow:var(--shadow-1);
      animation:rise .6s ease both;
      animation-delay:calc(var(--i, 0) * 35ms);
    }
    .month-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      padding:12px 14px;
      background:linear-gradient(90deg, #f8f9fb 0%, #eef2f6 100%);
      border-bottom:1px solid #e1e5ee;
    }
    .month-title{ font-weight:700; font-size:16px; }

    .layout{
      display:grid;
      grid-template-columns:minmax(0, 1fr) 280px;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .layout{ grid-template-columns:1fr; }
      .layout.sidebar-collapsed{ grid-template-columns:1fr; }
      .annual-summary{ position:static; }
    }

    .annual-summary{
      position:sticky;
      top:18px;
      align-self:start;
    }
    .annual-summary .kpi-panel + .kpi-panel{
      margin-top:12px;
    }
    .annual-summary-toggle{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:18px;
      background:rgba(255,255,255,0.9);
      box-shadow:var(--shadow-1);
      padding:6px;
    }
    .annual-summary-toggle > summary{
      list-style:none;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      color:#0f172a;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#fff;
      border:1px solid rgba(15,23,42,0.08);
      box-shadow:var(--shadow-inset);
    }
    .annual-summary-toggle > summary::-webkit-details-marker{
      display:none;
    }
    .annual-summary-toggle > summary::after{
      content:"▾";
      font-size:12px;
      color:#64748b;
      transition:transform .2s ease;
    }
    .annual-summary-toggle[open] > summary::after{
      transform:rotate(180deg);
    }
    .annual-summary-toggle #annual-summary-panel{
      padding:8px 6px 6px;
    }
    .annual-summary-toggle[open] .kpi-panel.kpi-annual{
      box-shadow:none;
      border:none;
      background:transparent;
      padding:0 2px 4px;
    }

    .kpi-panel{
      background:#fbfcfe;
      padding:10px 12px 12px;
    }
    .kpi-panel.kpi-annual{
      border:1px solid rgba(15,23,42,0.08);
      border-radius:18px;
      background:rgba(255,255,255,0.92);
      box-shadow:var(--shadow-1);
      backdrop-filter:blur(6px);
      padding:10px 12px;
    }
    .kpi-title{
      font-size:12px;
      font-weight:700;
      color:#0f172a;
      margin-bottom:6px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(15,23,42,0.08);
    }
    .kpi-list{
      display:grid;
      gap:6px;
    }
    .kpi-row{
      display:grid;
      grid-template-columns:minmax(110px, 1fr) auto;
      gap:8px;
      align-items:center;
      padding:6px 8px;
      border-radius:10px;
      background:#fff;
      border:1px solid rgba(15,23,42,0.06);
      box-shadow:var(--shadow-inset);
      font-variant-numeric:tabular-nums;
    }
    .kpi-name{
      font-size:11px;
      font-weight:700;
      color:#1f2937;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .kpi-chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
      align-items:center;
    }
    .kpi-chip{
      min-width:48px;
      padding:4px 6px;
      border-radius:9px;
      background:#f8fafc;
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:var(--shadow-inset);
      text-align:center;
      flex:0 0 auto;
    }
    .kpi-chip.pay-gross{
      background:rgba(16,185,129,0.08);
      border-color:rgba(16,185,129,0.25);
    }
    .kpi-chip.pay-net{
      background:rgba(59,130,246,0.08);
      border-color:rgba(59,130,246,0.25);
    }
    .kpi-label{
      font-size:8px;
      font-weight:700;
      color:#64748b;
      display:block;
      line-height:1;
    }
    .kpi-value{
      font-size:11px;
      font-weight:700;
      display:block;
      margin-top:1px;
      color:#0f172a;
    }
    .kpi-legend{
      margin-top:6px;
      padding-top:6px;
      border-top:1px dashed rgba(15,23,42,0.12);
      font-size:9px;
      color:#64748b;
    }
    @media (max-width: 520px){
      .kpi-row{
        grid-template-columns:1fr;
        align-items:flex-start;
      }
      .kpi-chips{
        justify-content:flex-start;
      }
    }

    .name-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      width:100%;
      min-width:0;
    }
    .name-kpis{
      display:flex;
      align-items:center;
      gap:4px;
      padding:4px 6px;
      background:#eef2f7;
      border:1px solid #dbe2ee;
      border-radius:10px;
      white-space:normal;
      flex-wrap:wrap;
      max-width:100%;
      line-height:1;
      font-variant-numeric:tabular-nums;
    }
    .name-kpis-compact{
      display:none;
      font-size:10px;
      font-weight:700;
      color:#0f172a;
      text-align:center;
      line-height:1.2;
      letter-spacing:0.2px;
    }
    body.hide-gross .pay-gross{
      display:none !important;
    }
    body.hide-net .pay-net{
      display:none !important;
    }
    .name-kpis .mini{
      display:flex;
      align-items:baseline;
      gap:2px;
    }
    .name-kpis .mini-label{
      font-size:8px;
      font-weight:700;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .name-kpis .mini-label::after{
      content:":";
    }
    .name-kpis .mini-val{
      font-size:10px;
      font-weight:800;
      color:#1f2937;
    }
    .name-person{
      font-size:12px;
      font-weight:700;
      color:#0f172a;
      white-space:normal;
      word-break:break-word;
      min-width:0;
      flex:1 1 auto;
      text-align:center;
    }


    .config-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    .config-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .config-field label{
      font-size:11px;
      text-transform:none;
      letter-spacing:0;
      color:#667085;
      font-weight:600;
    }
    .config-field input,
    .config-field textarea{
      font-size:12px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.12);
      background:#fff;
      font-family:inherit;
    }
    .config-field textarea{
      min-height:70px;
      resize:vertical;
    }
    .config-span-2{
      grid-column:1 / -1;
    }
    .config-foot{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:#3a4250;
      font-weight:600;
    }
    .config-foot strong{
      font-size:13px;
      font-weight:800;
      color:#0f172a;
    }
    .config-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#3a4250;
    }
    #config-modal .row.actions{
      gap:6px;
    }
    #config-modal .row.actions button{
      padding:8px 10px;
      font-size:12px;
      border-radius:10px;
    }
    #config-modal .vac-controls{
      background:transparent;
      border:1px dashed rgba(15,23,42,0.12);
      box-shadow:none;
      padding:10px;
    }

    /* Vista tipo cuadrante: tabla ancha con scroll horizontal */
    .scroller{
      overflow:visible;
      background:#fff;
      position:relative;
    }
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      table-layout:fixed;
      border-left:1px solid var(--grid);
      border-top:1px solid var(--grid);
      font-variant-numeric:tabular-nums;
    }

    th, td{
      border-right:1px solid var(--grid);
      border-bottom:1px solid var(--grid);
      text-align:center;
      vertical-align:middle;
      padding:0 2px;
      height:32px;
      min-width:0;
      font-size:clamp(9px, 1.1vw, 11px);
      line-height:1.1;
      user-select:none;
    }

    /* Columna izquierda (nombres) fija */
    th.sticky, td.sticky{
      position:sticky;
      left:0;
      z-index:3;
      background:#fbfcfe;
      min-width:140px;
      width:140px;
      font-weight:700;
      box-shadow:2px 0 0 rgba(15,23,42,0.06);
      padding:6px 8px;
      white-space:normal;
      overflow:hidden;
      text-overflow:unset;
      height:auto;
    }
    th.sticky{ background:var(--c-h); z-index:4; }

    /* Cabeceras superiores fijas */
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--c-h);
      font-weight:700;
    }
    thead th.sticky{ z-index:5; }

    .dow{
      font-size:10px;
      color:#4b5563;
      font-weight:600;
      padding-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dom{
      font-size:11px;
      font-weight:800;
      padding-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Celdas turno */
    .cell{
      font-weight:700;
      color:#0b0d12;
      letter-spacing:0.2px;
      text-transform:uppercase;
    }
    .M{
      background:linear-gradient(180deg, rgba(255,106,91,0.9), rgba(255,106,91,0.75));
      color:#141414;
    }
    .T{
      background:linear-gradient(180deg, rgba(61,166,255,0.9), rgba(61,166,255,0.75));
      color:#091b2a;
    }
    .N{
      background:linear-gradient(180deg, rgba(24,180,107,0.9), rgba(24,180,107,0.72));
      color:#07160f;
    }
    .O{
      background:var(--c-o);
      color:#2b313b;
      font-weight:600;
    }
    .V{
      background:repeating-linear-gradient(135deg, #fff7d4, #fff7d4 6px, #ffe9ad 6px, #ffe9ad 12px);
      color:#5a4200;
      font-weight:700;
    }
    .holiday{
      outline:2px solid rgba(245,158,11,0.7);
      outline-offset:-2px;
    }
    .cell.cover{
      position:relative;
    }
    .cell.cover::after{
      content:"";
      position:absolute;
      top:4px;
      right:4px;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#111827;
      box-shadow:0 0 0 2px rgba(255,255,255,0.8);
    }
    body.hide-cover-dot .cell.cover::after{
      display:none;
    }
    .cell.diff{
      outline:2px dashed rgba(99,102,241,0.65);
      outline-offset:-2px;
    }

    /* Fines de semana con una leve marca (sin tapar color de turno) */
    .wknd{
      box-shadow:inset 0 0 0 9999px rgba(245,237,226,0.3);
    }
    @media (prefers-contrast: more){
      .M,.T,.N,.V{
        text-shadow:0 1px 0 rgba(255,255,255,0.45);
      }
      .holiday{
        outline:3px solid rgba(245,158,11,0.9);
      }
      .cell.diff{
        outline-width:3px;
      }
    }

    .month-mobile{
      display:none;
    }
    .worker-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      box-shadow:var(--shadow-1);
      display:grid;
      gap:6px;
    }
    .worker-hidden{
      display:none !important;
    }
    .worker-card-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .worker-name{
      font-weight:700;
      font-size:13px;
      color:#111827;
    }
    .worker-kpis{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
    }
    .kpi-collapse{
      border:1px solid rgba(15,23,42,0.1);
      border-radius:10px;
      padding:6px 8px;
      background:#f8fafc;
    }
    .kpi-collapse summary{
      list-style:none;
      cursor:pointer;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.4px;
      text-transform:uppercase;
      color:#475569;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .kpi-collapse summary::-webkit-details-marker{
      display:none;
    }
    .kpi-collapse summary::after{
      content:"+";
      font-size:12px;
      color:#94a3b8;
    }
    .kpi-collapse[open] summary::after{
      content:"-";
    }
    .kpi-collapse .worker-kpis{
      margin-top:6px;
      justify-content:flex-start;
    }
    .worker-kpis .mini{
      background:#eef2f7;
      border:1px solid #dbe2ee;
      border-radius:999px;
      padding:2px 6px;
      line-height:1;
    }
    .week-header{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:4px;
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.4px;
      color:var(--muted);
    }
    .weeks{
      display:grid;
      gap:6px;
    }
    .week-grid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:4px;
    }
    .day-pill{
      min-height:34px;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-weight:700;
      position:relative;
      font-size:11px;
      text-transform:uppercase;
    }
    .day-pill.empty{
      background:transparent;
      border:1px dashed rgba(15,23,42,0.12);
      color:transparent;
    }
    .day-pill .day-num{
      font-size:9px;
      opacity:0.7;
      line-height:1;
    }
    .day-pill .day-shift{
      font-size:12px;
      line-height:1.1;
    }
    .day-pill.cover::after{
      content:"";
      position:absolute;
      top:4px;
      right:4px;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#111827;
      box-shadow:0 0 0 2px rgba(255,255,255,0.8);
    }
    body.hide-cover-dot .day-pill.cover::after{
      display:none;
    }
    .day-pill.diff{
      outline:2px dashed rgba(99,102,241,0.65);
      outline-offset:-2px;
    }
    @media screen and (max-width: 900px){
      .month-wrap .scroller{ display:block; }
      .month-mobile{ display:none; }
      body.worker-filtered .month-wrap .scroller{ display:none; }
      body.worker-filtered .month-mobile{ display:grid; gap:12px; }
    }

    /* Export móvil */
    body.mobile-export .header-config{
      display:none !important;
    }
    body.mobile-export .topbar{
      display:none;
    }
    body.mobile-export #top-save-netlify{
      display:none !important;
    }
    body.mobile-export .worker-filter{
      display:flex;
    }
    body.mobile-export .layout{
      grid-template-columns:1fr;
    }
    body.mobile-export .annual-summary{
      position:static;
      margin-top:12px;
    }
    body.mobile-export .page{
      padding:16px 12px 22px;
    }
    body.mobile-export h1{
      font-size:20px;
    }
    body.mobile-export .legend{
      gap:6px;
      font-size:10px;
    }
    body.mobile-export .warning-box{
      display:none;
    }
    body.mobile-export .swatch{
      padding:4px 8px;
    }
    body.mobile-export th,
    body.mobile-export td{
      height:30px;
      font-size:10px;
      padding:0 2px;
    }
    body.mobile-export th.sticky,
    body.mobile-export td.sticky{
      position:sticky;
      min-width:120px;
      width:120px;
      box-shadow:2px 0 0 rgba(15,23,42,0.06);
    }
    body.mobile-export thead th{
      position:sticky;
    }
    body.mobile-export .name-kpis{
      display:none;
    }
    body.mobile-export .name-kpis-compact{
      display:block;
    }
    body.mobile-export .name-kpis .mini-label{
      font-size:7px;
    }
    body.mobile-export .name-kpis .mini-val{
      font-size:9px;
    }
    body.mobile-export .name-person{
      font-size:11px;
    }
    body.mobile-export #config-modal{
      position:static;
      transform:none;
      width:100%;
      height:auto;
      background:transparent;
      display:block;
      padding:0;
      margin:0 0 12px;
    }
    body.mobile-export #export-modal{
      display:none !important;
    }
    body.mobile-export #config-modal::before{
      display:none;
    }
    body.mobile-export #config-modal .modal-card{
      height:auto;
      border:none;
      border-radius:16px;
      box-shadow:var(--shadow-1);
    }
    body.mobile-export #config-modal .modal-head{
      display:none;
    }
    body.mobile-export #config-modal .panel:not(.panel-workers){
      display:none;
    }
    body.mobile-export #config-modal .panel-workers{
      display:block;
    }
    body.mobile-export #config-modal .panel-workers .workers-grid{
      display:none;
    }
    body.mobile-export .scroller{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    body.mobile-export table{
      min-width:900px;
    }

    tbody tr:hover td{
      background-image:linear-gradient(0deg, rgba(15,23,42,0.05), rgba(15,23,42,0.05));
    }

    #calendar.vac-active td.cell{
      cursor:pointer;
    }
    #calendar.vac-active td.cell:hover{
      outline:2px solid rgba(15,107,255,0.35);
      outline-offset:-2px;
    }
    #calendar.vac-active .day-pill{
      cursor:pointer;
    }
    #calendar.vac-active .day-pill:hover{
      outline:2px solid rgba(15,107,255,0.35);
      outline-offset:-2px;
    }
    #calendar.manual-active td.cell{
      cursor:pointer;
    }
    #calendar.manual-active td.cell:hover{
      outline:2px solid rgba(99,102,241,0.35);
      outline-offset:-2px;
    }
    #calendar.manual-active .day-pill{
      cursor:pointer;
    }
    #calendar.manual-active .day-pill:hover{
      outline:2px solid rgba(99,102,241,0.35);
      outline-offset:-2px;
    }
    .cell.manual{
      box-shadow:inset 0 0 0 2px rgba(99,102,241,0.6);
    }
    .day-pill.manual{
      box-shadow:inset 0 0 0 2px rgba(99,102,241,0.6);
    }

    .cell span{
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .warning-box{
      margin:10px 0 14px;
      color:#7a1f1f;
      font-size:12px;
      background:rgba(255, 231, 231, 0.65);
      border:1px solid rgba(185,28,28,0.25);
      border-radius:14px;
      padding:10px 12px;
      line-height:1.4;
    }

    @keyframes rise{
      from{ opacity:0; transform:translateY(10px); }
      to{ opacity:1; transform:translateY(0); }
    }

    @media (prefers-reduced-motion: reduce){
      .month-wrap{ animation:none; }
      button{ transition:none; }
    }

    @media print{
      body{
        background:#fff;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      body::before, body::after{ display:none; }
      .vac-controls, .legend{ display:none; }
      #config-modal{ display:none !important; }
      .page{ padding:0; }
      .month-wrap{ break-inside:avoid; box-shadow:none; border-color:#ccc; }
      .scroller{ overflow:visible; }
      table{ min-width:unset; width:100%; }
      th, td{ min-width:unset; height:28px; font-size:10px; }
      .annual-summary{ position:static; }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Calendario TVAC</h1>

    <div class="header-config">
      <button id="open-config" class="open-config-btn" type="button">Configurar</button>
    </div>

    <div class="topbar">
      <div class="topbar-group">
        <button id="go-today" class="secondary" type="button">Mes actual</button>
        <div class="topbar-field">
          <input id="worker-search" type="text" placeholder="Buscar trabajador…" list="worker-list" />
          <datalist id="worker-list"></datalist>
        </div>
        <label class="topbar-toggle">
          <input id="focus-mode" type="checkbox" />
          Foco
        </label>
        <select id="worker-focus"></select>
      </div>
      <div class="topbar-group">
        <button id="top-save-netlify" class="secondary" type="button">Guardar</button>
        <span id="save-status" class="save-status">Guardado</span>
      </div>
    </div>

    <div id="config-modal" class="sidebar" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="config-title">
        <div class="modal-head">
          <div id="config-title" class="modal-title">Configuración de trabajadores y sueldos</div>
          <button id="close-config" class="modal-close" type="button">Cerrar</button>
        </div>
        <div class="modal-grid">
          <details class="panel is-collapsible" open>
            <summary class="panel-title">Calendario</summary>
            <div class="panel-body">
              <div class="row">
                <div class="field">
                  <label for="pattern">Ciclo (fijo 6-4)</label>
                  <select id="pattern">
                    <option value="">Cargando opciones…</option>
                  </select>
                </div>
                <div class="field">
                  <label for="year">Año</label>
                  <input id="year" type="number" min="2000" max="2100" value="2026" />
                </div>
                <div class="field">
                  <label for="anchor">Ancla (Día 1 del ciclo)</label>
                  <input id="anchor" type="date" value="2026-01-01" />
                </div>
              </div>
              <div class="row actions">
                <button id="render">Generar</button>
                <button class="secondary" id="reset">Resetear</button>
                <button class="secondary" id="undo-change">Deshacer</button>
                <button class="secondary" id="redo-change">Rehacer</button>
                <button class="secondary" id="print">Imprimir</button>
                <button class="secondary" id="import-config">Importar</button>
                <button class="secondary" id="open-exports">Exportaciones</button>
                <input id="import-file" class="hidden-file" type="file" accept="application/json" />
              </div>
              <div class="row">
                <label class="config-toggle">
                  <input id="show-cover-dot" type="checkbox" checked />
                  Mostrar punto en días ajustados
                </label>
                <label class="config-toggle">
                  <input id="show-diff" type="checkbox" />
                  Comparar con calendario base
                </label>
              </div>
              <div class="config-grid">
                <div class="config-field config-span-2">
                  <label for="holiday-list">Festivos (YYYY-MM-DD, uno por línea)</label>
                  <textarea id="holiday-list" placeholder="2026-01-01&#10;2026-01-06"></textarea>
                </div>
              </div>
              <div class="config-grid">
                <div class="config-field config-span-2">
                  <div class="panel-subtitle">Nube (Netlify DB)</div>
                </div>
                <div class="config-field">
                  <label for="netlify-id">ID</label>
                  <input id="netlify-id" type="text" value="shared" />
                </div>
                <div class="config-field config-span-2">
                  <div class="hint">Disponible cuando el calendario está publicado en Netlify o ejecutando netlify dev.</div>
                </div>
              </div>
              <div class="row cloud-actions">
                <button class="secondary" id="netlify-load" type="button">Cargar Netlify DB</button>
                <button class="secondary" id="netlify-save" type="button">Guardar Netlify DB</button>
                <span id="netlify-status" class="cloud-status"></span>
              </div>
            </div>
          </details>
          <details class="panel is-collapsible" open>
            <summary class="panel-title">Vacaciones</summary>
            <div class="panel-body">
              <div class="vac-controls">
                <label class="config-toggle">
                  <input id="vac-mode" type="checkbox" />
                  Modo vacaciones
                </label>
                <div class="vac-worker">
                  <label for="vac-worker">Trabajador</label>
                  <select id="vac-worker"></select>
                </div>
                <div class="vac-actions">
                  <button id="vac-apply" type="button">Aplicar</button>
                  <button id="vac-cancel" type="button" class="secondary">Cancelar</button>
                </div>
                <div id="vac-status" class="vac-status"></div>
                <div class="vac-hint">Click en los días del trabajador seleccionado para marcar V (incluye libres). Pulsa Aplicar para recalcular.</div>
              </div>
            </div>
          </details>
          <details class="panel is-collapsible">
            <summary class="panel-title">Edición manual</summary>
            <div class="panel-body">
              <div class="vac-controls">
                <label class="config-toggle">
                  <input id="manual-mode" type="checkbox" />
                  Modo manual
                </label>
                <div class="vac-worker">
                  <label for="manual-worker">Trabajador</label>
                  <select id="manual-worker"></select>
                </div>
                <div class="vac-worker">
                  <label for="manual-shift">Turno</label>
                  <select id="manual-shift">
                    <option value="M">Mañana</option>
                    <option value="T">Tarde</option>
                    <option value="N">Noche</option>
                    <option value="O">Libre</option>
                  </select>
                </div>
                <div class="vac-hint">Click en los días del trabajador seleccionado para aplicar el turno. Alt+click borra el cambio. Ctrl+Z / Ctrl+Y deshace/rehace.</div>
              </div>
            </div>
          </details>
          <details class="panel is-collapsible panel-workers">
            <summary class="panel-title">Trabajadores</summary>
            <div class="panel-body">
              <div class="workers-grid">
                <input id="w1" value="Raul" />
                <input id="w2" value="Jose" />
                <input id="w3" value="David" />
                <input id="w4" value="Ivan" />
                <input id="w5" value="Andres" />
              </div>
              <div class="worker-pay">
                <div class="field">
                  <label for="salary-worker">Configurar sueldo de</label>
                  <select id="salary-worker"></select>
                </div>
                <div class="worker-pay-actions">
                  <button type="button" class="secondary" id="pay-defaults">Valores por defecto</button>
                  <button type="button" class="secondary" id="pay-copy-all">Copiar a todos</button>
                </div>
                <div id="worker-pay-panel" class="worker-pay-panel" hidden>
                  <details class="pay-block">
                    <summary>Sueldo y extras</summary>
                    <div class="config-grid">
                      <div class="config-field">
                        <label for="base-monthly">Base mensual</label>
                        <input class="pay-input" id="base-monthly" type="number" step="0.01" value="926.96" />
                      </div>
                      <div class="config-field">
                        <label for="extra-prorrateo">Prorrateo extra</label>
                        <input class="pay-input" id="extra-prorrateo" type="number" step="0.01" value="154.49" />
                      </div>
                      <div class="config-field">
                        <label for="comp-1">Complemento 1</label>
                        <input class="pay-input" id="comp-1" type="number" step="0.01" value="91.96" />
                      </div>
                      <div class="config-field">
                        <label for="comp-2">Complemento 2</label>
                        <input class="pay-input" id="comp-2" type="number" step="0.01" value="207.79" />
                      </div>
                      <div class="config-field">
                        <label for="turnicidad">Turnicidad</label>
                        <input class="pay-input" id="turnicidad" type="number" step="0.01" value="110" />
                      </div>
                      <div class="config-field">
                        <label for="hours-per-shift">Horas por turno</label>
                        <input class="pay-input" id="hours-per-shift" type="number" step="0.25" value="8" />
                      </div>
                      <div class="config-field">
                        <label for="hourly-rate">Precio hora</label>
                        <input class="pay-input" id="hourly-rate" type="number" step="0.01" value="9.25" />
                      </div>
                      <div class="config-field">
                        <label for="night-mult">Plus noche (x)</label>
                        <input class="pay-input" id="night-mult" type="number" step="0.01" value="0.6" />
                      </div>
                      <div class="config-field">
                        <label for="weekend-mult">Plus finde (x)</label>
                        <input class="pay-input" id="weekend-mult" type="number" step="0.01" value="1" />
                      </div>
                      <div class="config-field">
                        <label for="holiday-mult">Plus festivo (x)</label>
                        <input class="pay-input" id="holiday-mult" type="number" step="0.01" value="2" />
                      </div>
                      <div class="config-field config-span-2">
                        <details class="deductions">
                          <summary>Deducciones (avanzado)</summary>
                          <div class="config-grid">
                            <div class="config-field">
                              <label for="cc-percent">Contingencias comunes</label>
                              <input class="pay-input" id="cc-percent" type="number" step="0.01" value="4.7" />
                            </div>
                            <div class="config-field">
                              <label for="unemp-percent">Desempleo</label>
                              <input class="pay-input" id="unemp-percent" type="number" step="0.01" value="1.55" />
                            </div>
                            <div class="config-field">
                              <label for="training-percent">Formación prof.</label>
                              <input class="pay-input" id="training-percent" type="number" step="0.01" value="0.1" />
                            </div>
                            <div class="config-field">
                              <label for="equity-percent">Mecanismo equidad</label>
                              <input class="pay-input" id="equity-percent" type="number" step="0.01" value="0.13" />
                            </div>
                            <div class="config-field">
                              <label for="irpf-percent">IRPF</label>
                              <input class="pay-input" id="irpf-percent" type="number" step="0.01" value="15" />
                            </div>
                          </div>
                        </details>
                      </div>
                      <div class="config-field config-span-2">
                        <label class="config-toggle">
                          <input id="show-monthly-pay" type="checkbox" />
                          Mostrar sueldo mensual en el cuadrante
                        </label>
                      </div>
                      <div class="config-field config-span-2">
                        <label class="config-toggle">
                          <input id="show-net-pay" type="checkbox" />
                          Mostrar sueldo neto en el cuadrante
                        </label>
                      </div>
                    </div>
                  </details>
                  <div class="config-foot">
                    <span>Fijo mensual</span>
                    <strong id="fixed-total">€0,00</strong>
                  </div>
                </div>
              </div>
            </div>
          </details>
        </div>
      </div>
    </div>

    <div id="export-modal" class="export-modal" aria-hidden="true">
      <div class="export-card" role="dialog" aria-modal="true" aria-labelledby="export-title">
        <div class="export-head">
          <div id="export-title" class="modal-title">Exportaciones</div>
          <button id="close-export" class="modal-close" type="button">Cerrar</button>
        </div>
        <div class="export-actions">
          <button class="secondary" id="export-config">Exportar configuración</button>
          <button class="secondary" id="export-html">Exportar HTML</button>
          <button class="secondary" id="export-drive">Exportar a Drive</button>
          <button class="secondary" id="export-netlify">Publicar en Netlify</button>
          <button class="secondary" id="export-pdf">Exportar PDF</button>
        </div>
      </div>
    </div>

    <div id="worker-filter" class="worker-filter"></div>
    <div class="legend">
      <span class="swatch"><span class="box m"></span> M · Mañana (06-14)</span>
      <span class="swatch"><span class="box t"></span> T · Tarde (14-22)</span>
      <span class="swatch"><span class="box n"></span> N · Noche (22-06)</span>
      <span class="swatch"><span class="box o"></span> O · Libre</span>
      <span class="swatch"><span class="box v"></span> V · Vacaciones</span>
      <span class="swatch"><span class="box h"></span> H · Festivo</span>
      <span class="swatch"><span class="box diff"></span> Δ · Cambio</span>
    </div>

    <div class="layout">
      <div id="calendar"></div>
      <aside class="annual-summary">
        <details id="annual-summary-toggle" class="annual-summary-toggle" open>
          <summary>Resumen anual</summary>
          <div id="annual-summary-panel"></div>
        </details>
      </aside>
    </div>

  </div>

  <div id="toast" class="toast" aria-live="polite"></div>

<script id="tvac-app">
  // ====== Opciones de patrón (para 1 persona) + offsets para 5 ======
  // Construidas para que cada día haya exactamente: 1M, 1T, 1N, 2O.
  // Además, por diseño:
  // - T->M solo ocurre tras al menos 2 "O" (descanso).
  // - N->M solo ocurre tras al menos 3 "O" (descanso).
  // (Al usar descansos largos post-bloque y rotación progresiva).
  const OPTIONS = {
    "D": {
      type: "offset",
      name: "6-4 (MMTTNNOOOO)",
      cycleLen: 10,
      pattern: [
        ...Array(4).fill("O"),
        ...Array(2).fill("M"),
        ...Array(2).fill("T"),
        ...Array(2).fill("N"),
      ],
      offsets: [8, 6, 4, 2, 0],
    },
  };

  const MONTHS_ES = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  const DOW_ES = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
  const WORKER_COUNT = 5;
  const DEFAULT_PAY_CONFIG = {
    base: 926.96,
    extra: 154.49,
    comp1: 91.96,
    comp2: 207.79,
    turnicidad: 110,
    hours: 8,
    hourly: 9.25,
    nightMult: 0.6,
    weekendMult: 1,
    holidayMult: 2,
    ccPercent: 4.7,
    unempPercent: 1.55,
    trainingPercent: 0.1,
    equityPercent: 0.13,
    irpfPercent: 15,
  };
  const ALLOWED_ADJ = new Set(["M->M","M->T","T->T","T->N","N->N"]);
  const MAX_SAME_RUN = 2;
  const MAX_WORK_RUN = 6;
  const MIN_REST_RUN = 3;
  const MAX_REST_RUN = 4;
  let PAY_CONFIGS = Array.from({ length: WORKER_COUNT }, () => ({ ...DEFAULT_PAY_CONFIG }));
  let SELECTED_PAY_WORKER = 0;
  let VACATIONS_APPLIED = {};
  let VACATIONS_DRAFT = {};
  let VACATIONS_ENABLED = true;
  let MANUAL_OVERRIDES = {};
  const MANUAL_SHIFTS = new Set(["M","T","N","O"]);
  let VAC_HISTORY = [];
  let VAC_REDO = [];
  const VAC_HISTORY_LIMIT = 200;
  let MANUAL_HISTORY = [];
  let MANUAL_REDO = [];
  const MANUAL_HISTORY_LIMIT = 200;
  let GLOBAL_HISTORY = [];
  let GLOBAL_REDO = [];
  const GLOBAL_HISTORY_LIMIT = 300;
  let CURRENT_WORKER_FILTER = "all";
  let CURRENT_WORKERS = [];
  let NETLIFY_DB_AUTO_LOADED = false;
  let NETLIFY_DB_LOADED = false;
  let IS_DIRTY = false;
  let SUPPRESS_DIRTY = false;
  let FOCUS_MODE = false;
  const FOCUS_KEY = "tvacFocusMode";
  const ANNUAL_TOGGLE_KEY = "tvacAnnualSummaryOpen";
  let CURRENT_SCHEDULE = {};
  let CURRENT_COVER = {};

  function parseDateLocal(yyyy_mm_dd){
    const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  }
  function fmt2(n){ return String(n).padStart(2,"0"); }
  function toISO(date){
    return `${date.getFullYear()}-${fmt2(date.getMonth()+1)}-${fmt2(date.getDate())}`;
  }
  function getYearDates(year){
    const dates = [];
    const start = new Date(year, 0, 1);
    const end = new Date(year, 11, 31);
    for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
      dates.push(new Date(d));
    }
    return dates;
  }
  function numValue(id, fallback = 0){
    const raw = document.getElementById(id).value.trim().replace(",", ".");
    const val = parseFloat(raw);
    return Number.isFinite(val) ? val : fallback;
  }
  function toNumber(value, fallback = 0){
    const raw = String(value ?? "").trim().replace(",", ".");
    const val = parseFloat(raw);
    return Number.isFinite(val) ? val : fallback;
  }
  const STORAGE_KEY = "tvacCalendarConfigV1";
  const FILTER_KEY = "tvacWorkerFilter";
  function formatMoneyShort(value){
    return `€${Math.round(value).toLocaleString("es-ES")}`;
  }
  function formatMoneyFull(value){
    return new Intl.NumberFormat("es-ES", {
      style: "currency",
      currency: "EUR",
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }).format(value);
  }
  function formatCount(value){
    const num = Number(value);
    if(!Number.isFinite(num)) return value;
    if(Number.isInteger(num)) return String(num);
    return num.toLocaleString("es-ES", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  }
  function formatWorkWithVacations(work, vacations){
    const workStr = formatCount(work);
    if(!vacations) return workStr;
    return `${workStr}+${vacations}V`;
  }

  function buildMiniKpis(items){
    return items.map((item) => {
      const titleAttr = item.title ? ` title="${item.title}"` : "";
      const extraClass = item.className ? ` ${item.className}` : "";
      return `<span class="mini${extraClass}"${titleAttr}><span class="mini-label">${item.label}</span><span class="mini-val">${item.value}</span></span>`;
    }).join("");
  }

  function normalizeVacations(raw, workerCount){
    const out = {};
    if(!raw || typeof raw !== "object") return out;
    Object.entries(raw).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      const norm = Array.from({length: workerCount}, (_, i) => Boolean(arr[i]));
      if(norm.some(Boolean)) out[date] = norm;
    });
    return out;
  }
  function cloneVacations(map){
    const out = {};
    if(!map || typeof map !== "object") return out;
    Object.entries(map).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      out[date] = arr.map(Boolean);
    });
    return out;
  }
  function vacationsEqual(a, b){
    const aKeys = Object.keys(a || {});
    const bKeys = Object.keys(b || {});
    if(aKeys.length !== bKeys.length) return false;
    for(const key of aKeys){
      const aRow = a[key] || [];
      const bRow = b[key] || [];
      for(let i=0; i<WORKER_COUNT; i++){
        if(Boolean(aRow[i]) !== Boolean(bRow[i])) return false;
      }
    }
    return true;
  }
  function manualOverridesEqual(a, b){
    const aKeys = Object.keys(a || {});
    const bKeys = Object.keys(b || {});
    if(aKeys.length !== bKeys.length) return false;
    for(const key of aKeys){
      const aRow = a[key] || [];
      const bRow = b[key] || [];
      for(let i=0; i<WORKER_COUNT; i++){
        const aVal = MANUAL_SHIFTS.has(aRow[i]) ? aRow[i] : null;
        const bVal = MANUAL_SHIFTS.has(bRow[i]) ? bRow[i] : null;
        if(aVal !== bVal) return false;
      }
    }
    return true;
  }
  function normalizeManualOverrides(raw, workerCount){
    const out = {};
    if(!raw || typeof raw !== "object") return out;
    Object.entries(raw).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      const norm = Array.from({ length: workerCount }, (_, i) => {
        const val = arr[i];
        return MANUAL_SHIFTS.has(val) ? val : null;
      });
      if(norm.some((v) => MANUAL_SHIFTS.has(v))) out[date] = norm;
    });
    return out;
  }
  function cloneManualOverrides(map){
    const out = {};
    if(!map || typeof map !== "object") return out;
    Object.entries(map).forEach(([date, arr]) => {
      if(!Array.isArray(arr)) return;
      out[date] = arr.map((val) => (MANUAL_SHIFTS.has(val) ? val : null));
    });
    return out;
  }
  function getManualOverride(map, dateStr, wIdx){
    const row = map && map[dateStr];
    const val = row ? row[wIdx] : null;
    return MANUAL_SHIFTS.has(val) ? val : "";
  }
  function setManualOverride(map, dateStr, wIdx, value){
    const row = Array.isArray(map[dateStr])
      ? map[dateStr].slice()
      : Array.from({ length: WORKER_COUNT }, () => null);
    row[wIdx] = MANUAL_SHIFTS.has(value) ? value : null;
    if(row.some((v) => MANUAL_SHIFTS.has(v))){
      map[dateStr] = row;
    }else{
      delete map[dateStr];
    }
  }
  function hasPendingVacations(){
    if(!VACATIONS_ENABLED) return false;
    return !vacationsEqual(VACATIONS_APPLIED, VACATIONS_DRAFT);
  }
  function hasAppliedVacationsForYear(year){
    return Object.keys(VACATIONS_APPLIED || {}).some((iso) => {
      if(!iso.startsWith(`${year}-`)) return false;
      return Array.isArray(VACATIONS_APPLIED[iso]) && VACATIONS_APPLIED[iso].some(Boolean);
    });
  }
  function getVacation(map, dateStr, wIdx){
    return !!(map[dateStr] && map[dateStr][wIdx]);
  }
  function setVacation(map, dateStr, wIdx, value){
    const row = Array.isArray(map[dateStr])
      ? map[dateStr].slice()
      : Array.from({length: WORKER_COUNT}, () => false);
    row[wIdx] = Boolean(value);
    if(row.some(Boolean)){
      map[dateStr] = row;
    }else{
      delete map[dateStr];
    }
  }
  function toggleVacation(dateStr, wIdx){
    if(getVacation(VACATIONS_DRAFT, dateStr, wIdx)){
      setVacation(VACATIONS_DRAFT, dateStr, wIdx, false);
      pushGlobalHistory();
      return true;
    }
    setVacation(VACATIONS_DRAFT, dateStr, wIdx, true);
    pushGlobalHistory();
    return true;
  }
  function getVacationDisplay(dateStr, wIdx){
    if(!VACATIONS_ENABLED) return false;
    return getVacation(VACATIONS_DRAFT, dateStr, wIdx);
  }
  function applyVacationsDraft(){
    VACATIONS_APPLIED = cloneVacations(VACATIONS_DRAFT);
    pushGlobalHistory();
  }
  function resetVacationsDraft(){
    VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
    pushGlobalHistory();
  }
  function initVacationHistory(){
    VAC_HISTORY = [cloneVacations(VACATIONS_DRAFT)];
    VAC_REDO = [];
  }
  function pushVacationHistory(){
    if(!VACATIONS_ENABLED) return;
    const snapshot = cloneVacations(VACATIONS_DRAFT);
    const last = VAC_HISTORY[VAC_HISTORY.length - 1];
    if(last && vacationsEqual(last, snapshot)) return;
    VAC_HISTORY.push(snapshot);
    if(VAC_HISTORY.length > VAC_HISTORY_LIMIT) VAC_HISTORY.shift();
    VAC_REDO = [];
  }
  function undoVacationChange(){
    if(!VACATIONS_ENABLED) return false;
    if(VAC_HISTORY.length <= 1) return false;
    const current = VAC_HISTORY.pop();
    VAC_REDO.push(current);
    const prev = VAC_HISTORY[VAC_HISTORY.length - 1];
    VACATIONS_DRAFT = cloneVacations(prev);
    return true;
  }
  function redoVacationChange(){
    if(!VACATIONS_ENABLED) return false;
    if(!VAC_REDO.length) return false;
    const next = VAC_REDO.pop();
    VAC_HISTORY.push(cloneVacations(next));
    VACATIONS_DRAFT = cloneVacations(next);
    return true;
  }
  function initManualHistory(){
    MANUAL_HISTORY = [cloneManualOverrides(MANUAL_OVERRIDES)];
    MANUAL_REDO = [];
  }
  function pushManualHistory(){
    const snapshot = cloneManualOverrides(MANUAL_OVERRIDES);
    const last = MANUAL_HISTORY[MANUAL_HISTORY.length - 1];
    if(last && manualOverridesEqual(last, snapshot)) return;
    MANUAL_HISTORY.push(snapshot);
    if(MANUAL_HISTORY.length > MANUAL_HISTORY_LIMIT) MANUAL_HISTORY.shift();
    MANUAL_REDO = [];
  }
  function undoManualChange(){
    if(MANUAL_HISTORY.length <= 1) return false;
    const current = MANUAL_HISTORY.pop();
    MANUAL_REDO.push(current);
    const prev = MANUAL_HISTORY[MANUAL_HISTORY.length - 1];
    MANUAL_OVERRIDES = cloneManualOverrides(prev);
    return true;
  }
  function redoManualChange(){
    if(!MANUAL_REDO.length) return false;
    const next = MANUAL_REDO.pop();
    MANUAL_HISTORY.push(cloneManualOverrides(next));
    MANUAL_OVERRIDES = cloneManualOverrides(next);
    return true;
  }
  function globalSnapshot(){
    return {
      vacationsDraft: cloneVacations(VACATIONS_DRAFT),
      vacationsApplied: cloneVacations(VACATIONS_APPLIED),
      manualOverrides: cloneManualOverrides(MANUAL_OVERRIDES),
    };
  }
  function globalEqual(a, b){
    if(!a || !b) return false;
    if(!vacationsEqual(a.vacationsDraft || {}, b.vacationsDraft || {})) return false;
    if(!vacationsEqual(a.vacationsApplied || {}, b.vacationsApplied || {})) return false;
    if(!manualOverridesEqual(a.manualOverrides || {}, b.manualOverrides || {})) return false;
    return true;
  }
  function applyGlobalSnapshot(snapshot){
    if(!snapshot) return;
    VACATIONS_DRAFT = cloneVacations(snapshot.vacationsDraft || {});
    VACATIONS_APPLIED = cloneVacations(snapshot.vacationsApplied || {});
    MANUAL_OVERRIDES = cloneManualOverrides(snapshot.manualOverrides || {});
  }
  function updateHistoryButtons(){
    const undoBtn = document.getElementById("undo-change");
    const redoBtn = document.getElementById("redo-change");
    if(undoBtn) undoBtn.disabled = GLOBAL_HISTORY.length <= 1;
    if(redoBtn) redoBtn.disabled = GLOBAL_REDO.length === 0;
  }
  function initGlobalHistory(){
    GLOBAL_HISTORY = [globalSnapshot()];
    GLOBAL_REDO = [];
    updateHistoryButtons();
  }
  function pushGlobalHistory(){
    if(!GLOBAL_HISTORY.length){
      initGlobalHistory();
      return;
    }
    const snapshot = globalSnapshot();
    const last = GLOBAL_HISTORY[GLOBAL_HISTORY.length - 1];
    if(last && globalEqual(last, snapshot)) return;
    GLOBAL_HISTORY.push(snapshot);
    if(GLOBAL_HISTORY.length > GLOBAL_HISTORY_LIMIT) GLOBAL_HISTORY.shift();
    GLOBAL_REDO = [];
    updateHistoryButtons();
  }
  function undoGlobalChange(){
    if(GLOBAL_HISTORY.length <= 1) return false;
    const current = GLOBAL_HISTORY.pop();
    GLOBAL_REDO.push(current);
    const prev = GLOBAL_HISTORY[GLOBAL_HISTORY.length - 1];
    applyGlobalSnapshot(prev);
    updateHistoryButtons();
    return true;
  }
  function redoGlobalChange(){
    if(!GLOBAL_REDO.length) return false;
    const next = GLOBAL_REDO.pop();
    GLOBAL_HISTORY.push(next);
    applyGlobalSnapshot(next);
    updateHistoryButtons();
    return true;
  }
  function updateVacationStatus(){
    const status = document.getElementById("vac-status");
    const applyBtn = document.getElementById("vac-apply");
    const cancelBtn = document.getElementById("vac-cancel");
    const pending = hasPendingVacations();
    if(status){
      if(!VACATIONS_ENABLED){
        status.textContent = "Vacaciones solo disponibles en ciclo 6-4.";
      }else{
        status.textContent = pending ? "Pendiente de aplicar" : "";
      }
    }
    if(applyBtn) applyBtn.disabled = !pending;
    if(cancelBtn) cancelBtn.disabled = !pending;
  }
  function updateVacationAvailability(enabled){
    const vacMode = document.getElementById("vac-mode");
    const vacWorker = document.getElementById("vac-worker");
    const vacApply = document.getElementById("vac-apply");
    const vacCancel = document.getElementById("vac-cancel");
    const status = document.getElementById("vac-status");
    if(vacMode) vacMode.disabled = !enabled;
    if(vacWorker) vacWorker.disabled = !enabled;
    if(vacApply) vacApply.disabled = !enabled;
    if(vacCancel) vacCancel.disabled = !enabled;
    if(status && !enabled){
      status.textContent = "Vacaciones solo disponibles en ciclo 6-4.";
    }
  }

  function resetCalendarAndVacations(){
    VACATIONS_APPLIED = {};
    VACATIONS_DRAFT = {};
    MANUAL_OVERRIDES = {};
    initGlobalHistory();
    const vacMode = document.getElementById("vac-mode");
    if(vacMode) vacMode.checked = false;
    saveConfig();
    setDirty(true);
    render();
  }

  function coverageWarnings(year, schedule, opt, anchor, workerCount){
    const misses = [];
    const dates = getYearDates(year);
    dates.forEach((date) => {
      const iso = toISO(date);
      const counts = { M:0, T:0, N:0 };
      for(let wIdx=0; wIdx<workerCount; wIdx++){
        const raw = resolveShift(date, iso, wIdx, opt, anchor, schedule);
        const s = (raw === "V" || raw === undefined || raw === null) ? "O" : raw;
        if(s === "M" || s === "T" || s === "N") counts[s] += 1;
      }
      if(!(counts.M >= 1 && counts.T >= 1 && counts.N >= 1)){
        const missing = ["M","T","N"].filter((k) => counts[k] < 1);
        misses.push(`${iso} sin cobertura (${missing.join("/")})`);
      }
    });
    return misses;
  }
  function syncVacationWorkers(workers){
    const select = document.getElementById("vac-worker");
    if(!select) return;
    const pref = select.dataset.pref;
    const current = select.value;
    select.innerHTML = "";
    workers.forEach((name, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = name;
      select.appendChild(opt);
    });
    const desired = (pref !== undefined && pref !== null && pref !== "") ? pref : current;
    if(desired !== undefined && desired !== null && desired !== ""){
      if(select.querySelector(`option[value="${desired}"]`)){
        select.value = desired;
      }
    }
    select.dataset.pref = "";
  }
  function syncManualWorkers(workers){
    const select = document.getElementById("manual-worker");
    if(!select) return;
    const pref = select.dataset.pref;
    const current = select.value;
    select.innerHTML = "";
    workers.forEach((name, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = name;
      select.appendChild(opt);
    });
    const desired = (pref !== undefined && pref !== null && pref !== "") ? pref : current;
    if(desired !== undefined && desired !== null && desired !== ""){
      if(select.querySelector(`option[value="${desired}"]`)){
        select.value = desired;
      }
    }
    select.dataset.pref = "";
  }
  function syncSalaryWorkers(workers){
    const select = document.getElementById("salary-worker");
    if(!select) return;
    const pref = select.dataset.pref;
    const current = select.value;
    select.innerHTML = "";
    workers.forEach((name, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = name;
      select.appendChild(opt);
    });
    const desired = (pref !== undefined && pref !== null && pref !== "") ? pref : current;
    if(desired !== undefined && desired !== null && desired !== ""){
      if(select.querySelector(`option[value="${desired}"]`)){
        select.value = desired;
      }
    }else if(select.options.length){
      select.value = select.options[0].value;
    }
    select.dataset.pref = "";
    updateSalaryPanel();
  }
  function renderWorkerFilterButtons(workers){
    const wrap = document.getElementById("worker-filter");
    if(!wrap) return;
    if(!document.body.classList.contains("mobile-export")){
      wrap.innerHTML = "";
      return;
    }
    wrap.innerHTML = "";
    const makeBtn = (label, value) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = label;
      btn.dataset.filter = value;
      if(String(CURRENT_WORKER_FILTER) === String(value)) btn.classList.add("active");
      btn.addEventListener("click", () => setWorkerFilter(value));
      return btn;
    };
    wrap.appendChild(makeBtn("Todos", "all"));
    workers.forEach((name, idx) => {
      wrap.appendChild(makeBtn(name || `Trabajador ${idx+1}`, String(idx)));
    });
  }
  function applyWorkerFilter(){
    const isMobile = document.body.classList.contains("mobile-export");
    const filter = (!isMobile && !FOCUS_MODE) ? "all" : CURRENT_WORKER_FILTER;
    const rows = document.querySelectorAll("#calendar tr[data-worker]");
    const cards = document.querySelectorAll("#calendar .worker-card[data-worker]");
    const hide = (el) => el.classList.add("worker-hidden");
    const show = (el) => el.classList.remove("worker-hidden");
    if(filter === "all" || filter === null || filter === undefined || filter === ""){
      document.body.classList.remove("worker-filtered");
      rows.forEach(show);
      cards.forEach(show);
      return;
    }
    document.body.classList.add("worker-filtered");
    rows.forEach((row) => (row.dataset.worker === String(filter) ? show(row) : hide(row)));
    cards.forEach((card) => (card.dataset.worker === String(filter) ? show(card) : hide(card)));
  }
  function setWorkerFilter(value){
    CURRENT_WORKER_FILTER = value;
    try{
      localStorage.setItem(FILTER_KEY, String(value));
    }catch(_e){}
    const buttons = document.querySelectorAll("#worker-filter button");
    buttons.forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.filter === String(value));
    });
    applyWorkerFilter();
  }
  function syncFocusControls(workers){
    const select = document.getElementById("worker-focus");
    const list = document.getElementById("worker-list");
    if(select){
      const current = select.value || "all";
      select.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "Todos";
      select.appendChild(allOpt);
      workers.forEach((name, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = name || `Trabajador ${idx+1}`;
        select.appendChild(opt);
      });
      select.value = String(CURRENT_WORKER_FILTER || current);
      select.disabled = !FOCUS_MODE;
    }
    if(list){
      list.innerHTML = "";
      workers.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        list.appendChild(opt);
      });
    }
  }
  function loadWorkerFilter(){
    try{
      const stored = localStorage.getItem(FILTER_KEY);
      if(stored !== null && stored !== undefined && stored !== ""){
        CURRENT_WORKER_FILTER = stored;
      }
    }catch(_e){}
  }
  function loadFocusMode(){
    try{
      FOCUS_MODE = localStorage.getItem(FOCUS_KEY) === "1";
    }catch(_e){}
    const toggle = document.getElementById("focus-mode");
    if(toggle) toggle.checked = FOCUS_MODE;
    const select = document.getElementById("worker-focus");
    if(select) select.disabled = !FOCUS_MODE;
  }
  function renderLegend(usage, showDiff){
    const legend = document.querySelector(".legend");
    if(!legend) return;
    const items = [];
    const add = (cls, label) => {
      items.push(`<span class="swatch"><span class="box ${cls}"></span> ${label}</span>`);
    };
    if(usage.M) add("m", "M · Mañana (06-14)");
    if(usage.T) add("t", "T · Tarde (14-22)");
    if(usage.N) add("n", "N · Noche (22-06)");
    if(usage.O) add("o", "O · Libre");
    if(usage.V) add("v", "V · Vacaciones");
    if(usage.H) add("h", "H · Festivo");
    if(showDiff && usage.Diff) add("diff", "Δ · Cambio");
    legend.innerHTML = items.join("");
    legend.style.display = items.length ? "flex" : "none";
  }
  function updateSalaryPanel(){
    const panel = document.getElementById("worker-pay-panel");
    const select = document.getElementById("salary-worker");
    if(!panel || !select) return;
    const idx = Number(select.value);
    if(!Number.isFinite(idx)){
      panel.hidden = true;
      return;
    }
    panel.hidden = false;
    SELECTED_PAY_WORKER = idx;
    writePayInputs(PAY_CONFIGS[idx] || DEFAULT_PAY_CONFIG);
    updateFixedTotal(getPayConfigForWorker(idx));
  }
  function updateVacationModeClass(){
    const cal = document.getElementById("calendar");
    const enabled = document.getElementById("vac-mode")?.checked;
    if(cal) cal.classList.toggle("vac-active", !!enabled);
  }
  function updateManualModeClass(){
    const cal = document.getElementById("calendar");
    const enabled = document.getElementById("manual-mode")?.checked;
    if(cal) cal.classList.toggle("manual-active", !!enabled);
  }
  function shiftInfo(shift){
    if(shift === "M") return { type:"M", isWork:true, isNight:false, short:"M", full:"Mañana" };
    if(shift === "T") return { type:"T", isWork:true, isNight:false, short:"T", full:"Tarde" };
    if(shift === "N") return { type:"N", isWork:true, isNight:true, short:"N", full:"Noche" };
    if(shift === "V") return { type:"O", isWork:false, isNight:false, short:"V", full:"Vacaciones" };
    return { type:"O", isWork:false, isNight:false, short:"O", full:"Libre" };
  }
  function isWorkShift(s){
    return shiftInfo(s).isWork;
  }
  function expectedShiftFromPos(pos){
    if(pos <= 1) return "M";
    if(pos <= 3) return "T";
    return "N";
  }
  function primeValidationState(state, startDate, daysBack, opt, anchor, workers){
    for(let i = daysBack; i >= 1; i--){
      const d = new Date(startDate);
      d.setDate(d.getDate() - i);
      for(let wIdx = 0; wIdx < workers.length; wIdx++){
        const s = stateFor(wIdx, d, opt, anchor);
        const info = shiftInfo(s);
        if(info.isWork){
          state[wIdx].seqPos = state[wIdx].seqPos === -1 ? 1 : state[wIdx].seqPos + 1;
        }else{
          state[wIdx].seqPos = -1;
        }
        applyShiftToState(state[wIdx], s);
      }
    }
  }
  function dayIndexFromAnchor(date, anchor){
    const ms = 24*60*60*1000;
    const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
    const utcAnchor = Date.UTC(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());
    return Math.floor((utcDate - utcAnchor) / ms);
  }

  function stateFor(workerIdx, date, opt, anchor){
    const idx = ((dayIndexFromAnchor(date, anchor) % opt.cycleLen) + opt.cycleLen) % opt.cycleLen;
    if(opt.type === "matrix"){
      return opt.cycle[idx][workerIdx];
    }
    return opt.pattern[(idx + opt.offsets[workerIdx]) % opt.cycleLen];
  }
  function resolveShift(date, iso, wIdx, opt, anchor, schedule){
    if(getVacationDisplay(iso, wIdx)) return "V";
    const manual = getManualOverride(MANUAL_OVERRIDES, iso, wIdx);
    if(manual) return manual;
    if(schedule && schedule[iso] && schedule[iso][wIdx]) return schedule[iso][wIdx];
    return stateFor(wIdx, date, opt, anchor);
  }

  function isWeekend(date){
    // JS: 0=Dom,6=Sáb
    const d = date.getDay();
    return d === 0 || d === 6;
  }

  function parseHolidayList(raw){
    const set = new Set();
    raw.split(/[\s,;]+/).forEach((token) => {
      if(/^\d{4}-\d{2}-\d{2}$/.test(token)) set.add(token);
    });
    return set;
  }

  function canAssignShift(st, shift){
    const info = shiftInfo(shift);
    if(!info.isWork) return true;
    const type = info.type;
    if(st.lastShift !== "O"){
      if(st.workRun >= MAX_WORK_RUN) return false;
      const key = `${st.lastShift}->${type}`;
      if(!ALLOWED_ADJ.has(key)) return false;
      const workRun = st.workRun + 1;
      const sameRun = (st.lastShift === type) ? st.sameRun + 1 : 1;
      if(workRun > MAX_WORK_RUN) return false;
      if(sameRun > MAX_SAME_RUN) return false;
      if(info.isNight){
        const nightRun = (st.lastShift === "N") ? st.nightRun + 1 : 1;
        if(nightRun > MAX_SAME_RUN) return false;
      }
    }else{
      if(st.lastWork !== null){
        if(st.restRun < MIN_REST_RUN) return false;
        if(st.lastWork === "N" && type === "M" && st.restRun < MIN_REST_RUN) return false;
        if(st.lastWork === "T" && type === "M" && st.restRun < MIN_REST_RUN) return false;
      }
    }
    return true;
  }

  function applyShiftToState(st, shift){
    const info = shiftInfo(shift);
    if(info.isWork){
      if(st.lastShift !== "O"){
        st.workRun += 1;
        st.sameRun = (st.lastShift === info.type) ? st.sameRun + 1 : 1;
      }else{
        st.workRun = 1;
        st.sameRun = 1;
      }
      if(info.isNight){
        st.nightRun = (st.lastShift === "N") ? st.nightRun + 1 : 1;
      }else{
        st.nightRun = 0;
      }
      st.lastShift = info.type;
      st.lastWork = info.type;
      st.restRun = 0;
    }else{
      st.restRun = st.lastShift === "O" ? st.restRun + 1 : 1;
      st.lastShift = "O";
      st.workRun = 0;
      st.sameRun = 0;
      st.nightRun = 0;
    }
  }

  function normalizePayConfig(cfg){
    return {
      base: toNumber(cfg?.base, DEFAULT_PAY_CONFIG.base),
      extra: toNumber(cfg?.extra, DEFAULT_PAY_CONFIG.extra),
      comp1: toNumber(cfg?.comp1, DEFAULT_PAY_CONFIG.comp1),
      comp2: toNumber(cfg?.comp2, DEFAULT_PAY_CONFIG.comp2),
      turnicidad: toNumber(cfg?.turnicidad, DEFAULT_PAY_CONFIG.turnicidad),
      hours: toNumber(cfg?.hours, DEFAULT_PAY_CONFIG.hours),
      hourly: toNumber(cfg?.hourly, DEFAULT_PAY_CONFIG.hourly),
      nightMult: toNumber(cfg?.nightMult, DEFAULT_PAY_CONFIG.nightMult),
      weekendMult: toNumber(cfg?.weekendMult, DEFAULT_PAY_CONFIG.weekendMult),
      holidayMult: toNumber(cfg?.holidayMult, DEFAULT_PAY_CONFIG.holidayMult),
      ccPercent: toNumber(cfg?.ccPercent, DEFAULT_PAY_CONFIG.ccPercent),
      unempPercent: toNumber(cfg?.unempPercent, DEFAULT_PAY_CONFIG.unempPercent),
      trainingPercent: toNumber(cfg?.trainingPercent, DEFAULT_PAY_CONFIG.trainingPercent),
      equityPercent: toNumber(cfg?.equityPercent, DEFAULT_PAY_CONFIG.equityPercent),
      irpfPercent: toNumber(cfg?.irpfPercent, DEFAULT_PAY_CONFIG.irpfPercent),
    };
  }
  function readPayInputs(){
    return {
      base: numValue("base-monthly", DEFAULT_PAY_CONFIG.base),
      extra: numValue("extra-prorrateo", DEFAULT_PAY_CONFIG.extra),
      comp1: numValue("comp-1", DEFAULT_PAY_CONFIG.comp1),
      comp2: numValue("comp-2", DEFAULT_PAY_CONFIG.comp2),
      turnicidad: numValue("turnicidad", DEFAULT_PAY_CONFIG.turnicidad),
      hours: numValue("hours-per-shift", DEFAULT_PAY_CONFIG.hours),
      hourly: numValue("hourly-rate", DEFAULT_PAY_CONFIG.hourly),
      nightMult: numValue("night-mult", DEFAULT_PAY_CONFIG.nightMult),
      weekendMult: numValue("weekend-mult", DEFAULT_PAY_CONFIG.weekendMult),
      holidayMult: numValue("holiday-mult", DEFAULT_PAY_CONFIG.holidayMult),
      ccPercent: numValue("cc-percent", DEFAULT_PAY_CONFIG.ccPercent),
      unempPercent: numValue("unemp-percent", DEFAULT_PAY_CONFIG.unempPercent),
      trainingPercent: numValue("training-percent", DEFAULT_PAY_CONFIG.trainingPercent),
      equityPercent: numValue("equity-percent", DEFAULT_PAY_CONFIG.equityPercent),
      irpfPercent: numValue("irpf-percent", DEFAULT_PAY_CONFIG.irpfPercent),
    };
  }
  function writePayInputs(cfg){
    const data = normalizePayConfig(cfg);
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(el) el.value = String(val);
    };
    setVal("base-monthly", data.base);
    setVal("extra-prorrateo", data.extra);
    setVal("comp-1", data.comp1);
    setVal("comp-2", data.comp2);
    setVal("turnicidad", data.turnicidad);
    setVal("hours-per-shift", data.hours);
    setVal("hourly-rate", data.hourly);
    setVal("night-mult", data.nightMult);
    setVal("weekend-mult", data.weekendMult);
    setVal("holiday-mult", data.holidayMult);
    setVal("cc-percent", data.ccPercent);
    setVal("unemp-percent", data.unempPercent);
    setVal("training-percent", data.trainingPercent);
    setVal("equity-percent", data.equityPercent);
    setVal("irpf-percent", data.irpfPercent);
  }
  function getPayConfigForWorker(wIdx){
    const cfg = normalizePayConfig(PAY_CONFIGS[wIdx] || DEFAULT_PAY_CONFIG);
    const fixed = cfg.base + cfg.extra + cfg.comp1 + cfg.comp2 + cfg.turnicidad;
    return { ...cfg, fixed };
  }
  function prime6x2State(state, startDate, daysBack, opt, anchor, workers){
    for(let i = daysBack; i >= 1; i--){
      const d = new Date(startDate);
      d.setDate(d.getDate() - i);
      for(let wIdx = 0; wIdx < workers.length; wIdx++){
        const shift = stateFor(wIdx, d, opt, anchor);
        const st = state[wIdx];
        if(shift === "O"){
          const wasRest = st.phase === -1;
          st.phase = -1;
          st.restRun = wasRest ? st.restRun + 1 : 1;
        }else{
          const phaseNow = st.phase === -1 ? 0 : st.phase;
          const nextPhase = phaseNow + 1;
          if(nextPhase >= 6){
            st.phase = -1;
            st.restRun = 0;
          }else{
            st.phase = nextPhase;
            st.restRun = 0;
          }
        }
      }
    }
  }

  function buildScheduleWithVacations(year, opt, anchor, workers, options = {}){
    if(!opt){
      return { schedule: {}, cover: {}, warnings: ["No hay opción de ciclo válida."] };
    }
    const workerCount = workers.length;
    const dates = getYearDates(year);
    const base = {};
    dates.forEach((date) => {
      const iso = toISO(date);
      base[iso] = workers.map((_, wIdx) => stateFor(wIdx, date, opt, anchor));
    });

    const activeVac = VACATIONS_ENABLED ? VACATIONS_APPLIED : {};
    const vacDates = Object.keys(activeVac).filter((iso) => iso.startsWith(`${year}-`) && activeVac[iso]?.some(Boolean));
    if(!vacDates.length){
      return { schedule: base, cover: {}, warnings: [] };
    }

    const allowAdjust = options.adjust6x2 && opt.cycleLen === 10;
    if(!allowAdjust){
      const schedule = {};
      dates.forEach((date) => {
        const iso = toISO(date);
        const row = base[iso].slice();
        if(activeVac[iso]){
          activeVac[iso].forEach((isVac, wIdx) => {
            if(isVac) row[wIdx] = "V";
          });
        }
        schedule[iso] = row;
      });
      return { schedule, cover: {}, warnings: [] };
    }

    const seqShift = (phase) => (phase <= 1 ? "M" : phase <= 3 ? "T" : "N");
    const hasVacInNext6 = (wIdx, dayIdx) => {
      for(let i=0; i<6; i++){
        const idx = dayIdx + i;
        if(idx >= dates.length) break;
        const iso = toISO(dates[idx]);
        if(activeVac[iso]?.[wIdx]) return true;
      }
      return false;
    };

    const initState = Array.from({length: workerCount}, () => ({ phase: -1, restRun: 0 }));
    prime6x2State(initState, dates[0], 20, opt, anchor, workers);

    let beam = [{
      cost: 0,
      state: initState,
      schedule: {},
      cover: {},
    }];

    const beamWidth = options.beamWidth ?? 12;
    const dayPenalty = (assigned, baseShift) => {
      if(assigned === baseShift) return 0;
      if(assigned === "O" && baseShift !== "O") return 1.2;
      if(assigned !== "O" && baseShift === "O") return 0.9;
      return 1.5;
    };

    for(let dayIdx = 0; dayIdx < dates.length; dayIdx++){
      const iso = toISO(dates[dayIdx]);
      const baseRow = base[iso];
      const vacRow = activeVac[iso] || [];
      const next = [];
      const bestBySig = new Map();

      beam.forEach((cand) => {
        const assignments = Array(workerCount).fill("O");
        const counts = { M:0, T:0, N:0 };
        let invalid = false;

        for(let wIdx = 0; wIdx < workerCount; wIdx++){
          const st = cand.state[wIdx];
          const isVac = Boolean(vacRow[wIdx]);
          if(isVac){
            assignments[wIdx] = "V";
            continue;
          }
          if(st.phase >= 0){
            const s = seqShift(st.phase);
            assignments[wIdx] = s;
            counts[s] += 1;
          }
        }
        if(invalid) return;
        if(counts.M > 1 || counts.T > 1 || counts.N > 1) return;
        if(counts.T !== 1 || counts.N !== 1) return;

        const needM = counts.M === 0;
        const starters = [];
        if(needM){
          for(let wIdx = 0; wIdx < workerCount; wIdx++){
            const st = cand.state[wIdx];
            if(assignments[wIdx] !== "O") continue;
            if(st.restRun < 2) continue;
            if(hasVacInNext6(wIdx, dayIdx)) continue;
            starters.push(wIdx);
          }
          if(!starters.length) return;
        }

        const tryAdd = (starterIdx) => {
          const plan = assignments.slice();
          const startSet = new Set();
          if(starterIdx !== null){
            plan[starterIdx] = "M";
            startSet.add(starterIdx);
          }
          const newState = cand.state.map((st) => ({ ...st }));
          const coverRow = [];
          let cost = cand.cost;
          let invalidPlan = false;

          for(let wIdx = 0; wIdx < workerCount; wIdx++){
            const assigned = plan[wIdx];
            const baseShift = baseRow[wIdx];
            const isVac = Boolean(vacRow[wIdx]);
            if(!isVac) cost += dayPenalty(assigned, baseShift);
            if(!isVac && baseShift === "O" && (assigned === "M" || assigned === "T" || assigned === "N")){
              coverRow.push(wIdx);
            }

            const st = newState[wIdx];
            const wasRest = st.phase === -1;
            const prevRest = st.restRun;

            if(assigned === "M" || assigned === "T" || assigned === "N"){
              const started = startSet.has(wIdx);
              const phaseNow = started ? 0 : st.phase;
              const nextPhase = phaseNow + 1;
              if(nextPhase >= 6){
                st.phase = -1;
                st.restRun = 0;
              }else{
                st.phase = nextPhase;
                st.restRun = 0;
              }
              if(started){
                const restPenalty = Math.max(0, 2 - prevRest);
                if(restPenalty > 0) cost += restPenalty * 0.8;
              }
            }else{
              if(!isVac && wasRest && prevRest >= MAX_REST_RUN){
                invalidPlan = true;
                break;
              }
              st.phase = -1;
              st.restRun = wasRest ? prevRest + 1 : 1;
            }
          }
          if(invalidPlan) return;

          const newSchedule = { ...cand.schedule, [iso]: plan };
          const newCover = coverRow.length ? { ...cand.cover, [iso]: coverRow } : cand.cover;
          const sig = newState.map((s) => `${s.phase}:${s.restRun}`).join("|");
          const existing = bestBySig.get(sig);
          if(existing && existing.cost <= cost) return;
          const nextCand = { cost, state: newState, schedule: newSchedule, cover: newCover };
          bestBySig.set(sig, nextCand);
          next.push(nextCand);
        };

        if(!needM){
          tryAdd(null);
        }else{
          starters.forEach((starterIdx) => tryAdd(starterIdx));
        }
      });

      if(!next.length){
        const fallback = {};
        dates.forEach((date) => {
          const fallbackIso = toISO(date);
          const row = base[fallbackIso].slice();
          if(activeVac[fallbackIso]){
            activeVac[fallbackIso].forEach((isVac, wIdx) => {
              if(isVac) row[wIdx] = "V";
            });
          }
          fallback[fallbackIso] = row;
        });
        return { schedule: fallback, cover: {}, warnings: [`No hay solución válida desde ${iso}.`] };
      }

      next.sort((a, b) => a.cost - b.cost);
      beam = next.slice(0, beamWidth);
    }

    const best = beam[0];
    return { schedule: best.schedule, cover: best.cover || {}, warnings: [] };
  }

  function collectConfig(){
    if(Number.isFinite(SELECTED_PAY_WORKER)){
      PAY_CONFIGS[SELECTED_PAY_WORKER] = readPayInputs();
    }
    return {
      pattern: document.getElementById("pattern")?.value || "",
      year: document.getElementById("year")?.value || "",
      anchor: document.getElementById("anchor")?.value || "",
      w1: document.getElementById("w1")?.value || "",
      w2: document.getElementById("w2")?.value || "",
      w3: document.getElementById("w3")?.value || "",
      w4: document.getElementById("w4")?.value || "",
      w5: document.getElementById("w5")?.value || "",
      holidayList: document.getElementById("holiday-list")?.value || "",
      netlifyId: document.getElementById("netlify-id")?.value || "",
      payByWorker: PAY_CONFIGS.map((cfg) => ({ ...cfg })),
      salaryWorker: document.getElementById("salary-worker")?.value || "0",
      showMonthlyPay: document.getElementById("show-monthly-pay")?.checked || false,
      showNetPay: document.getElementById("show-net-pay")?.checked || false,
      showCoverDot: document.getElementById("show-cover-dot")?.checked !== false,
      showDiff: document.getElementById("show-diff")?.checked || false,
      vacMode: document.getElementById("vac-mode")?.checked || false,
      vacWorker: document.getElementById("vac-worker")?.value || "0",
      manualMode: document.getElementById("manual-mode")?.checked || false,
      manualWorker: document.getElementById("manual-worker")?.value || "0",
      manualShift: document.getElementById("manual-shift")?.value || "M",
      vacationsApplied: VACATIONS_APPLIED,
      vacationsDraft: VACATIONS_DRAFT,
      manualOverrides: MANUAL_OVERRIDES,
    };
  }

  function applyConfig(cfg){
    if(!cfg || typeof cfg !== "object") return;
    SUPPRESS_DIRTY = true;
    if(cfg.year && document.getElementById("year")) document.getElementById("year").value = cfg.year;
    if(cfg.anchor && document.getElementById("anchor")) document.getElementById("anchor").value = cfg.anchor;
    if(cfg.pattern){
      const select = document.getElementById("pattern");
      if(select) select.dataset.pref = cfg.pattern;
    }

    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(el && val !== undefined && val !== null && val !== "") el.value = val;
    };
    setVal("w1", cfg.w1);
    setVal("w2", cfg.w2);
    setVal("w3", cfg.w3);
    setVal("w4", cfg.w4);
    setVal("w5", cfg.w5);
    setVal("holiday-list", cfg.holidayList);
    setVal("netlify-id", cfg.netlifyId);

    const setChecked = (id, val) => {
      const el = document.getElementById(id);
      if(el && typeof val === "boolean") el.checked = val;
    };
    setChecked("show-monthly-pay", cfg.showMonthlyPay);
    setChecked("show-net-pay", cfg.showNetPay);
    setChecked("show-cover-dot", cfg.showCoverDot);
    setChecked("show-diff", cfg.showDiff);
    setChecked("vac-mode", cfg.vacMode);
    setChecked("manual-mode", cfg.manualMode);
    if(cfg.vacMode && cfg.manualMode){
      setChecked("manual-mode", false);
    }
    setVal("manual-shift", cfg.manualShift);
    if(cfg.salaryWorker !== undefined && cfg.salaryWorker !== null){
      const salarySelect = document.getElementById("salary-worker");
      if(salarySelect) salarySelect.dataset.pref = String(cfg.salaryWorker);
    }
    if(cfg.vacWorker !== undefined && cfg.vacWorker !== null){
      const select = document.getElementById("vac-worker");
      if(select) select.dataset.pref = String(cfg.vacWorker);
    }
    if(cfg.manualWorker !== undefined && cfg.manualWorker !== null){
      const select = document.getElementById("manual-worker");
      if(select) select.dataset.pref = String(cfg.manualWorker);
    }
    if(Array.isArray(cfg.payByWorker)){
      PAY_CONFIGS = cfg.payByWorker.map(normalizePayConfig);
    }else{
      const legacy = normalizePayConfig({
        base: cfg.baseMonthly,
        extra: cfg.extraProrrateo,
        comp1: cfg.comp1,
        comp2: cfg.comp2,
        turnicidad: cfg.turnicidad,
        hours: cfg.hoursPerShift,
        hourly: cfg.hourlyRate,
        nightMult: cfg.nightMult,
        weekendMult: cfg.weekendMult,
        holidayMult: cfg.holidayMult,
      });
      PAY_CONFIGS = Array.from({ length: WORKER_COUNT }, () => ({ ...legacy }));
    }
    if(PAY_CONFIGS.length < WORKER_COUNT){
      for(let i = PAY_CONFIGS.length; i < WORKER_COUNT; i++){
        PAY_CONFIGS.push({ ...DEFAULT_PAY_CONFIG });
      }
    }else if(PAY_CONFIGS.length > WORKER_COUNT){
      PAY_CONFIGS = PAY_CONFIGS.slice(0, WORKER_COUNT);
    }
    if(cfg.vacationsApplied && typeof cfg.vacationsApplied === "object"){
      VACATIONS_APPLIED = normalizeVacations(cfg.vacationsApplied, WORKER_COUNT);
    }
    if(cfg.vacationsDraft && typeof cfg.vacationsDraft === "object"){
      VACATIONS_DRAFT = normalizeVacations(cfg.vacationsDraft, WORKER_COUNT);
    }else{
      VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
    }
    if(cfg.manualOverrides && typeof cfg.manualOverrides === "object"){
      MANUAL_OVERRIDES = normalizeManualOverrides(cfg.manualOverrides, WORKER_COUNT);
    }else{
      MANUAL_OVERRIDES = {};
    }
    updateCoverDotVisibility();
    initGlobalHistory();
    SUPPRESS_DIRTY = false;
    setDirty(false);
  }

  function saveConfig(){
    const cfg = collectConfig();
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }catch(_e){}
  }

  function loadConfig(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const cfg = JSON.parse(raw);
      applyConfig(cfg);
    }catch(_e){}
  }

  function getNetlifySettings(){
    const id = (document.getElementById("netlify-id")?.value || "shared").trim();
    return { id };
  }
  function updateSaveStatus(){
    const el = document.getElementById("save-status");
    if(!el) return;
    el.textContent = IS_DIRTY ? "Cambios sin guardar" : "Guardado";
    el.classList.toggle("dirty", IS_DIRTY);
    el.classList.toggle("clean", !IS_DIRTY);
  }
  function setDirty(flag){
    if(SUPPRESS_DIRTY) return;
    IS_DIRTY = !!flag;
    updateSaveStatus();
  }
  function showToast(message){
    const toast = document.getElementById("toast");
    if(!toast) return;
    toast.textContent = message;
    toast.classList.add("show");
    clearTimeout(showToast._timer);
    showToast._timer = setTimeout(() => toast.classList.remove("show"), 1800);
  }
  function setNetlifyStatus(msg, isError = false){
    const el = document.getElementById("netlify-status");
    if(!el) return;
    el.textContent = msg || "";
    el.style.color = isError ? "#b91c1c" : "";
  }
  async function netlifyRequest(path, options = {}){
    return fetch(`/.netlify/functions/${path}`, options);
  }
  async function saveToNetlifyDb({ silent = false } = {}){
    const { id } = getNetlifySettings();
    if(!silent) setNetlifyStatus("Guardando…");
    try{
      const res = await netlifyRequest("save-config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, data: collectConfig() }),
      });
      if(!res.ok){
        if(res.status === 404){
          if(!silent) setNetlifyStatus("Netlify DB no disponible aquí.", true);
          return false;
        }
        if(res.status === 501 || res.status === 405){
          if(!silent) setNetlifyStatus("Netlify DB solo funciona en Netlify o con netlify dev.", true);
          return false;
        }
        const txt = await res.text();
        if(!silent) setNetlifyStatus(`Error: ${txt}`, true);
        return false;
      }
      if(!silent){
        setNetlifyStatus("Guardado");
        setTimeout(() => setNetlifyStatus(""), 2000);
      }
      setDirty(false);
      return true;
    }catch(err){
      if(!silent) setNetlifyStatus("No se pudo conectar a Netlify DB.", true);
      return false;
    }
  }
  async function loadFromNetlifyDb({ silent = false } = {}){
    const { id } = getNetlifySettings();
    if(!silent) setNetlifyStatus("Cargando…");
    try{
      const res = await netlifyRequest(`load-config?id=${encodeURIComponent(id)}`, { method: "GET" });
      if(!res.ok){
        if(res.status === 404){
          if(!silent) setNetlifyStatus("Netlify DB no disponible aquí.", true);
          return false;
        }
        if(res.status === 501 || res.status === 405){
          if(!silent) setNetlifyStatus("Netlify DB solo funciona en Netlify o con netlify dev.", true);
          return false;
        }
        const txt = await res.text();
        if(!silent) setNetlifyStatus(`Error: ${txt}`, true);
        return false;
      }
      const payload = await res.json();
      if(!payload || !payload.data){
        if(!silent) setNetlifyStatus("Sin datos en Netlify DB.");
        return false;
      }
      applyConfig(payload.data);
      saveConfig();
      render();
      NETLIFY_DB_LOADED = true;
      setDirty(false);
      if(!silent){
        setNetlifyStatus("Cargado");
        setTimeout(() => setNetlifyStatus(""), 2000);
      }
      return true;
    }catch(err){
      if(!silent) setNetlifyStatus("No se pudo conectar a Netlify DB.", true);
      return false;
    }
  }
  async function autoLoadNetlifyOnce(){
    if(NETLIFY_DB_AUTO_LOADED) return;
    if(!document.body.classList.contains("mobile-export")) return;
    NETLIFY_DB_AUTO_LOADED = true;
    await loadFromNetlifyDb({ silent: true });
  }

  function encodeConfig(cfg){
    const json = JSON.stringify(cfg);
    return btoa(encodeURIComponent(json));
  }
  function decodeConfig(encoded){
    const json = decodeURIComponent(atob(encoded));
    return JSON.parse(json);
  }
  function updateCoverDotVisibility(){
    const show = document.getElementById("show-cover-dot")?.checked !== false;
    document.body.classList.toggle("hide-cover-dot", !show);
  }
  function updatePayVisibility(showMonthlyPay, showNetPay){
    document.body.classList.toggle("hide-gross", !showMonthlyPay);
    document.body.classList.toggle("hide-net", !showNetPay);
  }
  function applyConfigFromHash(){
    const hash = window.location.hash || "";
    const match = hash.match(/#cfg=([^&]+)/);
    if(!match) return false;
    try{
      const cfg = decodeConfig(match[1]);
      applyConfig(cfg);
      saveConfig();
      try{
        const baseUrl = window.location.href.split("#")[0];
        window.history.replaceState(null, "", baseUrl);
      }catch(_e){}
      return true;
    }catch(_e){
      return false;
    }
  }
  function applyEmbeddedConfig(){
    const embedded = window.__TVAC_EMBEDDED_CONFIG__;
    if(!embedded) return false;
    try{
      applyConfig(embedded);
      saveConfig();
      return true;
    }catch(_e){
      return false;
    }
  }

  function updateFixedTotal(config){
    const el = document.getElementById("fixed-total");
    if(!el) return;
    if(!config || !Number.isFinite(config.fixed)){
      el.textContent = formatMoneyFull(0);
      return;
    }
    el.textContent = formatMoneyFull(config.fixed);
  }

  function calcMonthlyPay(totals, config){
    const nightExtra = totals.nights * config.hourly * config.nightMult * config.hours;
    const weekendExtra = (totals.weekendsPay ?? totals.weekends) * config.hourly * config.weekendMult * config.hours;
    const holidayExtra = totals.holidays * config.hourly * config.holidayMult * config.hours;
    return config.fixed + nightExtra + weekendExtra + holidayExtra;
  }
  function calcNetPay(gross, config){
    const totalPercent = (config.ccPercent || 0)
      + (config.unempPercent || 0)
      + (config.trainingPercent || 0)
      + (config.equityPercent || 0)
      + (config.irpfPercent || 0);
    const net = gross * (1 - totalPercent / 100);
    return Math.max(0, net);
  }

  function validateOption(opt){
    const W = 5;
    for(let d=0; d<opt.cycleLen; d++){
      const codes = [];
      for(let i=0;i<W;i++){
        if(opt.type === "matrix"){
          codes.push(opt.cycle[d][i]);
        }else{
          codes.push(opt.pattern[(d + opt.offsets[i]) % opt.cycleLen]);
        }
      }
      const ok = (codes.filter(x=>x==="M").length===1) &&
                 (codes.filter(x=>x==="T").length===1) &&
                 (codes.filter(x=>x==="N").length===1) &&
                 (codes.filter(x=>x==="O").length===2);
      if(!ok) return false;
    }
    return true;
  }

  function validateRulesYear(year, opt, anchor, workers, stateFn){
    const violations = [];
    const seen = new Set();
    const totals = initTotals(workers.length);
    const minRest = (VACATIONS_ENABLED && opt && opt.cycleLen === 10 && hasAppliedVacationsForYear(year)) ? 2 : MIN_REST_RUN;
    const state = workers.map(() => ({
      lastShift: "O",
      lastWork: null,
      restRun: 0,
      workRun: 0,
      sameRun: 0,
      nightRun: 0,
      seqPos: -1,
    }));

    const pushOnce = (wIdx, key, msg) => {
      const id = `${wIdx}-${key}`;
      if(!seen.has(id)){
        seen.add(id);
        violations.push(`Trabajador ${wIdx+1}: ${msg}`);
      }
    };

    const date = new Date(year, 0, 1);
    const primeDays = opt ? Math.max(opt.cycleLen || 0, MAX_WORK_RUN + MIN_REST_RUN + 4) : 0;
    if(opt && primeDays > 0){
      primeValidationState(state, date, primeDays, opt, anchor, workers);
    }
    const end = new Date(year, 11, 31);
    for(let d = new Date(date); d <= end; d.setDate(d.getDate()+1)){
      const iso = toISO(d);
      for(let wIdx=0; wIdx<workers.length; wIdx++){
        const raw = stateFn ? stateFn(wIdx, d) : stateFor(wIdx, d, opt, anchor);
        const normalized = (raw === "V" || raw === undefined || raw === null) ? "O" : raw;
        const info = shiftInfo(normalized);
        const s = info.type;
        const st = state[wIdx];
        const isWork = info.isWork;

        if(isWork){
          if(st.seqPos >= MAX_WORK_RUN){
            pushOnce(wIdx, "seq-end", "bloque completo: debe descansar.");
          }
          const expected = st.seqPos === -1 ? "M" : expectedShiftFromPos(st.seqPos);
          if(s !== expected){
            pushOnce(wIdx, "seq", `secuencia inválida: esperado ${expected}.`);
          }
          totals[wIdx].work += 1;
          if(info.isNight) totals[wIdx].nights += 1;
          if(isWeekend(d)) totals[wIdx].weekends += 1;

          if(st.lastShift !== "O"){
            const key = `${st.lastShift}->${s}`;
            if(!ALLOWED_ADJ.has(key)){
              pushOnce(wIdx, "adj", `transición no permitida ${key}.`);
            }
          }else{
            if(st.lastWork !== null){
              if(st.restRun < minRest){
                pushOnce(wIdx, "rest", `descanso entre bloques < ${minRest} días.`);
              }
              if(st.lastWork === "N" && st.restRun < minRest){
                pushOnce(wIdx, "rest-n", `salida de noches con descanso < ${minRest} días.`);
              }
              if(st.lastWork === "N" && s === "M" && st.restRun < minRest){
                pushOnce(wIdx, "n-to-m", `N→M requiere ≥${minRest} días de descanso.`);
              }
              if(st.lastWork === "T" && s === "M" && st.restRun < minRest){
                pushOnce(wIdx, "t-to-m", `T→M requiere ≥${minRest} días de descanso.`);
              }
            }
          }

          st.workRun = st.lastShift === "O" ? 1 : st.workRun + 1;
          if(st.workRun > MAX_WORK_RUN){
            pushOnce(wIdx, "max-work", `supera ${MAX_WORK_RUN} días seguidos de trabajo.`);
          }

          st.sameRun = st.lastShift === s ? st.sameRun + 1 : 1;
          if(st.sameRun > MAX_SAME_RUN){
            pushOnce(wIdx, `max-${s}`, `supera ${MAX_SAME_RUN} días seguidos en ${s}.`);
          }

          if(info.isNight){
            st.nightRun = st.lastShift === "N" ? st.nightRun + 1 : 1;
            if(st.nightRun > MAX_SAME_RUN){
              pushOnce(wIdx, "max-n", `supera ${MAX_SAME_RUN} noches seguidas.`);
            }
          }else{
            st.nightRun = 0;
          }

          st.lastShift = s;
          st.lastWork = s;
          st.restRun = 0;
          st.seqPos = st.seqPos === -1 ? 1 : st.seqPos + 1;
          if(st.seqPos > MAX_WORK_RUN) st.seqPos = MAX_WORK_RUN;
        }else{
          if(st.lastShift !== "O" && st.workRun !== MAX_WORK_RUN){
            pushOnce(wIdx, "block-6", `bloque de trabajo debe ser de ${MAX_WORK_RUN} días.`);
          }
          st.restRun = st.lastShift === "O" ? st.restRun + 1 : 1;
          st.lastShift = "O";
          st.workRun = 0;
          st.sameRun = 0;
          st.nightRun = 0;
          st.seqPos = -1;
        }
      }
    }

    return { violations, totals };
  }

  function equityWarnings(totals){
    const warnings = [];
    const diff = (key) => {
      const vals = totals.map(t => t[key]);
      return Math.max(...vals) - Math.min(...vals);
    };
    const dWork = diff("work");
    const dNight = diff("nights");
    const dWeekend = diff("weekends");
    if(dWork > 6) warnings.push(`Equidad anual: diferencia de jornadas ${dWork} (>5).`);
    if(dNight > 6) warnings.push(`Equidad anual: diferencia de noches ${dNight} (>5).`);
    if(dWeekend > 6) warnings.push(`Equidad anual: diferencia de fines de semana ${dWeekend} (>5).`);
    return warnings;
  }

  function rebuildPatternOptions(year, anchor, keepKey){
    const select = document.getElementById("pattern");
    if(!select) return null;
    const valid = [];

    Object.entries(OPTIONS).forEach(([key, opt]) => {
      valid.push({ key, name: opt.name });
    });

    select.innerHTML = "";
    if(!valid.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sin opciones válidas";
      select.appendChild(opt);
      select.disabled = true;
      return null;
    }
    select.disabled = false;
    valid.forEach(({key, name}) => {
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = name;
      select.appendChild(opt);
    });

    const stillValid = keepKey && valid.some(v => v.key === keepKey);
    select.value = stillValid ? keepKey : valid[0].key;
    select.disabled = true;
    return select.value;
  }

  function initTotals(count){
    return Array.from({length: count}, () => ({
      work: 0,
      nights: 0,
      weekends: 0,
      holidays: 0,
      weekendsPay: 0,
      vacations: 0,
      pay: 0,
    }));
  }

  function createSummaryKpis(workers, totals, titleText, extraClass, options){
    const summary = document.createElement("div");
    summary.className = `kpi-panel ${extraClass || ""}`.trim();

    const title = document.createElement("div");
    title.className = "kpi-title";
    title.textContent = titleText;
    summary.appendChild(title);

    const list = document.createElement("div");
    list.className = "kpi-list";

    const opts = options || {};
    workers.forEach((name, idx) => {
      const row = document.createElement("div");
      row.className = "kpi-row";

      const nameEl = document.createElement("div");
      nameEl.className = "kpi-name";
      nameEl.textContent = name;
      nameEl.title = name;
      row.appendChild(nameEl);

      const chipsWrap = document.createElement("div");
      chipsWrap.className = "kpi-chips";
      row.appendChild(chipsWrap);

      const workWithVac = formatWorkWithVacations(totals[idx].work, totals[idx].vacations);
      const workTitle = totals[idx].vacations
        ? `Jornadas: ${formatCount(totals[idx].work)} + Vacaciones: ${totals[idx].vacations}`
        : "Jornadas";
      const chips = [
        { label: "J", value: workWithVac, title: workTitle },
        { label: "N", value: totals[idx].nights, title: "Noches" },
        { label: "F", value: totals[idx].weekends, title: "Fines de semana" },
      ];
      if(opts.showHolidays){
        chips.push({ label: "H", value: totals[idx].holidays, title: "Festivos" });
      }
      if(opts.showPay){
        chips.push({ label: "€", value: formatMoneyShort(totals[idx].pay), title: "Bruto anual", className: "pay-gross" });
      }
      if(opts.showNet){
        const netAnnual = calcNetPay(totals[idx].pay, getPayConfigForWorker(idx));
        chips.push({ label: "N€", value: formatMoneyShort(netAnnual), title: "Neto anual", className: "pay-net" });
      }

      chips.forEach((chip) => {
        const chipEl = document.createElement("div");
        chipEl.className = `kpi-chip${chip.className ? " " + chip.className : ""}`;
        if(chip.label === "€"){
          chipEl.title = `${chip.title}: ${formatMoneyFull(totals[idx].pay)}`;
        }else if(chip.label === "N€"){
          const netAnnual = calcNetPay(totals[idx].pay, getPayConfigForWorker(idx));
          chipEl.title = `${chip.title}: ${formatMoneyFull(netAnnual)}`;
        }else{
          chipEl.title = chip.title;
        }
        chipEl.innerHTML = `<span class="kpi-label">${chip.label}</span><span class="kpi-value">${chip.value}</span>`;
        chipsWrap.appendChild(chipEl);
      });

      list.appendChild(row);
    });

    summary.appendChild(list);
    if(opts.showLegend){
      const legend = document.createElement("div");
      legend.className = "kpi-legend";
      const parts = ["J Jornadas (+V vacaciones)", "N Noches", "F Finde", "H Festivos"];
      if(opts.showPay) parts.push("€ Bruto");
      if(opts.showNet) parts.push("N€ Neto");
      legend.textContent = parts.join(" · ");
      summary.appendChild(legend);
    }
    return summary;
  }

  function buildMonthQuadrant(year, monthIdx, opt, workers, anchor, annualTotals, showMonthlyPay, showNetPay, showDiff, holidaySet, schedule, cover, legendUsage){
    const first = new Date(year, monthIdx, 1);
    const last = new Date(year, monthIdx+1, 0);
    const daysInMonth = last.getDate();

    const wrap = document.createElement("div");
    wrap.className = "month-wrap";
    wrap.style.setProperty("--i", monthIdx);
    wrap.dataset.month = String(monthIdx);
    wrap.dataset.year = String(year);

    const head = document.createElement("div");
    head.className = "month-head";
    head.innerHTML = `
      <div class="month-title">${MONTHS_ES[monthIdx]} ${year}</div>
    `;
    wrap.appendChild(head);

    const scroller = document.createElement("div");
    scroller.className = "scroller";

    const mobileWrap = document.createElement("div");
    mobileWrap.className = "month-mobile";

    const table = document.createElement("table");

    // THEAD: fila con días del mes (y día de la semana)
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.className = "sticky";
    th0.textContent = "Trabajador";
    trh.appendChild(th0);

    for(let d=1; d<=daysInMonth; d++){
      const date = new Date(year, monthIdx, d);
      const jsDow = date.getDay();            // 0=Dom..6=Sáb
      const dowMon0 = (jsDow + 6) % 7;        // 0=Lun..6=Dom
      const th = document.createElement("th");
      th.innerHTML = `<div class="dom">${fmt2(d)}</div><div class="dow">${DOW_ES[dowMon0]}</div>`;
      if(isWeekend(date)) th.style.background = "var(--c-weekend)";
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    // TBODY: una fila por trabajador, con M/T/N/O por día
    const tbody = document.createElement("tbody");
    workers.forEach((wName, wIdx) => {
      const tr = document.createElement("tr");
      tr.dataset.worker = String(wIdx);

      const nameCell = document.createElement("td");
      nameCell.className = "sticky";
      tr.appendChild(nameCell);

      const rowTotals = { work: 0, nights: 0, weekends: 0, holidays: 0, weekendsPay: 0, vacations: 0 };
      const dayData = {};

      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, monthIdx, d);
        const iso = `${year}-${fmt2(monthIdx+1)}-${fmt2(d)}`;
        const baseShift = stateFor(wIdx, date, opt, anchor);
        const rawShift = resolveShift(date, iso, wIdx, opt, anchor, schedule);
        const manualShift = getManualOverride(MANUAL_OVERRIDES, iso, wIdx);
        const displayVacation = getVacationDisplay(iso, wIdx);
        const s = displayVacation ? "V" : (rawShift || "O");
        const hasManual = !displayVacation && manualShift;
        const diff = showDiff && s !== baseShift;
        const info = shiftInfo(s);
        const holiday = holidaySet.has(iso);
        const appliedVac = VACATIONS_ENABLED && Boolean(VACATIONS_APPLIED[iso]?.[wIdx]);
        if(legendUsage){
          if(s) legendUsage[s] = true;
          if(holiday) legendUsage.H = true;
          if(diff) legendUsage.Diff = true;
        }
        if(appliedVac){
          rowTotals.vacations += 1;
        }

        const td = document.createElement("td");
        td.className = `cell ${s}`;
        if(hasManual) td.classList.add("manual");
        if(diff) td.classList.add("diff");
        if(cover && cover[iso] && cover[iso].includes(wIdx)) td.classList.add("cover");
        td.dataset.date = iso;
        td.dataset.worker = String(wIdx);
        td.dataset.shift = s;
        const full = info.full + (holiday ? " · Festivo" : "");
        const short = info.short;
        td.innerHTML = `<span>${short}</span>`;
        td.title = full;
        td.setAttribute("aria-label", full);
        if(isWeekend(date)) td.classList.add("wknd");
        if(holiday) td.classList.add("holiday");
        tr.appendChild(td);

        dayData[d] = {
          iso,
          day: d,
          shift: s,
          weekend: isWeekend(date),
          holiday,
          cover: cover && cover[iso] && cover[iso].includes(wIdx),
          manual: hasManual,
          diff,
          title: full,
        };

        if(info.isWork){
          rowTotals.work += 1;
          if(info.isNight) rowTotals.nights += 1;
          if(isWeekend(date)) rowTotals.weekends += 1;
          if(holiday) rowTotals.holidays += 1;
          if(isWeekend(date) && !holiday) rowTotals.weekendsPay += 1;
        }
      }

      const payConfig = getPayConfigForWorker(wIdx);
      const monthlyPay = calcMonthlyPay(rowTotals, payConfig);
      const monthlyNet = calcNetPay(monthlyPay, payConfig);
      const workWithVac = formatWorkWithVacations(rowTotals.work, rowTotals.vacations);
      const workTitle = rowTotals.vacations
        ? `Jornadas: ${formatCount(rowTotals.work)} + Vacaciones: ${rowTotals.vacations}`
        : "Jornadas";
      const kpiItems = [
        { label: "J", value: workWithVac, title: workTitle },
        { label: "N", value: rowTotals.nights },
        { label: "F", value: rowTotals.weekends },
        { label: "H", value: rowTotals.holidays },
      ];
      if(showMonthlyPay){
        kpiItems.push({ label: "€", value: formatMoneyShort(monthlyPay), className: "pay-gross" });
      }
      if(showNetPay){
        kpiItems.push({ label: "N€", value: formatMoneyShort(monthlyNet), className: "pay-net" });
      }
      const kpiTitleParts = [
        `J:${workWithVac}`,
        `N:${rowTotals.nights}`,
        `F:${rowTotals.weekends}`,
        `H:${rowTotals.holidays}`,
      ];
      if(showMonthlyPay){
        kpiTitleParts.push(formatMoneyFull(monthlyPay));
      }
      if(showNetPay){
        kpiTitleParts.push(`Neto ${formatMoneyFull(monthlyNet)}`);
      }
      const kpiTitle = kpiTitleParts.join(" ");
      const compactParts = [
        { text: `J${workWithVac}` },
        { text: `N${rowTotals.nights}` },
        { text: `F${rowTotals.weekends}` },
        { text: `H${rowTotals.holidays}` },
      ];
      if(showMonthlyPay){
        compactParts.push({ text: `€${formatMoneyShort(monthlyPay).replace("€","")}`, className: "pay-gross" });
      }
      if(showNetPay){
        compactParts.push({ text: `N€${formatMoneyShort(monthlyNet).replace("€","")}`, className: "pay-net" });
      }
      const compactHtml = compactParts.map((part, idx) => {
        const cls = part.className ? ` ${part.className}` : "";
        const sep = idx < compactParts.length - 1 ? " · " : "";
        return `<span class="compact-part${cls}">${part.text}${sep}</span>`;
      }).join("");
      nameCell.innerHTML = `<span class="name-wrap"><span class="name-kpis">${buildMiniKpis(kpiItems)}</span><span class="name-person">${wName}</span><span class="name-kpis-compact">${compactHtml}</span></span>`;
      nameCell.title = `${kpiTitle} ${wName}`;
      nameCell.setAttribute("aria-label", `${kpiTitle} ${wName}`);

      if(annualTotals){
        annualTotals[wIdx].work += rowTotals.work;
        annualTotals[wIdx].nights += rowTotals.nights;
        annualTotals[wIdx].weekends += rowTotals.weekends;
        annualTotals[wIdx].holidays += rowTotals.holidays;
        annualTotals[wIdx].weekendsPay += rowTotals.weekendsPay;
        annualTotals[wIdx].pay += monthlyPay;
        annualTotals[wIdx].vacations += rowTotals.vacations;
      }

      tbody.appendChild(tr);

      const card = document.createElement("div");
      card.className = "worker-card";
      card.dataset.worker = String(wIdx);
      const cardHead = document.createElement("div");
      cardHead.className = "worker-card-head";
      cardHead.innerHTML = `<div class="worker-name">${wName}</div>`;
      card.appendChild(cardHead);
      const kpiCollapse = document.createElement("details");
      kpiCollapse.className = "kpi-collapse";
      kpiCollapse.innerHTML = `<summary>Resumen</summary><div class="worker-kpis">${buildMiniKpis(kpiItems)}</div>`;
      card.appendChild(kpiCollapse);
      const weekHeader = document.createElement("div");
      weekHeader.className = "week-header";
      weekHeader.innerHTML = DOW_ES.map(label => `<span>${label}</span>`).join("");
      card.appendChild(weekHeader);
      const weeksWrap = document.createElement("div");
      weeksWrap.className = "weeks";
      const weeks = [];
      let week = Array(7).fill(null);
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, monthIdx, d);
        const dow = (date.getDay() + 6) % 7;
        if(d === 1) week = Array(7).fill(null);
        week[dow] = d;
        if(dow === 6 || d === daysInMonth){
          weeks.push(week);
          week = Array(7).fill(null);
        }
      }
      weeks.forEach((weekDays) => {
        const row = document.createElement("div");
        row.className = "week-grid";
        weekDays.forEach((dayNum) => {
          const cell = document.createElement("div");
          if(!dayNum){
            cell.className = "day-pill empty";
            row.appendChild(cell);
            return;
          }
          const info = dayData[dayNum];
          cell.className = `day-pill ${info.shift}`;
          if(info.weekend) cell.classList.add("wknd");
          if(info.holiday) cell.classList.add("holiday");
          if(info.cover) cell.classList.add("cover");
          if(info.manual) cell.classList.add("manual");
          if(info.diff) cell.classList.add("diff");
          cell.dataset.date = info.iso;
          cell.dataset.worker = String(wIdx);
          cell.dataset.shift = info.shift;
          cell.title = info.title;
          cell.innerHTML = `<span class="day-num">${fmt2(dayNum)}</span><span class="day-shift">${info.shift}</span>`;
          row.appendChild(cell);
        });
        weeksWrap.appendChild(row);
      });
      card.appendChild(weeksWrap);
      mobileWrap.appendChild(card);
    });

    table.appendChild(tbody);
    scroller.appendChild(table);
    wrap.appendChild(scroller);
    wrap.appendChild(mobileWrap);
    return wrap;
  }

  function render(){
    const year = Number(document.getElementById("year").value);
    const anchor = parseDateLocal(document.getElementById("anchor").value);
    const patternSelect = document.getElementById("pattern");
    let keepKey = patternSelect ? patternSelect.value : null;
    if(patternSelect && patternSelect.dataset.pref){
      keepKey = patternSelect.dataset.pref;
      patternSelect.dataset.pref = "";
    }
    const patternKey = rebuildPatternOptions(year, anchor, keepKey);
    const opt = patternKey ? OPTIONS[patternKey] : null;

    const workers = [
      document.getElementById("w1").value.trim() || "A",
      document.getElementById("w2").value.trim() || "B",
      document.getElementById("w3").value.trim() || "C",
      document.getElementById("w4").value.trim() || "D",
      document.getElementById("w5").value.trim() || "E",
    ];
    CURRENT_WORKERS = workers.slice();
    loadWorkerFilter();
    loadFocusMode();
    if(CURRENT_WORKER_FILTER !== "all"){
      const idx = Number(CURRENT_WORKER_FILTER);
      if(!Number.isFinite(idx) || idx < 0 || idx >= workers.length){
        CURRENT_WORKER_FILTER = "all";
      }
    }
    syncVacationWorkers(workers);
    syncManualWorkers(workers);
    syncSalaryWorkers(workers);
    renderWorkerFilterButtons(workers);
    syncFocusControls(workers);

    const container = document.getElementById("calendar");
    container.innerHTML = "";
    const annualTotals = initTotals(workers.length);
    const annualContainer = document.getElementById("annual-summary-panel");
    annualContainer.innerHTML = "";
    const showMonthlyPay = document.getElementById("show-monthly-pay")?.checked || false;
    const showNetPay = document.getElementById("show-net-pay")?.checked || false;
    const showDiff = document.getElementById("show-diff")?.checked || false;
    updatePayVisibility(showMonthlyPay, showNetPay);
    updateFixedTotal(getPayConfigForWorker(SELECTED_PAY_WORKER));
    const holidaySet = parseHolidayList(document.getElementById("holiday-list").value);
    const legendUsage = { M:false, T:false, N:false, O:false, V:false, H:false, Diff:false };
    if(!VACATIONS_DRAFT || typeof VACATIONS_DRAFT !== "object"){
      VACATIONS_DRAFT = cloneVacations(VACATIONS_APPLIED);
    }
    const vacAllowed = patternKey === "D";
    VACATIONS_ENABLED = vacAllowed;
    if(!vacAllowed){
      const vacMode = document.getElementById("vac-mode");
      if(vacMode) vacMode.checked = false;
    }
    const pendingVacations = vacAllowed ? hasPendingVacations() : false;
    updateVacationAvailability(vacAllowed);

    const warnings = [];
    if(!opt){
      warnings.push("No hay opciones válidas para las reglas actuales.");
    }else{
      if(!validateOption(opt)){
        warnings.push("La opción seleccionada no garantiza 1M/1T/1N/2O cada día.");
      }
    }

    if(opt){
      if(pendingVacations){
        warnings.push("Vacaciones pendientes de aplicar.");
      }
      const schedulePack = buildScheduleWithVacations(year, opt, anchor, workers, { adjust6x2: vacAllowed });
      CURRENT_SCHEDULE = schedulePack.schedule || {};
      CURRENT_COVER = schedulePack.cover || {};
      if(!pendingVacations && schedulePack.warnings && schedulePack.warnings.length){
        warnings.push(...schedulePack.warnings);
      }

      if(!pendingVacations){
        const stateFn = (wIdx, date) => {
          const iso = toISO(date);
          return resolveShift(date, iso, wIdx, opt, anchor, CURRENT_SCHEDULE);
        };
        const ruleReport = validateRulesYear(year, opt, anchor, workers, stateFn);
        warnings.push(...ruleReport.violations.slice(0, 8));
        if(ruleReport.violations.length > 8){
          warnings.push(`…y ${ruleReport.violations.length - 8} más.`);
        }

        const coverageIssues = coverageWarnings(year, CURRENT_SCHEDULE, opt, anchor, workers.length);
        if(coverageIssues.length){
          warnings.push(...coverageIssues.slice(0, 6));
          if(coverageIssues.length > 6){
            warnings.push(`…y ${coverageIssues.length - 6} días con cobertura incompleta.`);
          }
        }
      }

      for(let m=0; m<12; m++){
        container.appendChild(buildMonthQuadrant(year, m, opt, workers, anchor, annualTotals, showMonthlyPay, showNetPay, showDiff, holidaySet, CURRENT_SCHEDULE, CURRENT_COVER, legendUsage));
      }
      warnings.push(...equityWarnings(annualTotals));

      if(!pendingVacations){
      }
    }else{
      CURRENT_SCHEDULE = {};
      CURRENT_COVER = {};
    }

    if(warnings.length){
      const warn = document.createElement("div");
      warn.className = "warning-box";
      warn.innerHTML = warnings.map(x => `• ${x}`).join("<br>");
      container.prepend(warn);
    }

    renderLegend(legendUsage, showDiff);

    annualContainer.appendChild(createSummaryKpis(workers, annualTotals, `Resumen anual ${year}`, "kpi-annual", { showPay: showMonthlyPay, showNet: showNetPay, showHolidays: true, showLegend: true }));
    applyWorkerFilter();
    updateVacationModeClass();
    updateManualModeClass();
    updateVacationStatus();
    updateCoverDotVisibility();
    if(document.body.classList.contains("mobile-export")){
      setTimeout(() => {
        if(window.__tvac_scrolled) return;
        const now = new Date();
        if(Number.isFinite(year) && now.getFullYear() !== year) return;
        const target = document.querySelector(`.month-wrap[data-year="${year}"][data-month="${now.getMonth()}"]`);
        if(target){
          target.scrollIntoView({ behavior: "smooth", block: "start" });
          window.__tvac_scrolled = true;
        }
      }, 80);
    }
    if(!GLOBAL_HISTORY.length) initGlobalHistory();
    else updateHistoryButtons();
    saveConfig();
  }

  document.getElementById("render").addEventListener("click", render);
  document.getElementById("reset").addEventListener("click", resetCalendarAndVacations);
  const undoBtn = document.getElementById("undo-change");
  const redoBtn = document.getElementById("redo-change");
  if(undoBtn){
    undoBtn.addEventListener("click", () => {
      if(undoGlobalChange()){
        setDirty(true);
        render();
      }
    });
  }
  if(redoBtn){
    redoBtn.addEventListener("click", () => {
      if(redoGlobalChange()){
        setDirty(true);
        render();
      }
    });
  }
  document.getElementById("pattern").addEventListener("change", render);
  document.getElementById("year").addEventListener("input", render);
  document.getElementById("anchor").addEventListener("input", render);
  document.getElementById("print").addEventListener("click", () => window.print());
  const exportBtn = document.getElementById("export-config");
  const importBtn = document.getElementById("import-config");
  const importFile = document.getElementById("import-file");
  const netlifyLoadBtn = document.getElementById("netlify-load");
  const netlifySaveBtn = document.getElementById("netlify-save");
  const goTodayBtn = document.getElementById("go-today");
  const topSaveNetlify = document.getElementById("top-save-netlify");
  const focusToggle = document.getElementById("focus-mode");
  const focusSelect = document.getElementById("worker-focus");
  const workerSearch = document.getElementById("worker-search");
  const coverDotToggle = document.getElementById("show-cover-dot");
  if(exportBtn){
    exportBtn.addEventListener("click", () => {
      const cfg = collectConfig();
      const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `calendario-config-${cfg.year || "config"}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }
  if(importBtn && importFile){
    importBtn.addEventListener("click", () => importFile.click());
    importFile.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const cfg = JSON.parse(String(reader.result || "{}"));
          applyConfig(cfg);
          saveConfig();
          render();
        }catch(_e){
          alert("Archivo de configuración inválido.");
        }
        importFile.value = "";
      };
      reader.readAsText(file);
    });
  }
  if(netlifyLoadBtn){
    netlifyLoadBtn.addEventListener("click", () => {
      loadFromNetlifyDb();
    });
  }
  if(netlifySaveBtn){
    netlifySaveBtn.addEventListener("click", () => {
      saveToNetlifyDb();
    });
  }
  if(topSaveNetlify){
    topSaveNetlify.addEventListener("click", async () => {
      const ok = await saveToNetlifyDb();
      if(ok){
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        showToast(`Guardado en Netlify DB · ${hh}:${mm}`);
      }
    });
  }
  if(goTodayBtn){
    goTodayBtn.addEventListener("click", () => {
      const year = Number(document.getElementById("year")?.value);
      const now = new Date();
      if(!Number.isFinite(year) || year !== now.getFullYear()){
        showToast("El año seleccionado no es el actual.");
        return;
      }
      const target = document.querySelector(`.month-wrap[data-year="${year}"][data-month="${now.getMonth()}"]`);
      if(target){
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  }
  if(focusToggle){
    focusToggle.addEventListener("change", () => {
      FOCUS_MODE = focusToggle.checked;
      try{
        localStorage.setItem(FOCUS_KEY, FOCUS_MODE ? "1" : "0");
      }catch(_e){}
      if(focusSelect) focusSelect.disabled = !FOCUS_MODE;
      if(!FOCUS_MODE){
        setWorkerFilter("all");
      }else if(focusSelect && focusSelect.value){
        setWorkerFilter(focusSelect.value);
      }
      applyWorkerFilter();
    });
  }
  if(focusSelect){
    focusSelect.addEventListener("change", () => {
      const value = focusSelect.value;
      if(value && value !== "all"){
        if(focusToggle && !focusToggle.checked){
          focusToggle.checked = true;
          FOCUS_MODE = true;
          try{ localStorage.setItem(FOCUS_KEY, "1"); }catch(_e){}
        }
        setWorkerFilter(value);
      }else{
        setWorkerFilter("all");
      }
      applyWorkerFilter();
    });
  }
  if(workerSearch){
    workerSearch.addEventListener("input", () => {
      const query = workerSearch.value.trim().toLowerCase();
      if(!query){
        if(FOCUS_MODE) setWorkerFilter("all");
        return;
      }
      const idx = CURRENT_WORKERS.findIndex((w) => String(w || "").toLowerCase().includes(query));
      if(idx >= 0){
        if(focusToggle && !focusToggle.checked){
          focusToggle.checked = true;
          FOCUS_MODE = true;
          try{ localStorage.setItem(FOCUS_KEY, "1"); }catch(_e){}
          if(focusSelect) focusSelect.disabled = false;
        }
        if(focusSelect) focusSelect.value = String(idx);
        setWorkerFilter(String(idx));
        applyWorkerFilter();
      }
    });
  }
  const exportHtmlBtn = document.getElementById("export-html");
  const exportDriveBtn = document.getElementById("export-drive");
  const exportNetlifyBtn = document.getElementById("export-netlify");
  const NETLIFY_SITE_ID = "c6e07fe0-5eb5-4d84-bc86-24dd1ccde8b0";
  const NETLIFY_TOKEN = "";
  const exportPdfBtn = document.getElementById("export-pdf");
  const DRIVE_CLIENT_ID = "341195340022-fv4l4pm0k8bu2pfiif2egdontcgq9cqf.apps.googleusercontent.com";
  const DRIVE_FOLDER_NAME = "Calendario TVAC";
  let driveTokenClient = null;
  let driveAccessToken = "";
  const DRIVE_TOKEN_KEY = "tvacDriveToken";
  const DRIVE_FOLDER_KEY = "tvacDriveFolderId";
  const loadDriveToken = () => {
    try{
      const stored = JSON.parse(localStorage.getItem(DRIVE_TOKEN_KEY) || "null");
      if(stored && stored.token && stored.exp && Date.now() < stored.exp){
        driveAccessToken = stored.token;
        return true;
      }
    }catch(_e){}
    return false;
  };
  const saveDriveToken = (token, expiresIn) => {
    const exp = Date.now() + (Math.max(0, Number(expiresIn) || 0) - 30) * 1000;
    const payload = { token, exp };
    try{
      localStorage.setItem(DRIVE_TOKEN_KEY, JSON.stringify(payload));
    }catch(_e){}
  };
  const ensureDriveTokenClient = () => {
    if(driveTokenClient) return true;
    if(!window.google || !window.google.accounts || !window.google.accounts.oauth2){
      const script = document.createElement("script");
      script.src = "https://accounts.google.com/gsi/client";
      script.async = true;
      script.defer = true;
      script.onload = () => {
        driveTokenClient = google.accounts.oauth2.initTokenClient({
          client_id: DRIVE_CLIENT_ID,
          scope: "https://www.googleapis.com/auth/drive.file",
          callback: () => {},
        });
      };
      document.head.appendChild(script);
      return false;
    }
    driveTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: DRIVE_CLIENT_ID,
      scope: "https://www.googleapis.com/auth/drive.file",
      callback: () => {},
    });
    return true;
  };
  const requestDriveToken = () => new Promise((resolve, reject) => {
    if(!ensureDriveTokenClient()){
      setTimeout(() => requestDriveToken().then(resolve, reject), 300);
      return;
    }
    if(!driveTokenClient){
      reject(new Error("No se pudo iniciar OAuth."));
      return;
    }
    driveTokenClient.callback = (resp) => {
      if(resp && resp.access_token){
        driveAccessToken = resp.access_token;
        saveDriveToken(resp.access_token, resp.expires_in || 0);
        resolve(resp.access_token);
      }else{
        reject(new Error("No se obtuvo token de Drive."));
      }
    };
    driveTokenClient.requestAccessToken({ prompt: driveAccessToken ? "" : "consent" });
  });
  const fetchDrive = (url, options = {}) => {
    const headers = { ...(options.headers || {}), Authorization: `Bearer ${driveAccessToken}` };
    return fetch(url, { ...options, headers });
  };
  const getOrCreateDriveFolder = async () => {
    try{
      const cached = localStorage.getItem(DRIVE_FOLDER_KEY);
      if(cached) return cached;
    }catch(_e){}
    const q = encodeURIComponent(`name='${DRIVE_FOLDER_NAME.replace(/'/g, "\\'")}' and mimeType='application/vnd.google-apps.folder' and trashed=false`);
    const res = await fetchDrive(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if(!res.ok) throw new Error("No se pudo buscar carpeta en Drive.");
    const data = await res.json();
    if(data.files && data.files.length){
      const id = data.files[0].id;
      try{ localStorage.setItem(DRIVE_FOLDER_KEY, id); }catch(_e){}
      return id;
    }
    const createRes = await fetchDrive("https://www.googleapis.com/drive/v3/files", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: DRIVE_FOLDER_NAME, mimeType: "application/vnd.google-apps.folder" }),
    });
    if(!createRes.ok) throw new Error("No se pudo crear carpeta en Drive.");
    const created = await createRes.json();
    try{ localStorage.setItem(DRIVE_FOLDER_KEY, created.id); }catch(_e){}
    return created.id;
  };
  const findDriveFileId = async (folderId, filename) => {
    const safeName = filename.replace(/'/g, "\\'");
    const q = encodeURIComponent(`name='${safeName}' and '${folderId}' in parents and trashed=false`);
    const res = await fetchDrive(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)`);
    if(!res.ok) throw new Error("No se pudo buscar el archivo en Drive.");
    const data = await res.json();
    if(data.files && data.files.length) return data.files[0].id;
    return null;
  };
  const uploadHtmlToDrive = async (html, filename) => {
    const folderId = await getOrCreateDriveFolder();
    const existingId = await findDriveFileId(folderId, filename);
    const boundary = "tvacBoundary" + Math.random().toString(16).slice(2);
    const metadata = {
      name: filename,
      mimeType: "text/html",
      parents: folderId ? [folderId] : undefined,
    };
    const body = [
      `--${boundary}`,
      "Content-Type: application/json; charset=UTF-8",
      "",
      JSON.stringify(existingId ? { name: filename, mimeType: "text/html" } : metadata),
      `--${boundary}`,
      "Content-Type: text/html; charset=UTF-8",
      "",
      html,
      `--${boundary}--`,
    ].join("\r\n");
    const uploadUrl = existingId
      ? `https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart`
      : `https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`;
    const res = await fetchDrive(uploadUrl, {
      method: existingId ? "PATCH" : "POST",
      headers: { "Content-Type": `multipart/related; boundary=${boundary}` },
      body,
    });
    if(!res.ok){
      const errText = await res.text();
      throw new Error(`Error subiendo a Drive: ${errText}`);
    }
    return res.json();
  };
  const buildExportHtml = (mobile, options = {}) => {
    const { includeConfig = true, includePay = true } = options;
    const cfg = collectConfig();
    const clone = document.documentElement.cloneNode(true);
    const body = clone.querySelector("body");
    if(body){
      if(mobile) body.classList.add("mobile-export");
      body.classList.remove("modal-open");
      body.classList.remove("worker-filtered");
      const showGross = includePay && cfg.showMonthlyPay;
      const showNet = includePay && cfg.showNetPay;
      body.classList.toggle("hide-gross", !showGross);
      body.classList.toggle("hide-net", !showNet);
    }
    const headerConfig = clone.querySelector(".header-config");
    if(headerConfig) headerConfig.remove();
    if(!includeConfig){
      const configModal = clone.querySelector("#config-modal");
      if(configModal) configModal.remove();
      const exportModal = clone.querySelector("#export-modal");
      if(exportModal) exportModal.remove();
    }
    clone.querySelectorAll(".worker-hidden").forEach((el) => el.classList.remove("worker-hidden"));
    const filterButtons = clone.querySelectorAll("#worker-filter button");
    filterButtons.forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.filter === "all");
    });
    clone.querySelectorAll("script").forEach((script) => {
      const txt = script.textContent ? script.textContent.trim() : "";
      if(txt.startsWith("window.__TVAC_EMBEDDED_CONFIG__=")){
        script.remove();
      }
    });
    if(!includeConfig){
      const appScript = clone.querySelector("#tvac-app");
      if(appScript) appScript.remove();
    }
    if(body){
      const embedded = document.createElement("script");
      embedded.textContent = `window.__TVAC_EMBEDDED_CONFIG__=${JSON.stringify(cfg)};`;
      const scripts = body.querySelectorAll("script");
      if(scripts.length){
        const lastScript = scripts[scripts.length - 1];
        lastScript.parentNode.insertBefore(embedded, lastScript);
      }else{
        body.appendChild(embedded);
      }
    }
    return { html: `<!DOCTYPE html>\n${clone.outerHTML}`, cfg };
  };
  const downloadHtml = (mobile = false) => {
    const { html, cfg } = buildExportHtml(mobile, { includeConfig: false, includePay: false });
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `calendario_${cfg.year || "export"}${mobile ? "_movil" : ""}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
  const sha1Hex = async (text) => {
    const data = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-1", data);
    return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");
  };
  const fetchWithTimeout = async (url, options = {}, timeoutMs = 15000) => {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try{
      return await fetch(url, { ...options, signal: controller.signal });
    }finally{
      clearTimeout(timer);
    }
  };
  const deployToNetlify = async (html) => {
    if(!NETLIFY_SITE_ID || !NETLIFY_TOKEN) throw new Error("Falta configurar Netlify.");
    const sha = await sha1Hex(html);
    let deploy;
    try{
      const res = await fetchWithTimeout(`https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/deploys`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${NETLIFY_TOKEN}`,
        },
        body: JSON.stringify({ files: { "index.html": sha } }),
      }, 20000);
      if(!res.ok){
        const errText = await res.text();
        throw new Error(`Error creando deploy (${res.status}): ${errText}`);
      }
      deploy = await res.json();
    }catch(err){
      const msg = err && err.name === "AbortError"
        ? "Tiempo de espera agotado"
        : (err && err.message ? err.message : String(err));
      throw new Error(`Netlify no accesible (red/CORS?): ${msg}`);
    }
    const required = deploy.required || [];
    if(required.includes("index.html")){
      const uploadRes = await fetchWithTimeout(`https://api.netlify.com/api/v1/deploys/${deploy.id}/files/index.html`, {
        method: "PUT",
        headers: {
          "Content-Type": "text/html; charset=UTF-8",
          Authorization: `Bearer ${NETLIFY_TOKEN}`,
        },
        body: html,
      }, 30000);
      if(!uploadRes.ok){
        const errText = await uploadRes.text();
        throw new Error(`Error subiendo archivo (${uploadRes.status}): ${errText}`);
      }
    }
    const start = Date.now();
    const timeoutMs = 45000;
    let lastState = deploy.state || "unknown";
    while(Date.now() - start < timeoutMs){
      const stRes = await fetchWithTimeout(`https://api.netlify.com/api/v1/deploys/${deploy.id}`, {
        headers: { Authorization: `Bearer ${NETLIFY_TOKEN}` },
      }, 10000);
      if(stRes.ok){
        const st = await stRes.json();
        lastState = st.state || lastState;
        if(st.state === "ready") return st;
        if(st.state === "error"){
          throw new Error(`Deploy en error: ${st.error_message || "sin detalle"}`);
        }
      }
      await new Promise((r) => setTimeout(r, 1500));
    }
    throw new Error(`Deploy pendiente: estado ${lastState}.`);
  };
  if(exportHtmlBtn){
    exportHtmlBtn.addEventListener("click", async () => {
      const { html: downloadMarkup } = buildExportHtml(true, { includeConfig: false, includePay: false });
      const blob = new Blob([downloadMarkup], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `calendario_${(collectConfig().year || "export")}_movil.html`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }
  if(exportDriveBtn){
    exportDriveBtn.addEventListener("click", async () => {
      try{
        if(location.protocol === "file:"){
          alert("Para subir a Drive abre este HTML desde un servidor local (http://localhost).");
          return;
        }
        if(!driveAccessToken) loadDriveToken();
        if(!driveAccessToken) await requestDriveToken();
        const { html, cfg } = buildExportHtml(true, { includeConfig: true, includePay: true });
        const fileName = `calendario_${cfg.year || "export"}_movil.html`;
        await uploadHtmlToDrive(html, fileName);
        exportDriveBtn.textContent = "Subido a Drive";
        setTimeout(() => { exportDriveBtn.textContent = "Exportar a Drive"; }, 1600);
      }catch(err){
        alert(err && err.message ? err.message : "No se pudo subir a Drive.");
      }
    });
  }
  if(exportNetlifyBtn){
    exportNetlifyBtn.addEventListener("click", async () => {
      try{
        const prevText = exportNetlifyBtn.textContent;
        exportNetlifyBtn.textContent = "Publicando…";
        const { html } = buildExportHtml(true, { includeConfig: true, includePay: true });
        const deploy = await deployToNetlify(html);
        exportNetlifyBtn.textContent = "Publicado";
        setTimeout(() => { exportNetlifyBtn.textContent = prevText; }, 1800);
        if(deploy && deploy.deploy_url){
          console.log("Netlify deploy:", deploy.deploy_url);
        }
      }catch(err){
        exportNetlifyBtn.textContent = "Error al publicar";
        setTimeout(() => { exportNetlifyBtn.textContent = "Publicar en Netlify"; }, 1800);
        alert(err && err.message ? err.message : "No se pudo publicar en Netlify.");
      }
    });
  }
  if(exportPdfBtn){
    exportPdfBtn.addEventListener("click", () => {
      const { html } = buildExportHtml(true, { includeConfig: false, includePay: false });
      const win = window.open("", "_blank");
      if(!win){
        alert("No se pudo abrir la ventana para imprimir.");
        return;
      }
      win.document.open();
      win.document.write(html);
      win.document.close();
      win.addEventListener("load", () => {
        win.focus();
        win.print();
      });
    });
  }
  if(coverDotToggle){
    coverDotToggle.addEventListener("change", () => {
      updateCoverDotVisibility();
      saveConfig();
    });
  }
  const showMonthlyToggle = document.getElementById("show-monthly-pay");
  const showNetToggle = document.getElementById("show-net-pay");
  if(showMonthlyToggle){
    showMonthlyToggle.addEventListener("change", () => {
      setDirty(true);
      render();
    });
  }
  if(showNetToggle){
    showNetToggle.addEventListener("change", () => {
      setDirty(true);
      render();
    });
  }
  document.addEventListener("change", (e) => {
    const target = e.target;
    if(!(target instanceof HTMLInputElement)) return;
    if(target.id === "show-monthly-pay" || target.id === "show-net-pay" || target.id === "show-diff"){
      setDirty(true);
      render();
    }
  });
  document.querySelectorAll(".config-grid input, .config-grid textarea").forEach((el) => {
    if(el.classList.contains("pay-input")) return;
    el.addEventListener("input", () => {
      setDirty(true);
      render();
    });
  });
  document.querySelectorAll(".pay-input").forEach((el) => {
    el.addEventListener("input", () => {
      if(!Number.isFinite(SELECTED_PAY_WORKER)) return;
      PAY_CONFIGS[SELECTED_PAY_WORKER] = readPayInputs();
      updateFixedTotal(getPayConfigForWorker(SELECTED_PAY_WORKER));
      saveConfig();
      setDirty(true);
      render();
    });
  });
  document.querySelectorAll("#config-modal .row input, #config-modal .workers-grid input").forEach((el) => {
    el.addEventListener("input", () => {
      setDirty(true);
      render();
    });
  });
  const vacMode = document.getElementById("vac-mode");
  const vacWorker = document.getElementById("vac-worker");
  const manualMode = document.getElementById("manual-mode");
  const manualWorker = document.getElementById("manual-worker");
  const manualShift = document.getElementById("manual-shift");
  const salaryWorker = document.getElementById("salary-worker");
  const vacApply = document.getElementById("vac-apply");
  const vacCancel = document.getElementById("vac-cancel");
  const payDefaults = document.getElementById("pay-defaults");
  const payCopyAll = document.getElementById("pay-copy-all");
  if(vacMode){
    vacMode.addEventListener("change", () => {
      if(vacMode.checked && manualMode) manualMode.checked = false;
      updateVacationModeClass();
      updateManualModeClass();
      saveConfig();
      setDirty(true);
    });
  }
  if(vacWorker){
    vacWorker.addEventListener("change", () => {
      saveConfig();
      setDirty(true);
    });
  }
  if(manualMode){
    manualMode.addEventListener("change", () => {
      if(manualMode.checked && vacMode) vacMode.checked = false;
      updateVacationModeClass();
      updateManualModeClass();
      saveConfig();
      setDirty(true);
    });
  }
  if(manualWorker){
    manualWorker.addEventListener("change", () => {
      saveConfig();
      setDirty(true);
    });
  }
  if(manualShift){
    manualShift.addEventListener("change", () => {
      saveConfig();
      setDirty(true);
    });
  }
  if(salaryWorker){
    salaryWorker.addEventListener("change", () => {
      if(Number.isFinite(SELECTED_PAY_WORKER)){
        PAY_CONFIGS[SELECTED_PAY_WORKER] = readPayInputs();
      }
      updateSalaryPanel();
      saveConfig();
      setDirty(true);
    });
  }
  if(payDefaults){
    payDefaults.addEventListener("click", () => {
      if(!Number.isFinite(SELECTED_PAY_WORKER)) return;
      const reset = { ...DEFAULT_PAY_CONFIG };
      PAY_CONFIGS[SELECTED_PAY_WORKER] = reset;
      writePayInputs(reset);
      updateFixedTotal(getPayConfigForWorker(SELECTED_PAY_WORKER));
      saveConfig();
      setDirty(true);
      render();
    });
  }
  if(payCopyAll){
    payCopyAll.addEventListener("click", () => {
      if(!Number.isFinite(SELECTED_PAY_WORKER)) return;
      const base = readPayInputs();
      PAY_CONFIGS = Array.from({ length: WORKER_COUNT }, () => ({ ...base }));
      saveConfig();
      setDirty(true);
      render();
    });
  }
  if(vacApply){
    vacApply.addEventListener("click", () => {
      applyVacationsDraft();
      render();
      setDirty(true);
    });
  }
  if(vacCancel){
    vacCancel.addEventListener("click", () => {
      resetVacationsDraft();
      render();
      setDirty(true);
    });
  }
  const calendarEl = document.getElementById("calendar");
  if(calendarEl){
    calendarEl.addEventListener("click", (e) => {
      const cell = e.target.closest("td.cell, .day-pill");
      if(!cell) return;
      const workerIdx = Number(cell.dataset.worker || "0");
      const dateStr = cell.dataset.date;
      if(!dateStr) return;
      const manualOn = document.getElementById("manual-mode")?.checked;
      if(manualOn){
        const selected = Number(document.getElementById("manual-worker")?.value || "0");
        if(workerIdx !== selected) return;
        if(getVacationDisplay(dateStr, workerIdx)) return;
        const desired = document.getElementById("manual-shift")?.value || "";
        if(e.altKey || !MANUAL_SHIFTS.has(desired)){
          setManualOverride(MANUAL_OVERRIDES, dateStr, workerIdx, null);
        }else{
          setManualOverride(MANUAL_OVERRIDES, dateStr, workerIdx, desired);
        }
        pushGlobalHistory();
        saveConfig();
        setDirty(true);
        render();
        return;
      }
      if(!document.getElementById("vac-mode")?.checked) return;
      if(!VACATIONS_ENABLED) return;
      const selected = Number(document.getElementById("vac-worker")?.value || "0");
      if(workerIdx !== selected) return;
      const changed = toggleVacation(dateStr, workerIdx);
      if(changed){
        setDirty(true);
        render();
      }
    });
  }
  document.addEventListener("keydown", (e) => {
    const target = e.target;
    if(target && (target.tagName === "INPUT" || target.tagName === "TEXTAREA" || target.isContentEditable)) return;
    if(!(e.ctrlKey || e.metaKey)) return;
    const key = e.key.toLowerCase();
    if(key === "z" && !e.shiftKey){
      e.preventDefault();
      if(undoGlobalChange()){
        setDirty(true);
        render();
      }
    }else if(key === "y" || (key === "z" && e.shiftKey)){
      e.preventDefault();
      if(redoGlobalChange()){
        setDirty(true);
        render();
      }
    }
  });
  const modal = document.getElementById("config-modal");
  const openConfig = document.getElementById("open-config");
  const closeConfig = document.getElementById("close-config");
  const closeModal = () => {
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("config-open");
  };
  const openModal = () => {
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("config-open");
  };
  const toggleModal = () => {
    if(modal.classList.contains("open")) closeModal();
    else openModal();
  };
  if(openConfig && modal){
    openConfig.addEventListener("click", toggleModal);
  }
  if(closeConfig && modal){
    closeConfig.addEventListener("click", closeModal);
  }
  if(modal){
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && modal.classList.contains("open")) closeModal();
    });
  }
  const annualToggle = document.getElementById("annual-summary-toggle");
  if(annualToggle){
    try{
      const stored = localStorage.getItem(ANNUAL_TOGGLE_KEY);
      if(stored === "0") annualToggle.open = false;
    }catch(_e){}
    annualToggle.addEventListener("toggle", () => {
      try{
        localStorage.setItem(ANNUAL_TOGGLE_KEY, annualToggle.open ? "1" : "0");
      }catch(_e){}
    });
  }
  const exportModal = document.getElementById("export-modal");
  const openExports = document.getElementById("open-exports");
  const closeExport = document.getElementById("close-export");
  const closeExportModal = () => {
    if(!exportModal) return;
    exportModal.classList.remove("open");
    exportModal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };
  const openExportModal = () => {
    if(!exportModal) return;
    exportModal.classList.add("open");
    exportModal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  };
  if(openExports && exportModal){
    openExports.addEventListener("click", () => {
      if(exportModal.classList.contains("open")) closeExportModal();
      else openExportModal();
    });
  }
  if(closeExport && exportModal){
    closeExport.addEventListener("click", closeExportModal);
  }
  if(exportModal){
    exportModal.addEventListener("click", (e) => {
      if(e.target === exportModal) closeExportModal();
    });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && exportModal.classList.contains("open")) closeExportModal();
    });
  }

  loadConfig();
  applyConfigFromHash();
  applyEmbeddedConfig();
  render();
  autoLoadNetlifyOnce();
  updateSaveStatus();
</script>
</body>
</html>
